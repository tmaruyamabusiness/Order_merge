# 手配発注マージシステム 仕様書（概要）

## 1. 目的
本システムは、手配・発注データの取り込み、マージ、受入管理、履歴管理を一元化し、紙運用からの脱却と業務効率化を実現するWebアプリケーションである。

主な狙いは以下のとおり。
- Excel/DB由来データの集約と可視化
- QRコード活用による受入記録の正確化
- 納期・進捗・保管場所（パレット）の見える化
- アーカイブ・履歴によるトレーサビリティ確保

---

## 2. システム構成

### 2.1 アーキテクチャ
- **バックエンド**: Flask + SQLAlchemy（単一アプリ構成）
- **フロントエンド**: HTML + JavaScript（単一ページUI）
- **DB**: SQLite（標準）／ODBC経由で外部DB連携
- **外部データ**: ネットワーク共有上のExcel（UNCパス）

### 2.2 主な構成要素
- `app.py`: ルーティング、業務ロジック、データ処理の中核
- `templates/index.html`: 画面UI（タブ式）
- `static/*.js`: 機能別フロント処理（QR、ガント、パレット、DB連携）
- `utils/`: Excel整形、QR生成、メール、納期処理などのユーティリティ
- `services/`: キャッシュ・CAD検索・Excel出力などのサービス層

---

## 3. 対象ユーザー
- 購買・調達担当
- 受入担当
- 現場管理者（進捗／納期確認）
- 管理者（運用保守、データ監査）

---

## 4. 主要機能

### 4.1 受注リスト管理
- 受注一覧の表示
- ステータス、客先、製番等での検索・絞り込み
- 受注詳細の編集（備考、配置情報等）

### 4.2 データ取り込み・マージ
- 製番指定での処理
- 自動検出・一括処理
- ODBC/Across DB からの直接処理（環境設定に依存）
- 発注日条件による抽出オプション

### 4.3 受入管理
- QRコード読取による受入
- 発注番号指定による受入
- 受入取消と履歴管理
- 受入ログ参照

### 4.4 可視化
- 納期ガントチャート表示
- 納期関連の一覧表示
- DB更新通知の表示

### 4.5 パレット・保管場所管理
- パレット番号単位での検索
- ラベル生成
- 保管階層（フロア）管理
- 統計表示

### 4.6 アーカイブ
- 受注データのアーカイブ／復帰
- 過去データ参照

### 4.7 画像・CAD連携
- 受注単位の画像アップロード／取得／削除
- 明細からCAD情報参照
- CADファイル起動補助API

### 4.8 出力・通知
- 注文データのExcel出力
- 製番単位の出力
- 完了時メール送信

---

## 5. 画面仕様（タブ構成）
画面は1ページ内でタブ切替する。主なタブは以下。
- 受注リスト
- データ処理
- 入荷管理
- ユニット保管場所
- アーカイブ
- 発行履歴

補助表示として、DB更新通知バーとDB状態インジケータを持つ。

---

## 6. データモデル（主要）

### 6.1 `Order`
受注ヘッダ情報。
- 製番、ユニット、ステータス、保管場所、備考
- 品名・客先略称・メモ
- パレット番号、フロア
- 画像パス
- アーカイブ状態
- 作成／更新日時

### 6.2 `OrderDetail`
受注明細情報。
- 納期、仕入先、発注番号、数量、単位
- 品名、仕様、品目コード、区分
- 材質、必要数／員数
- 受入状態、受入日時
- 親子部品構造（`parent_id`）
- 図面関連情報（品番、ページ、行）
- 回答納期

### 6.3 `ReceivedHistory`
受入履歴の永続保存。
- キー相当情報: 発注番号 + 品名 + 仕様 + 数量
- 受入／取消状態
- 実行日時と実行者（IP）
- 監査用タイムスタンプ

---

## 7. API仕様（機能群）
> ここでは詳細I/F定義ではなく、機能単位のAPI群を示す。

### 7.1 マスタ・接続確認系
- 製番一覧取得
- ネットワークファイル存在確認
- DB接続状態確認
- システム状態確認

### 7.2 データ処理系
- 製番検出
- Excel/DB処理実行
- リフレッシュ処理
- 発行履歴読み込み／取込

### 7.3 受注管理系
- 受注一覧／詳細取得
- 受注情報更新
- 備考更新
- アーカイブ／復帰
- 削除（単体／複数）

### 7.4 受入系
- 明細受入トグル
- 受入実行
- 受入ログ取得
- 発注番号指定受入
- 受入統計

### 7.5 出力・周辺系
- 受注単位／製番単位のExcel出力
- ラベル生成
- 画像アップロード／取得／削除
- CAD情報参照／起動

---

## 8. 非機能要件（現実装ベース）

### 8.1 可用性
- DBセッションはリクエストごとにクリーンアップ
- コネクションプール設定を有効化

### 8.2 性能
- 大容量Excel対応（アップロード上限 50MB）
- キャッシュディレクトリ利用

### 8.3 セキュリティ
- `SECRET_KEY` によるセッション保護
- 本番でのHTTPS利用を想定
- 環境変数ベースの設定切替

### 8.4 運用性
- UNCパスで既存ファイルサーバ運用に追従
- DB取得不可時のExcelフォールバック（製番情報）

---

## 9. 設定仕様

### 9.1 環境別設定
- `development`: デバッグ有効、HTTPS（自己署名）対応
- `production`: デバッグ無効、環境変数主体、ODBC利用想定
- `testing`: テスト用DB・HTTPS無効

### 9.2 代表設定項目
- `SQLALCHEMY_DATABASE_URI`
- `UPLOAD_FOLDER`
- `MAX_CONTENT_LENGTH`
- `HISTORY_EXCEL_PATH`
- `SEIBAN_LIST_PATH`
- `EXPORT_EXCEL_PATH`
- `USE_ODBC` / `ODBC_CONNECTION_STRING`

---

## 10. 主要業務フロー

1. 製番指定または自動検出でデータ処理を実行
2. 受注一覧で対象案件を確認・絞り込み
3. 必要に応じて明細確認、備考更新、保管情報更新
4. 入荷時にQRまたは発注番号で受入登録
5. 必要に応じてラベル発行／Excel出力
6. 完了案件をアーカイブし、履歴を保持

---

## 11. 既知の前提・制約
- Windows系ネットワーク共有（UNC）に依存する設定がある
- ODBC連携・CAD連携は実行環境依存
- 画面/APIは業務要件に合わせて拡張されており、詳細I/Fは別途API定義書化が望ましい

---

## 12. 今後のドキュメント拡張案
- APIエンドポイントごとのI/O定義（JSONスキーマ）
- 権限設計（ロール定義）
- 障害時運用（リカバリ手順・監視項目）
- テスト仕様（単体・結合・UAT）

