<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手配発注マージシステム</title>
    <link rel="stylesheet" href="/static/styles.css">
    <!-- 🔥 Html5Qrcodeライブラリ（QRコード・バーコード両対応） -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- 🔥 Chart.js追加 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- 🔥 スクリプトを追加 -->
    <script src="/static/gantt-chart.js"></script>
    <script src="/static/qr-scanner.js"></script>
    <script src="/static/pallet-manager.js"></script>
    <script src="/static/delivery-schedule.js"></script>
    <script src="/static/across-db.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>手配発注マージシステム</h1>
            <p>Excel処理・入荷管理・ステータス追跡</p>
        </div>

        <!-- DB更新通知バー -->
        <div id="dbUpdateBar" style="display:none; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:10px 20px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 10px rgba(102,126,234,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="dbUpdateIcon" style="font-size:1.4em;">🔔</span>
                    <span id="dbUpdateMessage" style="font-weight:500;"></span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <span id="dbUpdateTime" style="font-size:0.85em; opacity:0.9;"></span>
                    <button onclick="toggleDbUpdateDetails()" class="btn btn-sm" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; padding:4px 12px;">
                        📋 詳細
                    </button>
                    <button onclick="checkDbUpdates()" class="btn btn-sm" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; padding:4px 12px;">
                        🔄 再チェック
                    </button>
                    <button onclick="dismissDbUpdate()" class="btn btn-sm" style="background:transparent; border:none; color:white; opacity:0.8; padding:4px 8px;">
                        ✕
                    </button>
                </div>
            </div>
            <!-- 詳細表示エリア -->
            <div id="dbUpdateDetails" style="display:none; margin-top:10px; background:rgba(255,255,255,0.15); border-radius:6px; padding:10px; max-height:300px; overflow-y:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.85em;">
                    <thead>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.3);">
                            <th style="text-align:left; padding:5px;">製番</th>
                            <th style="text-align:left; padding:5px;">品名</th>
                            <th style="text-align:left; padding:5px;">仕様１</th>
                            <th style="text-align:right; padding:5px;">数量</th>
                            <th style="text-align:left; padding:5px;">仕入先</th>
                            <th style="text-align:left; padding:5px;">納期</th>
                        </tr>
                    </thead>
                    <tbody id="dbUpdateDetailsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DB状態インジケーター（常時表示） -->
        <div id="dbStatusIndicator" style="display:flex; justify-content:flex-end; align-items:center; gap:15px; margin-bottom:10px; font-size:0.85em; color:#6c757d;">
            <div>
                <span>手配: </span><span id="dbTehaiCount">-</span>件
                <span style="margin-left:10px;">発注: </span><span id="dbHacchuCount">-</span>件
            </div>
            <div id="dbLastCheck">最終確認: -</div>
            <button onclick="checkDbUpdates()" class="btn btn-sm" style="padding:2px 10px; font-size:0.85em;" title="DB更新チェック">
                🔍 更新確認
            </button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('orders')">📋 受注リスト</button>
            <button class="nav-tab" onclick="switchTab('upload')">📤 データ処理</button>
            <button class="nav-tab" onclick="switchTab('receiving')">📦 入荷管理</button>
            <button class="nav-tab" onclick="switchTab('pallets')">🏢 ユニット保管場所</button>
            <button class="nav-tab" onclick="switchTab('archive')">🗄️ アーカイブ</button>
            <button class="nav-tab" onclick="switchTab('history')">📊 発行履歴</button>
        </div>
        
        <div class="content">
            <!-- 受注リストタブ -->
            <div id="orders-tab" class="tab-content active">
                <h2>受注リスト</h2>

                <!-- 🔥 ガントチャート追加 -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <h3 style="margin: 0;">📊 納期ガントチャート</h3>
                        <button class="btn btn-info btn-sm" onclick="toggleGanttChart()">
                            <span id="ganttToggleIcon">📈</span> <span id="ganttToggleText">表示</span>
                        </button>
                    </div>
                    
                    <!-- 🔥 製番フィルタUI -->
                    <div id="ganttFilterContainer" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <!-- ガントチャート設定 -->
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px; flex-wrap: wrap;">
                            <strong>⚙ 表示設定:</strong>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="margin: 0; font-size: 0.9em;">期間:</label>
                                <select id="ganttSpanSelect" onchange="applyGanttOptions()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    <option value="1">1ヶ月</option>
                                    <option value="3" selected>3ヶ月</option>
                                    <option value="6">6ヶ月</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="margin: 0; font-size: 0.9em;">今日の位置:</label>
                                <select id="ganttTodayPosition" onchange="onGanttPositionChange()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    <option value="center">中央（前後均等）</option>
                                    <option value="right">右端（過去メイン）</option>
                                    <option value="left">左端（未来メイン）</option>
                                    <option value="custom">日付指定</option>
                                </select>
                            </div>
                            <div id="ganttCustomDateContainer" style="display: none; align-items: center; gap: 5px;">
                                <label style="margin: 0; font-size: 0.9em;">開始日:</label>
                                <input type="date" id="ganttCustomStartDate" onchange="applyGanttOptions()" style="padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc;">
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="printGanttChart()" style="margin-left: auto; border: 1px solid #6c757d; background: white; padding: 4px 12px;">🖨 印刷</button>
                        </div>
                        <hr style="margin: 8px 0; border-color: #dee2e6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <strong>🔍 製番フィルタ:</strong>
                            <button class="btn btn-sm btn-primary" onclick="selectAllSeibansForGantt()">全て選択</button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAllSeibansForGantt()">全て解除</button>
                            <button class="btn btn-sm btn-success" onclick="applyGanttFilter()">フィルタ適用</button>
                            <span id="ganttFilterCount" style="color: #6c757d; margin-left: auto;"></span>
                        </div>
                        <div id="ganttSeibanList" style="max-height: 150px; overflow-y: auto; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 5px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px;">
                            <!-- 動的に生成 -->
                        </div>
                    </div>
                    
                    <!-- ガントチャート用ローディング表示 -->
                    <div id="ganttLoadingOverlay" style="display: none; background: rgba(255, 255, 255, 0.95); position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; border-radius: 10px;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                            <div id="ganttLoadingMessage" style="font-size: 1.2em; font-weight: bold; color: #667eea; margin-bottom: 15px;">
                                ガントチャートを読み込み中...
                            </div>
                            <div style="width: 80%; max-width: 400px; background: #e9ecef; border-radius: 20px; overflow: hidden; height: 30px; margin-bottom: 10px;">
                                <div id="ganttLoadingBar" style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                    <span id="ganttLoadingPercent" style="color: white; font-weight: bold; font-size: 0.9em;"></span>
                                </div>
                            </div>
                            <div id="ganttLoadingDetail" style="font-size: 0.9em; color: #6c757d; text-align: center;">
                                準備中...
                            </div>
                        </div>
                    </div>
                    
                    <div id="ganttChartContainer" style="display: none; position: relative; height: 400px; overflow-y: auto;">
                        <canvas id="ganttChart"></canvas>
                    </div>
                </div>
                                
                <div class="form-group">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="searchInput" placeholder="製番・ユニット名・客先名・ステータスで検索..." onkeyup="filterOrders()" style="flex:1; min-width:200px;">
                        <!-- ソート・グループ化オプション -->
                        <select id="sortOrder" onchange="loadOrders()" style="padding:6px 10px; border:1px solid #ced4da; border-radius:4px; font-size:0.9em;">
                            <option value="desc">製番 大→小</option>
                            <option value="asc">製番 小→大</option>
                        </select>
                        <label style="display:flex; align-items:center; gap:4px; font-size:0.85em; white-space:nowrap; cursor:pointer;">
                            <input type="checkbox" id="groupDerivatives" onchange="loadOrders()" checked style="width:16px; height:16px;">
                            枝番グループ化
                        </label>
                        <div class="view-toggle-bar" style="margin-bottom:0;">
                            <button class="btn btn-sm active" id="btnCardView" onclick="setViewMode('card')" title="カード表示">&#9638; カード</button>
                            <button class="btn btn-sm" id="btnTableView" onclick="setViewMode('table')" title="テーブル表示">&#9776; テーブル</button>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="deleteMultipleBtn" style="margin-top: 10px;">選択した製番を一括削除</button>
                </div>
                <div id="orderGrid" class="order-grid"></div>
            </div>

        
            <!-- データ処理タブ -->
            <div id="upload-tab" class="tab-content">
                    <!-- 発注日フィルタ追加 -->
                    <div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <label style="margin-bottom: 10px; display: block; cursor: pointer;">
                            <input type="checkbox" id="enableOrderDateFilter" onchange="toggleOrderDateFilter()" 
                                style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle; cursor: pointer;">
                            <strong style="vertical-align: middle; font-size: 1.1em;">📅 発注日でフィルタリング（期間指定）</strong>
                        </label>
                        <div id="orderDateFilterInput" style="display: none; margin-top: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1;">
                                    <label>開始日（この日付以降）:</label>
                                    <input type="date" id="orderDateFrom" style="width: 100%; padding: 8px;">
                                </div>
                                <div style="padding-top: 20px;">〜</div>
                                <div style="flex: 1;">
                                    <label>終了日（この日付まで）:</label>
                                    <input type="date" id="orderDateTo" style="width: 100%; padding: 8px;">
                                </div>
                            </div>
                            <small style="color: #856404; display: block; margin-top: 5px;">
                                💡 指定期間内に発注されたデータのみマージされます（終了日を空欄にすると開始日以降すべて）
                            </small>
                        </div>
                    </div>
                    <!-- 処理モード選択 -->
                    <div class="form-group">
                        <label>処理モード:</label>
                        <select id="processingMode" onchange="toggleProcessingMode()">
                            <option value="single">単一製番処理</option>
                            <option value="auto">自動検出・一括処理</option>
                        </select>
                    </div>
                    
                    <!-- 単一製番入力 -->
                    <div id="singleModeInput">
                        <div class="form-group">
                            <label>製番 (一覧から選択 または 手動入力):</label>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                                <input type="text" id="seibanFilterInput" placeholder="絞り込み（例: MHT0620）" oninput="filterSeibanCheckboxes()" style="flex: 1; padding: 6px 8px;">
                                <button class="btn btn-secondary" onclick="loadSeibanList()" style="white-space: nowrap; padding: 8px 12px;">一覧取得</button>
                            </div>
                            <div id="seibanCheckboxList" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 5px; margin-bottom: 6px; background: #fff;">
                            </div>
                            <div id="seibanBatchActions" style="display: none; margin-bottom: 8px;">
                                <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                    <button class="btn btn-sm btn-primary" onclick="selectAllSeibanCheckboxes()">全選択</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deselectAllSeibanCheckboxes()">全解除</button>
                                    <span id="seibanCheckCount" style="color: #666; font-size: 0.85em; margin-left: 5px;"></span>
                                    <button class="btn btn-success" onclick="processBatchSeibans()" style="margin-left: auto; padding: 6px 16px;">一括処理</button>
                                    <button class="btn btn-success" onclick="processBatchSeibansFromDB()" style="padding: 6px 16px; background: #7b1fa2;">🗄️ DB直接一括処理</button>
                                </div>
                            </div>
                            <input type="text" id="seibanInput" placeholder="MHT0123（手動入力も可）" style="margin-top: 4px;">
                            <small style="color: #666;">一覧からチェックして一括処理、または手動入力で単体処理</small>
                        </div>
                        <button class="btn btn-primary" onclick="processFile()">処理開始（手動入力）</button>
                        <button class="btn btn-primary" onclick="processFileFromDB()" style="margin-left: 8px; background: #7b1fa2;">🗄️ DB直接処理</button>
                        <div id="batchProgressContainer" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="margin-bottom: 8px;"><strong id="batchProgressTitle">一括処理中...</strong></div>
                            <div style="background: #e9ecef; border-radius: 10px; overflow: hidden; height: 24px; margin-bottom: 8px;">
                                <div id="batchProgressBar" style="height: 100%; background: linear-gradient(135deg, #28a745, #20c997); width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                    <span id="batchProgressPercent" style="color: white; font-weight: bold; font-size: 0.85em;"></span>
                                </div>
                            </div>
                            <div id="batchProgressLog" style="font-size: 0.85em; color: #555; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <!-- 自動検出モード -->
                    <div id="autoModeInput" style="display: none;">
                        <div class="form-group">
                            <label>最小製番 (この番号以降を処理):</label>
                            <input type="text" id="minSeibanInput" placeholder="MHT0600" value="MHT0600">
                        </div>
                        <button class="btn btn-primary" onclick="detectAndProcess()">製番を検出</button>
                        
                        <div id="detectedSeibans" style="margin-top: 20px; display: none;">
                            <h4>検出された製番</h4>
                            <div id="seibanList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-success" onclick="processSelectedSeibans()">選択した製番を処理</button>
                                <button class="btn btn-primary" onclick="selectAllSeibans()">全て選択</button>
                                <button class="btn btn-secondary" onclick="deselectAllSeibans()">全て解除</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 処理進捗 -->
                    <div id="batchProgress" style="display: none; margin-top: 20px;">
                        <h4>処理進捗</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="batchProgressBar" style="width: 0%"></div>
                        </div>
                        <p id="batchProgressText">0 / 0 完了</p>
                        <div id="batchResults" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                        </div>
                    </div>

                    <!-- シート選択 -->
                    <div class="form-group">
                        <label>手配リストのシート:</label>
                        <select id="sheet1Select"></select>
                    </div>
                    <div class="form-group">
                        <label>発注リストのシート:</label>
                        <select id="sheet2Select"></select>
                    </div>

                    <div id="sheetSelection" style="display: none;">
                        <h3>シート選択</h3>

                    </div>

                    <div class="loading" id="loadingIndicator">
                        <div class="spinner"></div>
                        <p>処理中...</p>
                    </div>

                    <!-- Across DB テストセクション -->
                    <div class="upload-section" style="background: #f3e5f5; border: 2px solid #ce93d8;">
                        <h2>🗄️ Across DB テスト</h2>
                        <p style="color: #666; font-size: 0.9em;">V_D系ビュー（読み取り専用）に直接クエリを実行します</p>

                        <!-- 接続テスト -->
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-info" onclick="testAcrossConnection()">接続テスト</button>
                            <span id="acrossTestResult" style="margin-left: 10px;"></span>
                        </div>

                        <!-- クイック発注番号検索 -->
                        <div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <h3 style="margin-top:0; font-size:1em;">🔍 発注番号クイック検索</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="acrossQuickOrderInput" placeholder="発注番号（例: 89074）" style="flex:1; padding:8px;">
                                <button class="btn btn-primary" onclick="quickSearchOrder()">検索</button>
                            </div>
                            <small style="color:#888;">自動で8桁ゼロパディングされます</small>
                            <div id="acrossQuickResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- マージテスト -->
                        <div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <h3 style="margin-top:0; font-size:1em;">🔄 製番マージテスト</h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">V_D手配リスト × V_D発注 をマージし、現行Excel処理と同等の結果を生成</p>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="acrossMergeSeiban" placeholder="製番（例: MHT0620）" style="flex:1; padding:8px;">
                                <button class="btn btn-primary" onclick="executeMergeTest()">マージテスト実行</button>
                            </div>
                            <div id="acrossMergeResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- DB更新チェック -->
                        <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                            <h3 style="margin-top:0; font-size:1em;">
                                📊 DB更新チェック
                                <span id="mihatchuBadge" style="display:none; background:#e91e63; color:#fff; font-size:0.75em; padding:2px 8px; border-radius:10px; margin-left:8px;"></span>
                            </h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">登録済み製番の手配リスト・発注・未発注（社内加工品）件数を確認</p>
                            <button class="btn btn-warning" onclick="checkDbUpdates()">更新チェック実行</button>
                            <div id="dbUpdateCheckResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- 社内加工品 未発注検索 -->
                        <div style="background: #fce4ec; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #e91e63;">
                            <h3 style="margin-top:0; font-size:1em;">🏭 社内加工品 未発注検索</h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">V_D未発注から仕入先CD='MHT' + 手配区分CD='11' を検索（発注書なしで処理される社内加工品）</p>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="acrossMihatchuSeiban" placeholder="製番（例: MHT0620）" style="flex:1; padding:8px;">
                                <button class="btn" style="background:#e91e63; color:#fff;" onclick="searchMihatchu()">未発注検索</button>
                            </div>
                            <div id="acrossMihatchuResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- 在庫部品検索 (手配区分CD=15) -->
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                            <h3 style="margin-top:0; font-size:1em;">📦 在庫部品リスト</h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">手配区分CD='15'（在庫部品）を抽出 - 在庫から集めて仕分けが必要な部品</p>
                            <button class="btn" style="background:#2196f3; color:#fff;" onclick="searchZaikoBuhin()">在庫部品を検索</button>
                            <div id="zaikoBuhinResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- 0ZAIKO 手配リスト -->
                        <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                            <h3 style="margin-top:0; font-size:1em;">🏷️ 0ZAIKO 在庫発注リスト</h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">製番='0ZAIKO'（在庫品発注用）の手配リストを表示 - 在庫補充用の発注データ</p>
                            <button class="btn" style="background:#ff9800; color:#fff;" onclick="search0ZaikoTehai()">0ZAIKO手配を検索</button>
                            <div id="zaikoTehaiResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- ビュー自由検索 -->
                        <div style="background: #fff; padding: 12px; border-radius: 6px;">
                            <h3 style="margin-top:0; font-size:1em;">📋 ビュー自由検索</h3>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                <select id="acrossViewSelect" onchange="onAcrossViewChange()" style="padding: 8px;">
                                    <option value="V_D発注">V_D発注（発注データ）</option>
                                    <option value="V_D発注残">V_D発注残（発注残・納入状況）</option>
                                    <option value="V_D手配リスト">V_D手配リスト（BOM）</option>
                                    <option value="V_D仕入">V_D仕入（仕入実績）</option>
                                    <option value="V_D未発注">V_D未発注（社内加工品含む）</option>
                                </select>
                                <select id="acrossSearchType" style="padding: 8px;">
                                    <option value="発注番号">発注番号</option>
                                    <option value="製番">製番</option>
                                    <option value="">全件（上位N件）</option>
                                </select>
                                <input type="text" id="acrossSearchInput" placeholder="例: 89074 または MHT0620" style="flex:1; min-width:150px; padding:8px;">
                                <select id="acrossLimit" style="padding: 8px; width: 100px;">
                                    <option value="20">20件</option>
                                    <option value="50">50件</option>
                                    <option value="100" selected>100件</option>
                                    <option value="500">500件</option>
                                </select>
                                <button class="btn btn-success" onclick="executeAcrossQuery()">クエリ実行</button>
                            </div>
                            <div id="acrossColumns" style="margin-bottom: 8px;"></div>
                            <div id="acrossQueryResult"></div>
                        </div>
                    </div>

                    <!-- 手動アップロードセクション -->
                    <div class="upload-section">
                        <h2>📤 手動ファイルアップロード</h2>
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <div id="uploadText">
                                <p style="font-size: 3em;">📁</p>
                                <p>クリックまたはドラッグ＆ドロップでファイルを選択</p>
                                <p style="color: #6c757d; font-size: 0.9em;">対応形式: .xlsx, .xls (最大50MB)</p>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>

            </div>

            <!-- 入荷管理タブ -->
            <div id="receiving-tab" class="tab-content">
                <h2>📦 入荷管理</h2>

                <!-- 納品予定表（発注DB直接取得） -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: white; border: 2px solid #28a745; border-radius: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                        <h3 style="margin: 0;">📅 納品予定 <span style="font-size: 0.7em; background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-weight: normal;">発注DB</span></h3>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <label style="font-size: 0.85em; color: #666; margin: 0;">開始日:</label>
                            <input type="date" id="dbDeliveryStartDate" style="padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.85em;">
                            <button class="btn btn-sm" onclick="resetDbDeliveryDate()" style="padding: 3px 10px; border: 1px solid #ced4da; background: #f8f9fa; font-size: 0.82em; border-radius: 4px; cursor: pointer;" title="今日に戻す">今日</button>
                            <button class="btn btn-sm btn-success" onclick="loadDbDeliverySchedule()">🔄 DB読込</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="printDbDeliverySchedule()" style="border: 1px solid #6c757d; background: white;">🖨 印刷</button>
                        </div>
                    </div>
                    <div id="dbDeliveryScheduleContent">
                        <p style="text-align: center; padding: 20px; color: #6c757d;">「DB読込」ボタンを押して発注DBから納品予定を読み込みます</p>
                    </div>
                </div>

                <!-- 納品予定表（ローカル） -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: white; border: 1px solid #dee2e6; border-radius: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                        <h3 style="margin: 0;">📅 納品予定 <span style="font-size: 0.7em; color: #6c757d; font-weight: normal;">(ローカル)</span></h3>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <label style="font-size: 0.85em; color: #666; margin: 0;">開始日:</label>
                            <input type="date" id="deliveryStartDate" style="padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.85em;" onchange="loadDeliverySchedule()">
                            <button class="btn btn-sm" onclick="resetDeliveryStartDate()" style="padding: 3px 10px; border: 1px solid #ced4da; background: #f8f9fa; font-size: 0.82em; border-radius: 4px; cursor: pointer;" title="今日に戻す">今日</button>
                            <button class="btn btn-sm btn-primary" onclick="loadDeliverySchedule()">更新</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="printDeliverySchedule()" style="border: 1px solid #6c757d; background: white;">🖨 印刷</button>
                        </div>
                    </div>
                    <div id="deliveryScheduleContent">
                        <p style="text-align: center; padding: 20px; color: #6c757d;">「更新」ボタンを押して納品予定を読み込みます</p>
                    </div>
                </div>

                <!-- 更新情報（備考・画像があるユニット一覧） -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: white; border: 1px solid #dee2e6; border-radius: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <h3 style="margin: 0;">ℹ️ 更新情報</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="updateInfoCount" style="font-size: 0.85em; color: #666;"></span>
                            <button class="btn btn-sm btn-primary" onclick="loadUpdateInfo()">更新</button>
                        </div>
                    </div>
                    <div id="updateInfoContent">
                        <p style="text-align: center; padding: 15px; color: #6c757d; font-size: 0.9em;">「更新」ボタンで備考・画像のあるユニットを表示</p>
                    </div>
                </div>

                <!-- 発注番号での検索・受入 -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>🔍 発注番号で検索・受入</h3>
                    <div class="form-group">
                        <label>発注番号を入力（QRコードスキャンも可能）:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="purchaseOrderInput" placeholder="例: 85858 または QRスキャン後Enter" style="flex: 1;">
                            <button class="btn btn-primary" onclick="searchByPurchaseOrder()">検索</button>
                            <button class="btn btn-success" onclick="receiveByPurchaseOrder()"title="検索結果の内容を受入">検索結果受入</button>
                            <button class="btn btn-warning" onclick="startQRScanner()" title="カメラでQRコード読取">📷 QRスキャン</button>
                        </div>
                        <small style="color: #6c757d; display: block; margin-top: 5px;">
                            💡 QRコードリーダーでスキャンした後、Enterキーを押すと自動的に処理されます
                        </small>
                    </div>
                    <div id="purchaseOrderSearchResult"></div>
                </div>

                <!-- QRコード・バーコードスキャナーモーダル -->
                <div id="qrScannerModal" class="modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2>📷 QR/バーコードスキャン</h2>
                            <button onclick="stopQRScanner()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">×</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 15px;">
                            <!-- スキャン範囲切替 -->
                            <div style="display:flex; justify-content:center; gap:6px; margin-bottom:10px;">
                                <button class="btn btn-sm" id="scanModeWide" onclick="setScanMode('wide')" style="background:#0d6efd;color:#fff;padding:4px 10px;font-size:0.85em;">広域</button>
                                <button class="btn btn-sm" id="scanModeNarrow" onclick="setScanMode('narrow')" style="padding:4px 10px;font-size:0.85em;">ピンポイント</button>
                                <button class="btn btn-sm" id="scanModeBarcode" onclick="setScanMode('barcode')" style="padding:4px 10px;font-size:0.85em;">バーコード</button>
                            </div>
                            <!-- Html5Qrcode用のコンテナ -->
                            <div id="qr-reader" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
                            <div id="qrResult" style="margin-top: 10px; font-size: 1em; min-height: 30px;"></div>
                            <!-- スキャンログ（連続スキャン結果） -->
                            <div id="scanLog" style="margin-top: 8px; max-height: 150px; overflow-y: auto; text-align: left; background: #f8f9fa; border-radius: 6px;"></div>
                            <p style="margin-top: 8px; color: #6c757d; font-size: 0.85em;">
                                連続スキャン対応 - 読み取るだけで自動受入<br>
                                <small>QRが近接している場合は「ピンポイント」に切替</small>
                            </p>
                            <button class="btn btn-danger" onclick="stopQRScanner()" style="margin-top: 10px;">
                                スキャン終了
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 🔥 バーコード受入確認モーダル -->
                <div id="barcodeReceiveModal" class="modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header" style="background: #28a745;">
                            <h2>📦 受入確認</h2>
                            <button onclick="closeBarcodeReceiveModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">×</button>
                        </div>
                        <div class="modal-body" id="barcodeReceiveModalBody" style="padding: 20px;">
                            <!-- 動的に生成 -->
                        </div>
                    </div>
                </div>

                <!-- 仕様１での検索 -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: #e8f4ff; border-radius: 10px;">
                    <h3>🔍 仕様１（型番）で検索</h3>
                    <div class="form-group">
                        <label>仕様１を入力:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="spec1Input" placeholder="例: MVBLK-SSM-3RP-GDKZG" style="flex: 1;">
                            <button class="btn btn-primary" onclick="searchBySpec1()">検索</button>
                        </div>
                    </div>
                    <div id="spec1SearchResult"></div>
                </div>
                
                <!-- 発注番号統計 -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: #e8f4f8; border-radius: 10px;">
                    <h3>📊 発注番号別進捗</h3>
                    <button class="btn btn-primary" onclick="loadPurchaseOrderStats()">統計を更新</button>
                    <div id="purchaseOrderStats" style="margin-top: 20px;"></div>
                </div>
                
                <!-- 既存の受入リスト -->
                <div class="card" style="padding: 20px; background: white; border: 1px solid #dee2e6; border-radius: 10px;">
                    <h3>📋 製番別受入リスト</h3>
                    <div id="receivingList"></div>
                </div>
            </div>

            <script>

            // HTMLエスケープ（XSS防止）
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let detectedSeibansList = [];

            function toggleProcessingMode() {
                const mode = document.getElementById('processingMode').value;
                
                if (mode === 'single') {
                    document.getElementById('singleModeInput').style.display = 'block';
                    document.getElementById('autoModeInput').style.display = 'none';
                    document.getElementById('detectedSeibans').style.display = 'none';
                } else {
                    document.getElementById('singleModeInput').style.display = 'none';
                    document.getElementById('autoModeInput').style.display = 'block';
                }
            }

            async function detectAndProcess() {
                const sheet1 = document.getElementById('sheet1Select').value;
                const minSeiban = document.getElementById('minSeibanInput').value || 'MHT0600';
                
                document.getElementById('loadingIndicator').style.display = 'block';
                
                try {
                    const response = await fetch('/api/detect-seibans', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filepath: currentFilePath,
                            sheet_name: sheet1,
                            min_seiban: minSeiban
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        detectedSeibansList = data.seibans;
                        displayDetectedSeibans(data.seibans);
                        showToast(`${data.count}件の製番を検出しました`, 'success');
                    } else {
                        showToast('エラー: ' + data.error, 'error');
                    }
                } catch (error) {
                    showToast('検出エラー: ' + error, 'error');
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            function displayDetectedSeibans(seibans) {
                const listDiv = document.getElementById('seibanList');
                listDiv.innerHTML = '';
                
                seibans.forEach(seiban => {
                    const checkbox = document.createElement('div');
                    checkbox.style.marginBottom = '5px';
                    checkbox.innerHTML = `
                        <label style="cursor: pointer;">
                            <input type="checkbox" class="seiban-checkbox" value="${seiban}" checked>
                            <strong>${seiban}</strong>
                        </label>
                    `;
                    listDiv.appendChild(checkbox);
                });
                
                document.getElementById('detectedSeibans').style.display = 'block';
            }

            function selectAllSeibans() {
                document.querySelectorAll('.seiban-checkbox').forEach(cb => cb.checked = true);
            }

            function deselectAllSeibans() {
                document.querySelectorAll('.seiban-checkbox').forEach(cb => cb.checked = false);
            }

            async function processSelectedSeibans() {
                const selectedSeibans = Array.from(document.querySelectorAll('.seiban-checkbox:checked'))
                    .map(cb => cb.value);
                
                if (selectedSeibans.length === 0) {
                    showToast('製番を選択してください', 'warning');
                    return;
                }
                
                if (!confirm(`${selectedSeibans.length}件の製番を処理します。よろしいですか？`)) {
                    return;
                }
                
                const sheet1 = document.getElementById('sheet1Select').value;
                const sheet2 = document.getElementById('sheet2Select').value;
                
                // 進捗表示を初期化
                const progressDiv = document.getElementById('batchProgress');
                const progressBar = document.getElementById('batchProgressBar');
                const progressText = document.getElementById('batchProgressText');
                const resultsDiv = document.getElementById('batchResults');
                
                progressDiv.style.display = 'block';
                resultsDiv.innerHTML = '';
                
                let completed = 0;
                
                for (const seiban of selectedSeibans) {
                    try {
                        const response = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filepath: currentFilePath,
                                sheet1: sheet1,
                                sheet2: sheet2,
                                seiban: seiban
                            })
                        });
                        
                        const data = await response.json();
                        
                        completed++;
                        const progress = (completed / selectedSeibans.length * 100);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${completed} / ${selectedSeibans.length} 完了`;
                        
                        if (data.success) {
                            resultsDiv.innerHTML += `<div style="color: green;">✅ ${seiban}: 処理完了</div>`;
                        } else {
                            resultsDiv.innerHTML += `<div style="color: red;">❌ ${seiban}: ${data.error}</div>`;
                        }
                    } catch (error) {
                        resultsDiv.innerHTML += `<div style="color: red;">❌ ${seiban}: ${error}</div>`;
                    }
                }
                
                showToast(`一括処理完了: ${completed}件`, 'success');
                loadOrders();
                
                // フォームをリセット
                setTimeout(() => {
                    document.getElementById('sheetSelection').style.display = 'none';
                    document.getElementById('uploadText').innerHTML = `
                        <p style="font-size: 3em;">📁</p>
                        <p>クリックまたはドラッグ&ドロップでファイルを選択</p>
                        <p style="color: #6c757d; font-size: 0.9em;">対応形式: .xlsx, .xls (最大50MB)</p>
                    `;
                }, 3000);
            }
            
            // 更新情報（備考・画像があるユニット一覧）を読み込み
            async function loadUpdateInfo() {
                const container = document.getElementById('updateInfoContent');
                const countEl = document.getElementById('updateInfoCount');
                if (!container) return;

                container.innerHTML = '<p style="text-align: center; padding: 15px; color: #6c757d;">読み込み中...</p>';

                try {
                    const response = await fetch('/api/orders/update-info');
                    const data = await response.json();

                    if (!data.success) {
                        container.innerHTML = `<p style="color: #dc3545;">エラー: ${data.error}</p>`;
                        return;
                    }

                    if (data.orders.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 15px; color: #6c757d;">備考・画像が設定されたユニットはありません</p>';
                        if (countEl) countEl.textContent = '';
                        return;
                    }

                    if (countEl) countEl.textContent = `${data.total}件`;

                    // 製番でグループ化
                    const grouped = {};
                    data.orders.forEach(order => {
                        if (!grouped[order.seiban]) grouped[order.seiban] = [];
                        grouped[order.seiban].push(order);
                    });

                    let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

                    Object.keys(grouped).sort().forEach(seiban => {
                        html += `<div style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">`;
                        html += `<div style="padding: 8px 12px; background: #f1f3f5; font-weight: bold; font-size: 0.95em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                            ${seiban} <span style="color: #666; font-weight: normal; font-size: 0.85em;">(${grouped[seiban].length}件)</span>
                        </div>`;
                        html += `<div>`;

                        grouped[seiban].forEach(order => {
                            const statusColor = order.status === '納品完了' ? '#28a745' : order.status === '納品中' ? '#ffc107' : '#6c757d';
                            html += `<div style="padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="showOrderDetails(${order.order_id})">`;
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">`;
                            html += `<strong style="font-size: 0.95em;">${order.unit || '(ユニット未設定)'}</strong>`;
                            html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                            html += `<span style="background: ${statusColor}; color: ${order.status === '納品中' ? '#333' : '#fff'}; padding: 1px 8px; border-radius: 10px; font-size: 0.75em;">${order.status || '未設定'}</span>`;
                            if (order.has_image) html += `<span style="font-size: 0.85em;">📷</span>`;
                            html += `<span style="color: #999; font-size: 0.75em;">${order.updated_at}</span>`;
                            html += `</div></div>`;

                            if (order.remarks) {
                                html += `<div style="font-size: 0.85em; color: #555; background: #fffbea; padding: 5px 8px; border-radius: 4px; border-left: 3px solid #ffc107; margin-top: 4px; white-space: pre-wrap; word-break: break-word;">${escapeHtml(order.remarks)}</div>`;
                            }

                            if (order.has_image) {
                                html += `<div style="margin-top: 6px;"><img src="${order.image_url}" alt="画像" style="max-width: 200px; max-height: 120px; border-radius: 4px; border: 1px solid #dee2e6; cursor: pointer;" onclick="event.stopPropagation(); window.open('${order.image_url}', '_blank')"></div>`;
                            }

                            // 場所・パレット情報
                            if (order.location !== '未設定' || order.pallet_number !== '未設定') {
                                html += `<div style="font-size: 0.78em; color: #888; margin-top: 3px;">`;
                                if (order.location !== '未設定') html += `場所: ${order.location} `;
                                if (order.pallet_number !== '未設定') html += `棚: ${order.pallet_number}`;
                                html += `</div>`;
                            }

                            html += `</div>`;
                        });

                        html += `</div></div>`;
                    });

                    html += '</div>';
                    container.innerHTML = html;

                } catch (error) {
                    container.innerHTML = `<p style="color: #dc3545;">読み込みエラー: ${error}</p>`;
                }
            }

            // 発注番号で検索
            async function searchByPurchaseOrder() {
                const purchaseOrderNumber = document.getElementById('purchaseOrderInput').value.trim();
                
                if (!purchaseOrderNumber) {
                    showToast('発注番号を入力してください', 'warning');
                    return;
                }
                
                // 浮動小数点形式を整数形式に変換
                let searchNumber = purchaseOrderNumber;
                if (searchNumber.includes('.0')) {
                    searchNumber = searchNumber.replace('.0', '');
                }
                
                // 🔥 ゼロパディングを削除
                searchNumber = String(parseInt(searchNumber));
                
                try {
                    // 🔥 検索開始トースト
                    showToast('1.マージされたデータから検索中...', 'info', 2000);
                    
                    const response = await fetch(`/api/search-by-purchase-order/${searchNumber}`);
                    const data = await response.json();

                    if (data.cache_needs_loading) {
                        showToast('2.マージされたデータの中から発注番号を見つけられませんでした。発注リストデータベースより検索します（時間がかかります）', 'warning', 5000);
                       await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    const resultDiv = document.getElementById('purchaseOrderSearchResult');
                    
                    if (data.found) {

                        // 未マージデータの警告
                        let warningHtml = '';
                        if (data.has_unmerged) {
                            warningHtml = `
                                <div class="alert alert-warning" style="margin-bottom: 10px;">
                                    ⚠️ 未マージデータが含まれています（発注_ALLシートから取得）<br>
                                    <small>※これらのデータは受入処理できません。マージ処理を実行してください。</small>
                                </div>
                            `;
                        }
                        
                        let html = `
                            ${warningHtml}
                            <div class="alert alert-success">
                                <h4>検索結果: ${data.count}件</h4>
                                <div class="table-wrapper" style="overflow-x: auto; margin-top: 10px;">
                                    <table class="detail-table search-result-table" style="width: 100%; min-width: 900px;">
                                        <thead>
                                            <tr>
                                                <th>ソース</th>
                                                <th>発注番号</th>
                                                <th>製番</th>
                                                <th>ユニット</th>
                                                <th>品名</th>
                                                <th>仕様１</th>
                                                <th>数量</th>
                                                <th>納期</th>
                                                <th>回答納期</th>
                                                <th>仕入先</th>
                                                <th>発注者</th>
                                                <th>受入状態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        data.details.forEach(detail => {
                            const sourceLabel = detail.source === 'merged' ? 
                                '<span style="color: green;">✅ マージ済</span>' : 
                                '<span style="color: orange;">⚠️ 未マージ</span>';
                            
                            const actionButton = detail.order_id ? 
                                `<button class="btn btn-sm btn-primary" onclick="showOrderDetails(${detail.order_id})">ユニット詳細</button>` : 
                                '<span style="color: #6c757d;">⚠️受入には要マージ</span>';
                            
                            html += `
                                <tr class="${detail.is_received ? 'received' : ''}">
                                    <td>${sourceLabel}</td>
                                    <td><strong>${searchNumber}</strong></td>
                                    <td>${detail.seiban}</td>
                                    <td>${detail.unit || '-'}</td>
                                    <td title="${detail.item_name}">${detail.item_name}</td>
                                    <td title="${detail.spec1 || '-'}">${detail.spec1 || '-'}</td>
                                    <td>${detail.quantity} ${detail.unit_measure || ''}</td>
                                    <td>${detail.delivery_date || '-'}</td>
                                    <td style="color: ${detail.reply_delivery_date ? '#d32f2f' : '#ccc'};">${detail.reply_delivery_date || '-'}</td>
                                    <td>${detail.supplier || '-'}</td>
                                    <td>${detail.staff || '-'}</td>
                                    <td>
                                        ${detail.is_received ? 
                                            '<span style="color: green;">✅ 受入済</span>' : 
                                            '<span style="color: orange;">🟨 未受入</span>'}
                                    </td>
                                    <td>${actionButton}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        resultDiv.innerHTML = html;
                        showToast(`✅ 検索完了: ${data.count}件見つかりました`, 'success');
                        
                    } else {
                        // 🔥 見つからない場合のメッセージ
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>発注番号 ${purchaseOrderNumber} が見つかりません</strong><br>
                                <small>
                                ・マージ済みデータベース: 検索済み<br>
                                ・発注_ALLシート: 検索済み<br>
                                ※発注番号を再確認してください
                                </small>
                            </div>
                        `;
                        showToast(`❌ 発注番号 ${purchaseOrderNumber} が見つかりません`, 'error');
                    }
                } catch (error) {
                    showToast('検索エラー: ' + error, 'error');
                }
            }

            // 仕様１で検索
            async function searchBySpec1() {
                const spec1 = document.getElementById('spec1Input').value.trim();
                
                if (!spec1) {
                    showToast('仕様１を入力してください', 'warning');
                    return;
                }
                
                try {
                    // 🔥 1段階目：マージ済みデータのみ検索
                    showToast('1.マージされたデータから検索中...', 'info', 2000);
                    
                    const response = await fetch(`/api/search-by-spec1/${encodeURIComponent(spec1)}`);
                    const data = await response.json();
                    
                    // 🔥 キャッシュ読み込みが必要な場合は先にトースト表示
                    if (data.cache_needs_loading) {
                        showToast('2.マージされたデータの中から仕様１を見つけられませんでした。発注リストデータベースより検索します（時間がかかります）', 'warning', 5000);
                        
                        // 🔥 少し待機してから結果を表示（読み込み時間を体感させる）
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    const resultDiv = document.getElementById('spec1SearchResult');
                    
                    if (data.found) {
                        // 🔥 未マージデータがある場合のトースト
                        if (data.has_unmerged) {
                            showToast('2.マージされたデータの中から仕様１を見つけられませんでした。発注リストデータベースより検索します（時間がかかります）', 'warning', 5000);
                        }
                        
                        // 🔥 未マージデータの警告
                        let warningHtml = '';
                        if (data.has_unmerged) {
                            warningHtml = `
                                <div class="alert alert-warning" style="margin-bottom: 10px;">
                                    ⚠️ 未マージデータが含まれています（発注_ALLシートから取得）<br>
                                    <small>※これらのデータは受入処理できません。マージ処理を実行してください。</small>
                                </div>
                            `;
                        }
                        
                        let html = `
                            ${warningHtml}
                            <div class="alert alert-success">
                                <h4>検索結果: ${data.count}件</h4>
                                <div class="table-wrapper" style="overflow-x: auto; margin-top: 10px;">
                                    <table class="detail-table search-result-table" style="width: 100%; min-width: 900px;">
                                        <thead>
                                            <tr>
                                                <th>ソース</th>
                                                <th>発注番号</th>
                                                <th>製番</th>
                                                <th>ユニット</th>
                                                <th>品名</th>
                                                <th>仕様１</th>
                                                <th>数量</th>
                                                <th>納期</th>
                                                <th>回答納期</th>
                                                <th>仕入先</th>
                                                <th>発注者</th>
                                                <th>受入状態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        data.details.forEach(detail => {
                            const sourceLabel = detail.source === 'merged' ? 
                                '<span style="color: green;">✅ マージ済</span>' : 
                                '<span style="color: orange;">⚠️ 未マージ</span>';
                            
                            const actionButton = detail.order_id ? 
                                `<button class="btn btn-sm btn-primary" onclick="showOrderDetails(${detail.order_id})">詳細</button>` : 
                                '<span style="color: #6c757d;">マージ処理が必要</span>';
                            
                            html += `
                                <tr class="${detail.is_received ? 'received' : ''}">
                                    <td>${sourceLabel}</td>
                                    <td>${detail.order_number || '-'}</td>
                                    <td>${detail.seiban}</td>
                                    <td>${detail.unit || '-'}</td>
                                    <td title="${detail.item_name}">${detail.item_name}</td>
                                    <td title="${detail.spec1 || '-'}">
                                        ${highlightSearchTerm(detail.spec1 || '-', spec1)}
                                    </td>
                                    <td>${detail.quantity} ${detail.unit_measure || ''}</td>
                                    <td>${detail.delivery_date || '-'}</td>
                                    <td style="color: ${detail.reply_delivery_date ? '#d32f2f' : '#ccc'};">${detail.reply_delivery_date || '-'}</td>
                                    <td>${detail.supplier || '-'}</td>
                                    <td>${detail.staff || '-'}</td>
                                    <td>
                                        ${detail.is_received ? 
                                            '<span style="color: green;">✅ 受入済</span>' : 
                                            '<span style="color: orange;">🟨 未受入</span>'}
                                    </td>
                                    <td>${actionButton}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        resultDiv.innerHTML = html;
                        showToast(`✅ 検索完了: ${data.count}件見つかりました`, 'success');
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>仕様１ "${spec1}" が見つかりません</strong><br>
                                <small>
                                ・マージ済みデータベース: 検索済み<br>
                                ・発注_ALLシート: 検索済み<br>
                                ※仕様１を再確認してください
                                </small>
                            </div>
                        `;
                        showToast(`❌ 仕様１ "${spec1}" が見つかりません`, 'error');
                    }
                } catch (error) {
                    showToast('検索エラー: ' + error, 'error');
                }
            }
            
            // 🔥 検索ワードをハイライトする補助関数
            function highlightSearchTerm(text, searchTerm) {
                if (!text || !searchTerm) return text;
                
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                return text.replace(regex, '<span style="background-color: yellow; font-weight: bold;">$1</span>');
            }
            // 発注番号で一括受入
            async function receiveByPurchaseOrder() {
                const purchaseOrderNumber = document.getElementById('purchaseOrderInput').value.trim();
                
                if (!purchaseOrderNumber) {
                    showToast('発注番号を入力してください', 'warning');
                    return;
                }
                
                // 浮動小数点形式を整数形式に変換
                let searchNumber = purchaseOrderNumber;
                if (searchNumber.includes('.0')) {
                    searchNumber = searchNumber.replace('.0', '');
                }
                
                if (!confirm(`発注番号 ${searchNumber} のアイテムを一括受入しますか？`)) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/receive-by-purchase-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            purchase_order_number: searchNumber
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast(data.message, data.has_internal_processing ? 'warning' : 'success');
                        
                        // 画面を更新
                        searchByPurchaseOrder();
                        loadOrders();
                        loadPurchaseOrderStats();
                    } else {
                        showToast('エラー: ' + data.error, 'error');
                    }
                } catch (error) {
                    showToast('受入エラー: ' + error, 'error');
                }
            }

            // 発注番号統計を読み込み
            async function loadPurchaseOrderStats() {
                try {
                    const response = await fetch('/api/purchase-order-stats');
                    const data = await response.json();
                    
                    const statsDiv = document.getElementById('purchaseOrderStats');
                    
                if (data.stats && data.stats.length > 0) {
                    let html = `
                        <p>総発注数: ${data.total_orders}件</p>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="detail-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>発注番号</th>
                                        <th>品名</th>
                                        <th>仕様1</th>
                                        <th>アイテム数</th>
                                        <th>総数量</th>
                                        <th>受入済</th>
                                        <th>完了率</th>
                                        <th>アクション</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    data.stats.forEach(stat => {
                        const statusColor = stat.completion_rate === 100 ? 'green' : 
                                        stat.completion_rate > 0 ? 'orange' : 'red';
                        
                        let displayNumber = stat.purchase_order_number;
                        if (displayNumber && displayNumber.includes('.0')) {
                            displayNumber = displayNumber.replace('.0', '');
                        }
                        
                        html += `
                            <tr>
                                <td><strong>${displayNumber}</strong></td>
                                <td title="${stat.item_name}">${stat.item_name.length > 15 ? stat.item_name.substring(0, 15) + '...' : stat.item_name}</td>
                                <td title="${stat.spec1}">${stat.spec1.length > 15 ? stat.spec1.substring(0, 15) + '...' : stat.spec1}</td>
                                <td>${stat.total_items}</td>
                                <td>${stat.total_quantity}</td>
                                <td>${stat.received_items}</td>
                                <td>
                                    <div class="progress-bar" style="width: 100px; display: inline-block;">
                                        <div class="progress-fill" style="width: ${stat.completion_rate}%; background: ${statusColor};"></div>
                                    </div>
                                    ${stat.completion_rate}%
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" 
                                        onclick="document.getElementById('purchaseOrderInput').value='${displayNumber}'; searchByPurchaseOrder();">
                                        ユニット詳細
                                    </button>
                                    ${stat.completion_rate < 100 ? `
                                        <button class="btn btn-sm btn-success" 
                                            onclick="document.getElementById('purchaseOrderInput').value='${displayNumber}'; receiveByPurchaseOrder();">
                                            受入
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    statsDiv.innerHTML = html;
                } else {
                        statsDiv.innerHTML = '<p>発注データがありません</p>';
                    }
                } catch (error) {
                    console.error('統計読み込みエラー:', error);
                    showToast('統計読み込みエラー', 'error');
                }
            }


            // 仕様1入力でEnterキー対応
            document.getElementById('spec1Input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBySpec1();
                }
            });

            // 🔥 発注番号入力でEnterキー対応（バーコードスキャン後の受入確認）
            document.getElementById('purchaseOrderInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const orderNumber = this.value.trim();
                    if (orderNumber) {
                        showBarcodeReceivePopup(orderNumber);
                    }
                }
            });

            // ========================================
            // DB更新検知・通知システム
            // ========================================
            let dbUpdateCheckInterval = null;
            const DB_CHECK_INTERVAL = 5 * 60 * 1000; // 5分ごと

            async function checkDbUpdates() {
                try {
                    const response = await fetch('/api/across-db/check-updates');
                    const result = await response.json();

                    if (!result.success) {
                        console.error('DB更新チェックエラー:', result.error);
                        return;
                    }

                    // 状態表示を更新
                    updateDbStatusDisplay(result.current_snapshot);

                    // 更新がある場合は通知バーを表示
                    if (result.has_updates) {
                        showDbUpdateNotification(result);
                    }

                    // 初回チェックの場合
                    if (result.is_first_check) {
                        console.log('DB更新検知: ベースライン設定完了');
                    }

                    return result;
                } catch (error) {
                    console.error('DB更新チェック失敗:', error);
                }
            }

            function updateDbStatusDisplay(snapshot) {
                if (!snapshot) return;

                document.getElementById('dbTehaiCount').textContent = snapshot.tehai_count?.toLocaleString() || '-';
                document.getElementById('dbHacchuCount').textContent = snapshot.hacchu_count?.toLocaleString() || '-';

                const now = new Date();
                document.getElementById('dbLastCheck').textContent =
                    `最終確認: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            }

            function showDbUpdateNotification(result) {
                const bar = document.getElementById('dbUpdateBar');
                const messageEl = document.getElementById('dbUpdateMessage');
                const timeEl = document.getElementById('dbUpdateTime');
                const iconEl = document.getElementById('dbUpdateIcon');
                const detailsBody = document.getElementById('dbUpdateDetailsBody');

                // メッセージ構築
                let messages = [];
                if (result.tehai_changes?.new_seibans?.length > 0) {
                    messages.push(`新規製番: ${result.tehai_changes.new_seibans.slice(0, 3).join(', ')}${result.tehai_changes.new_seibans.length > 3 ? ' 他' : ''}`);
                }
                if (result.tehai_changes?.count_diff > 0) {
                    messages.push(`手配 +${result.tehai_changes.count_diff}件`);
                }
                if (result.hacchu_changes?.count_diff > 0) {
                    messages.push(`発注 +${result.hacchu_changes.count_diff}件`);
                }

                messageEl.textContent = messages.join(' / ') || result.message;
                timeEl.textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                iconEl.textContent = '🔔';

                // 詳細テーブルを構築
                detailsBody.innerHTML = '';
                const details = result.hacchu_changes?.new_order_details || [];
                if (details.length > 0) {
                    details.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                        tr.innerHTML = `
                            <td style="padding:5px;">${item['製番'] || '-'}</td>
                            <td style="padding:5px;">${item['品名'] || '-'}</td>
                            <td style="padding:5px;">${item['仕様１'] || '-'}</td>
                            <td style="padding:5px; text-align:right;">${item['発注数'] || '-'} ${item['単位'] || ''}</td>
                            <td style="padding:5px;">${item['仕入先'] || '-'}</td>
                            <td style="padding:5px;">${item['納期'] || '-'}</td>
                        `;
                        detailsBody.appendChild(tr);
                    });
                } else {
                    detailsBody.innerHTML = '<tr><td colspan="6" style="padding:10px; text-align:center; opacity:0.7;">詳細情報なし</td></tr>';
                }

                bar.style.display = 'block';

                // ブラウザ通知（許可されている場合）
                if (Notification.permission === 'granted') {
                    let notifyBody = messages.join(' / ') || result.message;
                    if (details.length > 0) {
                        const firstItem = details[0];
                        notifyBody += `\n${firstItem['製番']} ${firstItem['品名']}`;
                        if (details.length > 1) notifyBody += ` 他${details.length - 1}件`;
                    }
                    new Notification('DB更新検知', {
                        body: notifyBody,
                        icon: '/static/favicon.ico'
                    });
                }
            }

            function toggleDbUpdateDetails() {
                const details = document.getElementById('dbUpdateDetails');
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }

            function dismissDbUpdate() {
                document.getElementById('dbUpdateBar').style.display = 'none';
                document.getElementById('dbUpdateDetails').style.display = 'none';
            }

            function startDbUpdateCheck() {
                // 初回チェック
                checkDbUpdates();

                // 定期チェック開始
                if (dbUpdateCheckInterval) {
                    clearInterval(dbUpdateCheckInterval);
                }
                dbUpdateCheckInterval = setInterval(checkDbUpdates, DB_CHECK_INTERVAL);
                console.log(`DB更新チェック開始（${DB_CHECK_INTERVAL / 1000}秒間隔）`);
            }

            function stopDbUpdateCheck() {
                if (dbUpdateCheckInterval) {
                    clearInterval(dbUpdateCheckInterval);
                    dbUpdateCheckInterval = null;
                    console.log('DB更新チェック停止');
                }
            }

            // ブラウザ通知の許可リクエスト
            function requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            // ページ読み込み時に統計を表示
            document.addEventListener('DOMContentLoaded', function() {
                // 初期データ読み込み
                loadOrders();
                loadArchivedOrders();
                setupDragDrop();
                loadHistoryData();

                // DB更新検知開始
                startDbUpdateCheck();
                requestNotificationPermission();
                
                // 🔥 一括削除ボタンのイベントリスナー（一度だけ登録）
                document.getElementById('deleteMultipleBtn').addEventListener('click', async () => {
                    const checkboxes = document.querySelectorAll('.seiban-checkbox:checked');
                    
                    if (checkboxes.length === 0) {
                        showToast('削除する製番を選択してください', 'warning');
                        return;
                    }
                    
                    // チェックされた製番から注文IDを収集
                    const orderIds = [];
                    const seibans = [];
                    
                    checkboxes.forEach(cb => {
                        seibans.push(cb.value);
                        const ids = cb.getAttribute('data-order-ids').split(',').map(id => parseInt(id));
                        orderIds.push(...ids);
                    });
                    
                    if (orderIds.length === 0) {
                        showToast('削除対象の注文が見つかりません', 'warning');
                        return;
                    }
                    
                    if (!confirm(`${seibans.length}件の製番（計${orderIds.length}ユニット）を削除しますか？\n\n製番: ${seibans.join(', ')}\n\nこの操作は取り消せません。`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/orders/delete-multiple', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({order_ids: orderIds})
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showToast(result.message, 'success');
                            loadOrders();
                        } else {
                            showToast('エラー: ' + result.error, 'error');
                        }
                    } catch (error) {
                        showToast('削除に失敗しました: ' + error, 'error');
                    }
                });
                
                // 定期実行タイマー
                setInterval(loadSystemStatus, 3600000);  // 60分ごと
                setInterval(checkForUpdates, 600000);    // 10分ごと
            });
            </script>

            <!-- パレット管理タブ -->
            <div id="pallets-tab" class="tab-content">
                <h2>🏢 ユニット保管場所</h2>
                
                <!-- 検索セクション -->
                <div class="upload-section">
                    <h3>🔍 製番検索</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="seibanSearchInput" placeholder="製番または品名を入力..." 
                            style="flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em;">
                        <button class="btn btn-primary" onclick="searchSeiban()">🔍 検索</button>
                    </div>
                    <div id="searchResults"></div>
                </div>
                
                <!-- パレット統計 -->
                <div class="upload-section">
                    <h3>📊 保管統計</h3>
                    <div id="palletStats"></div>
                </div>
                
                <!-- パレット一覧 -->
                <div class="upload-section">
                    <h3>📦 保管場所一覧(P=パレット,T=棚,D=台車)　🟡受入準備前,🔵納品中,🟢納品完了</h3>
                    <div id="palletList" class="order-grid"></div>
                </div>
            </div>
            
            <!-- アーカイブタブ -->
            <div id="archive-tab" class="tab-content">
                <h2>🗄️ アーカイブ（納品完了）</h2>
                <p>納品完了してアーカイブされた注文一覧</p>
                <div id="archiveGrid" class="order-grid"></div>
            </div>

            <!-- 発行履歴タブ -->
            <div id="history-tab" class="tab-content">
                <h2>📊 発行履歴</h2>
                <button class="btn btn-primary" onclick="loadHistoryData()">
                    履歴を更新
                </button>
                <button class="btn btn-warning" onclick="document.getElementById('historyFileInput').click()" style="margin-left: 10px;">
                    履歴ファイルを手動インポート
                </button>
                <input type="file" id="historyFileInput" accept=".xlsx" style="display: none;" onchange="importHistory(this)">
                
                <div id="historyList" style="margin-top: 20px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>履歴を読み込み中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細モーダル -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">注文詳細</h2>
                <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- トースト通知コンテナ -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        let currentFilePath = '';
        let currentOrderId = null;

        // トースト通知関数
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        }

        // Check for file updates
        async function checkForUpdates() {
            try {
                const response = await fetch('/api/check-update');
                const data = await response.json();
                
                if (data.has_update) {
                    if (confirm(`${data.message}\n\nデータを更新しますか？`)) {
                        await loadNetworkFile();
                        loadOrders();
                    }
                }
            } catch (error) {
                console.error('Update check error:', error);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'receiving') {
                loadDeliverySchedule();
                loadUpdateInfo();
            } else if (tabName === 'archive') {
                loadArchivedOrders();
            }
        }

        // Load archived orders
        async function loadArchivedOrders() {
            try {
                const response = await fetch('/api/archived-orders');
                if (!response.ok) {
                    console.error('Failed to load archived orders:', response.status);
                    return;
                }
                const orders = await response.json();

                // 配列でない場合はエラー処理
                if (!Array.isArray(orders)) {
                    console.error('Invalid archived orders response:', orders);
                    return;
                }

                const archiveGrid = document.getElementById('archiveGrid');
                archiveGrid.innerHTML = '';

                if (orders.length === 0) {
                    archiveGrid.innerHTML = '<p>アーカイブされた注文はありません</p>';
                    return;
                }
                
                orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.onclick = () => showOrderDetails(order.id);
                    
                    card.innerHTML = `
                        <div class="order-header">
                            <span class="order-seiban">${order.seiban}</span>
                            <span class="order-status status-納品完了">納品完了</span>
                        </div>
                        ${order.product_name ? `<p><strong>品名:</strong> ${order.product_name}</p>` : ''}
                        <p><strong>ユニット:</strong> ${order.unit || '-'}</p>
                        <p><strong>場所:</strong> ${order.location}</p>
                        <p><strong>アーカイブ日:</strong> ${new Date(order.archived_at).toLocaleString('ja-JP')}</p>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); exportOrder(${order.id})">Excel出力</button>
                            <button class="btn btn-warning" onclick="event.stopPropagation(); unarchiveOrder(${order.id})">復元</button>
                        </div>
                    `;
                    
                    archiveGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading archived orders:', error);
            }
        }

        // Archive order
        async function archiveOrder(orderId) {
            if (!confirm('この注文をアーカイブしますか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/archive`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadOrders();
                } else {
                    showToast('エラー: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('アーカイブエラー: ' + error, 'error');
            }
        }

        // Unarchive order
        async function unarchiveOrder(orderId) {
            if (!confirm('この注文を復元しますか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/unarchive`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadArchivedOrders();
                } else {
                    showToast('エラー: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('復元エラー: ' + error, 'error');
            }
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0]);
        });

        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileUpload(e.dataTransfer.files[0]);
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentFilePath = data.filepath;
                    populateSheetSelects(data.sheet_names);
                    document.getElementById('sheetSelection').style.display = 'block';
                    document.getElementById('uploadText').innerHTML = `
                        <p style="font-size: 3em;">✅</p>
                        <p>${file.name} アップロード完了</p>
                    `;
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('アップロードエラー: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function populateSheetSelects(sheetNames) {
            const sheet1Select = document.getElementById('sheet1Select');
            const sheet2Select = document.getElementById('sheet2Select');
            
            sheet1Select.innerHTML = '';
            sheet2Select.innerHTML = '';
            
            sheetNames.forEach((name, index) => {
                sheet1Select.innerHTML += `<option value="${name}">${name}</option>`;
                sheet2Select.innerHTML += `<option value="${name}">${name}</option>`;
            });
            
            if (sheetNames.length > 1) {
                sheet2Select.selectedIndex = 1;
            }
        }

        // 発注日フィルタの表示切替
        function toggleOrderDateFilter() {
            const enabled = document.getElementById('enableOrderDateFilter').checked;
            const filterInput = document.getElementById('orderDateFilterInput');
            
            if (enabled) {
                filterInput.style.display = 'block';
                // デフォルトで1ヶ月前から今日までの期間を設定
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                document.getElementById('orderDateFrom').valueAsDate = oneMonthAgo;
                document.getElementById('orderDateTo').valueAsDate = new Date();
            } else {
                filterInput.style.display = 'none';
            }
        }

        // 製番一覧を取得してチェックボックスリストに表示
        let seibanListItems = [];  // 全アイテム保持用
        async function loadSeibanList() {
            const listDiv = document.getElementById('seibanCheckboxList');
            const actionsDiv = document.getElementById('seibanBatchActions');
            listDiv.style.display = 'block';
            listDiv.innerHTML = '<span style="color: #888;">読み込み中...</span>';
            actionsDiv.style.display = 'none';
            try {
                const response = await fetch('/api/seiban-list');
                const data = await response.json();
                if (data.success && data.items) {
                    seibanListItems = data.items;
                    renderSeibanCheckboxes(data.items);
                    actionsDiv.style.display = 'block';
                } else {
                    listDiv.innerHTML = '<span style="color: #dc3545;">取得失敗</span>';
                    alert('製番一覧の取得に失敗: ' + (data.error || '不明なエラー'));
                }
            } catch (error) {
                listDiv.innerHTML = '<span style="color: #dc3545;">取得エラー</span>';
                alert('製番一覧の取得エラー: ' + error);
            }
        }

        // チェックボックスを描画
        function renderSeibanCheckboxes(items) {
            const listDiv = document.getElementById('seibanCheckboxList');
            listDiv.innerHTML = '';
            if (items.length === 0) {
                listDiv.innerHTML = '<span style="color: #888;">該当なし</span>';
                return;
            }
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'seiban-cb-label';
                label.style.cssText = 'display: flex; align-items: center; padding: 4px 6px; cursor: pointer; border-radius: 4px; gap: 8px;';
                label.setAttribute('data-seiban', item.seiban.toLowerCase());
                label.innerHTML = `
                    <input type="checkbox" class="seiban-cb" value="${item.seiban}" onchange="onSeibanCheckChange()" style="width: 18px; height: 18px; flex-shrink: 0;">
                    <span style="font-weight: bold; white-space: nowrap;">${item.seiban}</span>
                    <span style="color: #555; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.product_name}</span>
                    <span style="color: #888; font-size: 0.85em; white-space: nowrap;">(${item.customer_abbr})</span>`;
                label.addEventListener('mouseenter', () => label.style.background = '#f0f0f0');
                label.addEventListener('mouseleave', () => label.style.background = '');
                listDiv.appendChild(label);
            });
            updateSeibanCheckCount();
        }

        // 絞り込み
        function filterSeibanCheckboxes() {
            const filter = document.getElementById('seibanFilterInput').value.toLowerCase();
            document.querySelectorAll('.seiban-cb-label').forEach(label => {
                const seiban = label.getAttribute('data-seiban');
                label.style.display = seiban.includes(filter) ? 'flex' : 'none';
            });
        }

        // 選択数表示を更新
        function onSeibanCheckChange() {
            updateSeibanCheckCount();
            // 1個だけチェックされてたらテキスト欄にも反映
            const checked = document.querySelectorAll('.seiban-cb:checked');
            if (checked.length === 1) {
                document.getElementById('seibanInput').value = checked[0].value;
            }
        }
        function updateSeibanCheckCount() {
            const total = document.querySelectorAll('.seiban-cb').length;
            const checked = document.querySelectorAll('.seiban-cb:checked').length;
            const el = document.getElementById('seibanCheckCount');
            if (el) el.textContent = `${checked} / ${total} 選択中`;
        }

        // 全選択 / 全解除（表示中のみ）
        function selectAllSeibanCheckboxes() {
            document.querySelectorAll('.seiban-cb-label').forEach(label => {
                if (label.style.display !== 'none') {
                    label.querySelector('.seiban-cb').checked = true;
                }
            });
            updateSeibanCheckCount();
        }
        function deselectAllSeibanCheckboxes() {
            document.querySelectorAll('.seiban-cb').forEach(cb => cb.checked = false);
            updateSeibanCheckCount();
        }

        // 一括処理
        async function processBatchSeibans() {
            const checked = [...document.querySelectorAll('.seiban-cb:checked')].map(cb => cb.value);
            if (checked.length === 0) {
                alert('製番を1つ以上選択してください');
                return;
            }

            const sheet1 = document.getElementById('sheet1Select').value;
            const sheet2 = document.getElementById('sheet2Select').value;

            let orderDateFrom = null, orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                orderDateFrom = document.getElementById('orderDateFrom').value || null;
                orderDateTo = document.getElementById('orderDateTo').value || null;
            }

            if (!confirm(`${checked.length}件の製番を一括処理します。\n\n${checked.join('\n')}\n\n実行しますか？`)) return;

            const progressContainer = document.getElementById('batchProgressContainer');
            const progressBar = document.getElementById('batchProgressBar');
            const progressPercent = document.getElementById('batchProgressPercent');
            const progressTitle = document.getElementById('batchProgressTitle');
            const progressLog = document.getElementById('batchProgressLog');

            progressContainer.style.display = 'block';
            progressLog.innerHTML = '';
            let successCount = 0, failCount = 0;

            for (let i = 0; i < checked.length; i++) {
                const seiban = checked[i];
                const pct = Math.round(((i) / checked.length) * 100);
                progressBar.style.width = pct + '%';
                progressPercent.textContent = pct + '%';
                progressTitle.textContent = `一括処理中... (${i + 1}/${checked.length}) ${seiban}`;

                try {
                    const requestBody = { filepath: currentFilePath, sheet1, sheet2, seiban };
                    if (orderDateFrom) requestBody.order_date_from = orderDateFrom;
                    if (orderDateTo) requestBody.order_date_to = orderDateTo;

                    const response = await fetch('/api/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();

                    if (data.success) {
                        successCount++;
                        progressLog.innerHTML += `<div style="color: #28a745;">✓ ${seiban}: ${data.message}</div>`;
                    } else {
                        failCount++;
                        progressLog.innerHTML += `<div style="color: #dc3545;">✗ ${seiban}: ${data.error}</div>`;
                    }
                } catch (error) {
                    failCount++;
                    progressLog.innerHTML += `<div style="color: #dc3545;">✗ ${seiban}: ${error}</div>`;
                }
                progressLog.scrollTop = progressLog.scrollHeight;
            }

            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressTitle.textContent = `完了！ 成功: ${successCount}件 / 失敗: ${failCount}件`;
            progressBar.style.background = failCount === 0
                ? 'linear-gradient(135deg, #28a745, #20c997)'
                : 'linear-gradient(135deg, #ffc107, #fd7e14)';

            loadOrders();
            deselectAllSeibanCheckboxes();
        }

        // processFile関数を修正
        async function processFile() {
            const sheet1 = document.getElementById('sheet1Select').value;
            const sheet2 = document.getElementById('sheet2Select').value;
            const seiban = document.getElementById('seibanInput').value;
            
            if (!seiban) {
                alert('製番を入力してください');
                return;
            }
            
            // 発注日フィルタの取得
            let orderDateFrom = null;
            let orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                const dateFromValue = document.getElementById('orderDateFrom').value;
                const dateToValue = document.getElementById('orderDateTo').value;
                
                if (dateFromValue) {
                    orderDateFrom = dateFromValue;  // YYYY-MM-DD形式
                }
                if (dateToValue) {
                    orderDateTo = dateToValue;  // YYYY-MM-DD形式
                }
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const requestBody = {
                    filepath: currentFilePath,
                    sheet1: sheet1,
                    sheet2: sheet2,
                    seiban: seiban
                };
                
                // 発注日フィルタがある場合は追加
                if (orderDateFrom) {
                    requestBody.order_date_from = orderDateFrom;
                }
                if (orderDateTo) {
                    requestBody.order_date_to = orderDateTo;
                }
                
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = '処理完了: ' + data.message;
                    if (orderDateFrom || orderDateTo) {
                        if (orderDateFrom && orderDateTo) {
                            message += `\n📅 発注日フィルタ: ${orderDateFrom} 〜 ${orderDateTo}`;
                        } else if (orderDateFrom) {
                            message += `\n📅 発注日フィルタ: ${orderDateFrom}以降`;
                        } else if (orderDateTo) {
                            message += `\n📅 発注日フィルタ: ${orderDateTo}まで`;
                        }
                    }
                    alert(message);
                    loadOrders();
                    
                    // フォームリセット
                    document.getElementById('seibanInput').value = '';
                    deselectAllSeibanCheckboxes();
                    document.getElementById('sheetSelection').style.display = 'none';
                    document.getElementById('enableOrderDateFilter').checked = false;
                    document.getElementById('orderDateFilterInput').style.display = 'none';
                    document.getElementById('uploadText').innerHTML = `
                        <p style="font-size: 3em;">📁</p>
                        <p>クリックまたはドラッグ&ドロップでファイルを選択</p>
                        <p style="color: #6c757d; font-size: 0.9em;">対応形式: .xlsx, .xls (最大50MB)</p>
                    `;
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('処理エラー: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // DB直接処理（手動入力）
        async function processFileFromDB() {
            const seiban = document.getElementById('seibanInput').value.trim();
            if (!seiban) {
                alert('製番を入力してください');
                return;
            }

            let orderDateFrom = null;
            let orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                orderDateFrom = document.getElementById('orderDateFrom').value || null;
                orderDateTo = document.getElementById('orderDateTo').value || null;
            }

            document.getElementById('loadingIndicator').style.display = 'block';

            try {
                const response = await fetch('/api/across-db/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seiban, order_date_from: orderDateFrom, order_date_to: orderDateTo })
                });
                const data = await response.json();
                if (data.success) {
                    alert('🗄️ ' + data.message);
                    loadOrders();
                    document.getElementById('seibanInput').value = '';
                    deselectAllSeibanCheckboxes();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('DB直接処理エラー: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // DB直接一括処理
        async function processBatchSeibansFromDB() {
            const checkboxes = document.querySelectorAll('.seiban-cb:checked');
            if (checkboxes.length === 0) {
                alert('処理する製番を選択してください');
                return;
            }

            const seibans = Array.from(checkboxes).map(cb => cb.value);
            if (!confirm(`🗄️ DB直接取得で ${seibans.length} 件の製番を処理しますか？\n\n${seibans.join(', ')}`)) {
                return;
            }

            let orderDateFrom = null;
            let orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                orderDateFrom = document.getElementById('orderDateFrom').value || null;
                orderDateTo = document.getElementById('orderDateTo').value || null;
            }

            // バッチ進捗表示
            const container = document.getElementById('batchProgressContainer');
            const progressBar = document.getElementById('batchProgressBar');
            const progressTitle = document.getElementById('batchProgressTitle');
            const progressLog = document.getElementById('batchProgressLog');
            container.style.display = 'block';
            progressLog.innerHTML = '';

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < seibans.length; i++) {
                const seiban = seibans[i];
                const pct = Math.round(((i + 1) / seibans.length) * 100);
                progressBar.style.width = pct + '%';
                progressBar.textContent = pct + '%';
                progressTitle.textContent = `🗄️ DB直接一括処理中... (${i + 1}/${seibans.length})`;

                try {
                    const response = await fetch('/api/across-db/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ seiban, order_date_from: orderDateFrom, order_date_to: orderDateTo })
                    });
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                        progressLog.innerHTML += '<div style="color:green;">✓ ' + seiban + ': ' + data.message + '</div>';
                    } else {
                        failCount++;
                        progressLog.innerHTML += '<div style="color:red;">✗ ' + seiban + ': ' + data.error + '</div>';
                    }
                } catch (e) {
                    failCount++;
                    progressLog.innerHTML += '<div style="color:red;">✗ ' + seiban + ': ' + e + '</div>';
                }
            }

            progressTitle.textContent = `🗄️ DB直接一括処理完了: 成功 ${successCount}件 / 失敗 ${failCount}件`;
            loadOrders();
        }

        // 製番から親製番を抽出（枝番を除去）
        function getParentSeiban(seiban) {
            // MHT0620-001 → MHT0620, 620-008 → 620
            const match = seiban.match(/^(.+?)-\d+$/);
            return match ? match[1] : null;
        }

        // 製番のソート用比較関数（数値部分を正しく比較）
        function compareSeibanNumeric(a, b, desc = true) {
            // 数字部分を抽出して比較
            const numA = parseInt((a.match(/\d+/) || ['0'])[0], 10);
            const numB = parseInt((b.match(/\d+/) || ['0'])[0], 10);
            if (numA !== numB) {
                return desc ? numB - numA : numA - numB;
            }
            // 数字が同じなら文字列全体で比較
            return desc ? b.localeCompare(a) : a.localeCompare(b);
        }

        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    console.error('Failed to load orders:', response.status);
                    return;
                }
                const orders = await response.json();

                // 配列でない場合はエラー処理
                if (!Array.isArray(orders)) {
                    console.error('Invalid orders response:', orders);
                    return;
                }

                // ソート順を取得
                const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
                const groupDerivatives = document.getElementById('groupDerivatives')?.checked ?? true;

                // 製番でグループ化
                const groupedBySeiban = {};
                orders.forEach(order => {
                    if (!groupedBySeiban[order.seiban]) {
                        groupedBySeiban[order.seiban] = {
                            seiban: order.seiban,
                            product_name: order.product_name,
                            customer_abbr: order.customer_abbr,
                            memo2: order.memo2,
                            units: [],
                            isDerivative: false,
                            parentSeiban: null,
                            derivatives: []
                        };
                    }
                    groupedBySeiban[order.seiban].units.push(order);
                });

                // 枝番グループ化が有効な場合、親子関係を構築
                if (groupDerivatives) {
                    const seibans = Object.keys(groupedBySeiban);
                    seibans.forEach(seiban => {
                        const parent = getParentSeiban(seiban);
                        if (parent && groupedBySeiban[parent]) {
                            // 親が存在する場合、派生として登録
                            groupedBySeiban[seiban].isDerivative = true;
                            groupedBySeiban[seiban].parentSeiban = parent;
                            groupedBySeiban[parent].derivatives.push(seiban);
                        }
                    });
                }

                // 製番でソート（派生を除く親のみ、または全て）
                const isDescending = sortOrder === 'desc';
                let sortedSeibans;
                if (groupDerivatives) {
                    // 親製番のみをソートし、派生は親の下に表示
                    sortedSeibans = Object.keys(groupedBySeiban)
                        .filter(s => !groupedBySeiban[s].isDerivative)
                        .sort((a, b) => compareSeibanNumeric(a, b, isDescending));
                } else {
                    // 全製番をフラットにソート
                    sortedSeibans = Object.keys(groupedBySeiban)
                        .sort((a, b) => compareSeibanNumeric(a, b, isDescending));
                }
                
                // orderGrid要素を取得
                const orderGrid = document.getElementById('orderGrid');
                orderGrid.innerHTML = '';
                
                sortedSeibans.forEach(seiban => {
                    const group = groupedBySeiban[seiban];
                    
                    // 親要素（製番レベル）
                    const parentCard = document.createElement('div');
                    parentCard.className = 'seiban-group';
                    
                    // グループ全体の統計を計算
                    const totalDetails = group.units.reduce((sum, unit) => sum + unit.detail_count, 0);
                    const totalReceived = group.units.reduce((sum, unit) => sum + unit.received_count, 0);
                    const hasInternalProcessing = group.units.some(unit => unit.has_internal_processing);
                    
                    // 全体のステータスを決定
                    const allCompleted = group.units.every(unit => unit.status === '納品完了');
                    const anyInProgress = group.units.some(unit => unit.status === '納品中');
                    const overallStatus = allCompleted ? '納品完了' : (anyInProgress ? '納品中' : '受入準備前');
                    
                    parentCard.innerHTML = `
                        <div class="seiban-header">
                            <input type="checkbox" class="seiban-checkbox" value="${seiban}" 
                            data-order-ids="${group.units.map(u => u.id).join(',')}" 
                            style="margin-right: 10px;">
                            <div onclick="toggleSeibanGroup('${seiban}')" style="flex: 1; cursor: pointer;">
                                <div class="seiban-info">
                                    <span class="seiban-toggle" id="toggle-${seiban}">📁</span>
                                    <span class="seiban-title">${seiban}${group.customer_abbr ? '（' + group.customer_abbr + '）' : ''}</span>
                                    <span class="seiban-product-name">${group.product_name || ''}${group.memo2 ? '　' + group.memo2 : ''}</span>
                                    <span class="order-status status-${overallStatus}">${overallStatus}</span>
                                </div>
                                <div class="seiban-summary">
                                    <span class="unit-count">${group.units.length} ユニット</span>
                                    <span class="progress-text">${totalReceived}/${totalDetails} 完了</span>
                                    ${hasInternalProcessing ? '<span class="internal-processing-warning">⚠️ 追加工有</span>' : ''}
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${totalDetails > 0 ? (totalReceived/totalDetails)*100 : 0}%"></div>
                                </div>
                                <div class="seiban-actions" style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center; padding-left: 15px; margin-top: 5px;">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); exportSeiban('${seiban}')" title="製番全体をExcel出力" style="font-size: 0.85em; padding: 4px 8px;">
                                        📄 Excel出力
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); refreshSeiban('${seiban}')" title="この製番のデータを最新に更新" style="font-size: 0.85em; padding: 4px 8px;">
                                        🔄 更新
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); generateLabels('${seiban}')" title="ラベル印刷用Excel出力" style="font-size: 0.85em; padding: 4px 8px;">
                                        🏷 ラベル
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="unit-list" id="units-${seiban}" style="display: none;">
                        </div>
                        <table class="unit-table" id="table-${seiban}" style="display:none;">
                            <thead>
                                <tr>
                                    <th>ユニット</th>
                                    <th>ステータス</th>
                                    <th>進捗</th>
                                    <th>場所</th>
                                    <th>備考</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    `;

                    orderGrid.appendChild(parentCard);

                    // 子要素（ユニットレベル）をユニットリストに追加
                    const unitList = parentCard.querySelector(`#units-${seiban}`);
                    const tableBody = parentCard.querySelector(`#table-${seiban} tbody`);
                    group.units.forEach(order => {
                        // -- Card view --
                        const unitCard = document.createElement('div');
                        unitCard.className = `unit-card status-${order.status}`;
                        unitCard.setAttribute('data-unit', (order.unit || '').toLowerCase());
                        unitCard.setAttribute('data-status', (order.status || '').toLowerCase());
                        unitCard.setAttribute('data-order-id', order.id);
                        unitCard.onclick = () => showOrderDetails(order.id);

                        const isCompleted = order.status === '納品完了';

                        unitCard.innerHTML = `
                            <div class="unit-header">
                                <span class="unit-name">ユニット：${order.unit || 'ユニット名無し'}</span>
                                <span class="order-status status-${order.status}">${order.status}</span>
                            </div>
                            <div class="unit-details">
                                <p><strong>📍 場所:</strong> ${order.location}</p>
                                <p><strong>📊 進捗:</strong> ${order.received_count}/${order.detail_count} 完了</p>
                                ${order.has_internal_processing ?
                                    '<p><span class="internal-processing-warning" style="display: inline-block; margin-top: 5px;">⚠️ 追加工有</span></p>' : ''
                                }
                                ${order.created_at ?
                                    `<p><strong>📅 シート作成日:</strong> ${order.created_at}</p>` : ''
                                }
                                ${order.updated_at ?
                                    `<p><strong>✒️ シート内容更新日:</strong> ${order.updated_at}</p>` : ''
                                }
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${order.detail_count > 0 ? (order.received_count/order.detail_count)*100 : 0}%"></div>
                            </div>
                            <div class="unit-actions" style="margin-top: 5px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); exportOrder(${order.id})">📄 Excel出力</button>
                                ${isCompleted ?
                                    `<button class="btn btn-success" onclick="event.stopPropagation(); archiveOrder(${order.id})">📦 アーカイブへ</button>` :
                                    `<button class="btn btn-danger" onclick="event.stopPropagation(); deleteOrder(${order.id})">🗑️ 削除</button>`
                                }
                            </div>
                        `;

                        unitList.appendChild(unitCard);

                        // -- Table view row --
                        const pct = order.detail_count > 0 ? (order.received_count/order.detail_count)*100 : 0;
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-unit', (order.unit || '').toLowerCase());
                        tr.setAttribute('data-status', (order.status || '').toLowerCase());
                        tr.setAttribute('data-order-id', order.id);
                        tr.onclick = () => showOrderDetails(order.id);
                        tr.innerHTML = `
                            <td><strong>${order.unit || 'ユニット名無し'}</strong></td>
                            <td><span class="order-status status-${order.status}" style="font-size:0.85em;padding:2px 8px;">${order.status}</span></td>
                            <td>${order.received_count}/${order.detail_count}
                                <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                            </td>
                            <td>${order.location || '未定'}</td>
                            <td>${order.has_internal_processing ? '⚠️追加工' : ''}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); exportOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">📄</button>
                                ${isCompleted ?
                                    `<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); archiveOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">📦</button>` :
                                    `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">🗑️</button>`
                                }
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // 派生製番（枝番）を親の下に表示
                    if (groupDerivatives && group.derivatives && group.derivatives.length > 0) {
                        // 派生をソート
                        const sortedDerivatives = group.derivatives.sort((a, b) => compareSeibanNumeric(a, b, isDescending));

                        sortedDerivatives.forEach(derivativeSeiban => {
                            const derivativeGroup = groupedBySeiban[derivativeSeiban];
                            if (!derivativeGroup) return;

                            // 派生カードを作成（インデント付き）
                            const derivativeCard = document.createElement('div');
                            derivativeCard.className = 'seiban-group derivative-seiban';
                            derivativeCard.style.marginLeft = '30px';
                            derivativeCard.style.borderLeft = '3px solid #6c757d';
                            derivativeCard.style.backgroundColor = '#f8f9fa';

                            // 派生グループの統計を計算
                            const derivTotalDetails = derivativeGroup.units.reduce((sum, unit) => sum + unit.detail_count, 0);
                            const derivTotalReceived = derivativeGroup.units.reduce((sum, unit) => sum + unit.received_count, 0);
                            const derivHasInternal = derivativeGroup.units.some(unit => unit.has_internal_processing);

                            // 派生のステータスを決定
                            const derivAllCompleted = derivativeGroup.units.every(unit => unit.status === '納品完了');
                            const derivAnyInProgress = derivativeGroup.units.some(unit => unit.status === '納品中');
                            const derivStatus = derivAllCompleted ? '納品完了' : (derivAnyInProgress ? '納品中' : '受入準備前');

                            derivativeCard.innerHTML = `
                                <div class="seiban-header">
                                    <input type="checkbox" class="seiban-checkbox" value="${derivativeSeiban}"
                                    data-order-ids="${derivativeGroup.units.map(u => u.id).join(',')}"
                                    style="margin-right: 10px;">
                                    <div onclick="toggleSeibanGroup('${derivativeSeiban}')" style="flex: 1; cursor: pointer;">
                                        <div class="seiban-info">
                                            <span class="seiban-toggle" id="toggle-${derivativeSeiban}">📁</span>
                                            <span class="seiban-title" style="color: #6c757d;">↳ ${derivativeSeiban}${derivativeGroup.customer_abbr ? '（' + derivativeGroup.customer_abbr + '）' : ''}</span>
                                            <span class="seiban-product-name">${derivativeGroup.product_name || ''}${derivativeGroup.memo2 ? '　' + derivativeGroup.memo2 : ''}</span>
                                            <span class="order-status status-${derivStatus}">${derivStatus}</span>
                                        </div>
                                        <div class="seiban-summary">
                                            <span class="unit-count">${derivativeGroup.units.length} ユニット</span>
                                            <span class="progress-text">${derivTotalReceived}/${derivTotalDetails} 完了</span>
                                            ${derivHasInternal ? '<span class="internal-processing-warning">⚠️ 追加工有</span>' : ''}
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${derivTotalDetails > 0 ? (derivTotalReceived/derivTotalDetails)*100 : 0}%"></div>
                                        </div>
                                        <div class="seiban-actions" style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center; padding-left: 15px; margin-top: 5px;">
                                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); exportSeiban('${derivativeSeiban}')" title="製番全体をExcel出力" style="font-size: 0.85em; padding: 4px 8px;">
                                                📄 Excel出力
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); refreshSeiban('${derivativeSeiban}')" title="この製番のデータを最新に更新" style="font-size: 0.85em; padding: 4px 8px;">
                                                🔄 更新
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); generateLabels('${derivativeSeiban}')" title="ラベル印刷用Excel出力" style="font-size: 0.85em; padding: 4px 8px;">
                                                🏷 ラベル
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="unit-list" id="units-${derivativeSeiban}" style="display: none;">
                                </div>
                                <table class="unit-table" id="table-${derivativeSeiban}" style="display:none;">
                                    <thead>
                                        <tr>
                                            <th>ユニット</th>
                                            <th>ステータス</th>
                                            <th>進捗</th>
                                            <th>場所</th>
                                            <th>備考</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            `;

                            orderGrid.appendChild(derivativeCard);

                            // 派生のユニットを追加
                            const derivUnitList = derivativeCard.querySelector(`#units-${derivativeSeiban}`);
                            const derivTableBody = derivativeCard.querySelector(`#table-${derivativeSeiban} tbody`);

                            derivativeGroup.units.forEach(order => {
                                // Card view
                                const unitCard = document.createElement('div');
                                unitCard.className = `unit-card status-${order.status}`;
                                unitCard.setAttribute('data-unit', (order.unit || '').toLowerCase());
                                unitCard.setAttribute('data-status', (order.status || '').toLowerCase());
                                unitCard.setAttribute('data-order-id', order.id);
                                unitCard.onclick = () => showOrderDetails(order.id);

                                const isCompleted = order.status === '納品完了';

                                unitCard.innerHTML = `
                                    <div class="unit-header">
                                        <span class="unit-name">ユニット：${order.unit || 'ユニット名無し'}</span>
                                        <span class="order-status status-${order.status}">${order.status}</span>
                                    </div>
                                    <div class="unit-details">
                                        <p><strong>📍 場所:</strong> ${order.location}</p>
                                        <p><strong>📊 進捗:</strong> ${order.received_count}/${order.detail_count} 完了</p>
                                        ${order.has_internal_processing ?
                                            '<p><span class="internal-processing-warning" style="display: inline-block; margin-top: 5px;">⚠️ 追加工有</span></p>' : ''
                                        }
                                        ${order.created_at ?
                                            `<p><strong>📅 シート作成日:</strong> ${order.created_at}</p>` : ''
                                        }
                                        ${order.updated_at ?
                                            `<p><strong>✒️ シート内容更新日:</strong> ${order.updated_at}</p>` : ''
                                        }
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${order.detail_count > 0 ? (order.received_count/order.detail_count)*100 : 0}%"></div>
                                    </div>
                                    <div class="unit-actions" style="margin-top: 5px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                        <button class="btn btn-primary" onclick="event.stopPropagation(); exportOrder(${order.id})">📄 Excel出力</button>
                                        ${isCompleted ?
                                            `<button class="btn btn-success" onclick="event.stopPropagation(); archiveOrder(${order.id})">📦 アーカイブへ</button>` :
                                            `<button class="btn btn-danger" onclick="event.stopPropagation(); deleteOrder(${order.id})">🗑️ 削除</button>`
                                        }
                                    </div>
                                `;

                                derivUnitList.appendChild(unitCard);

                                // Table view row
                                const pct = order.detail_count > 0 ? (order.received_count/order.detail_count)*100 : 0;
                                const tr = document.createElement('tr');
                                tr.setAttribute('data-unit', (order.unit || '').toLowerCase());
                                tr.setAttribute('data-status', (order.status || '').toLowerCase());
                                tr.setAttribute('data-order-id', order.id);
                                tr.onclick = () => showOrderDetails(order.id);
                                tr.innerHTML = `
                                    <td><strong>${order.unit || 'ユニット名無し'}</strong></td>
                                    <td><span class="order-status status-${order.status}" style="font-size:0.85em;padding:2px 8px;">${order.status}</span></td>
                                    <td>${order.received_count}/${order.detail_count}
                                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                                    </td>
                                    <td>${order.location || '未定'}</td>
                                    <td>${order.has_internal_processing ? '⚠️追加工' : ''}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); exportOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">📄</button>
                                        ${isCompleted ?
                                            `<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); archiveOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">📦</button>` :
                                            `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">🗑️</button>`
                                        }
                                    </td>
                                `;
                                derivTableBody.appendChild(tr);
                            });
                        });
                    }
                });

                // ガントチャートは表示中の場合のみ更新
                const ganttContainer = document.getElementById('ganttChartContainer');
                if (ganttContainer && ganttContainer.style.display !== 'none') {
                    updateGanttChart(orders);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('注文読み込みエラー: ' + error, 'error');
            }
        }

        // ガントチャートのクリック処理
        async function handleGanttLabelClick(item) {
            console.log('🔍 クリックされたアイテム:', item);
            console.log('  - ラベル:', item.label);
            console.log('  - 製番:', item.seiban);
            
            try {
                const response = await fetch('/api/orders');
                const orders = await response.json();
                
                console.log('📦 全注文数:', orders.length);
                
                // ラベルから製番とユニット名を分解
                const [clickedSeiban, ...clickedUnitParts] = item.label.split('_');
                const clickedUnit = clickedUnitParts.join('_'); // アンダースコアが複数ある場合に対応
                
                console.log('  - 分解した製番:', clickedSeiban);
                console.log('  - 分解したユニット:', clickedUnit);
                
                // 該当する注文を検索
                const targetOrder = orders.find(order => {
                    const orderSeiban = order.seiban;
                    const orderUnit = order.unit || 'ユニット名無し';
                    
                    console.log(`    比較: ${orderSeiban}_${orderUnit} === ${item.label}`);
                    
                    return orderSeiban === clickedSeiban && orderUnit === clickedUnit;
                });
                
                if (targetOrder) {
                    console.log('✅ 注文が見つかりました:', targetOrder);
                    showOrderDetails(targetOrder.id);
                } else {
                    console.error('❌ 注文が見つかりません');
                    console.log('検索対象:', orders.map(o => ({
                        seiban: o.seiban,
                        unit: o.unit || 'ユニット名無し',
                        label: `${o.seiban}_${o.unit || 'ユニット名無し'}`
                    })));
                    showToast(`⚠️ ${item.label} の詳細が見つかりません`, 'warning');
                }
            } catch (error) {
                console.error('❌ エラー:', error);
                showToast(`エラー: ${error.message}`, 'error');
            }
        }

        async function toggleGanttChart() {
            const container = document.getElementById('ganttChartContainer');
            const filterContainer = document.getElementById('ganttFilterContainer');
            const icon = document.getElementById('ganttToggleIcon');
            const text = document.getElementById('ganttToggleText');

            if (container.style.display === 'none') {
                // 表示 → フィルタ・チャート領域を見せてからデータ読み込み
                container.style.display = 'block';
                filterContainer.style.display = 'block';
                icon.textContent = '📉';
                text.textContent = '非表示';

                // ガントチャートを生成（ローディングゲージ付き）
                try {
                    const response = await fetch('/api/orders');
                    const orders = await response.json();
                    await updateGanttChart(orders);
                } catch (error) {
                    console.error('ガントチャート読み込みエラー:', error);
                    showToast('ガントチャート読み込みエラー: ' + error, 'error');
                }
            } else {
                container.style.display = 'none';
                filterContainer.style.display = 'none';
                icon.textContent = '📈';
                text.textContent = '表示';
            }
        }
                // 製番単位でのExcel出力
                async function exportSeiban(seiban) {
                    try {
                        window.location.href = `/api/export-seiban/${seiban}`;
                    } catch (error) {
                        showToast('出力エラー: ' + error, 'error');
                    }
                }

                // 🔥 製番単位でのデータ更新（DB直接クエリ）
                async function refreshSeiban(seiban) {
                    if (!confirm(`製番 ${seiban} のデータを最新に更新しますか？\n\n※Across DBから直接取得してマージします（社内加工品も含む）`)) {
                        return;
                    }

                    // ローディング表示
                    document.getElementById('loadingIndicator').style.display = 'block';
                    showToast(`🔄 ${seiban} をDB直接更新中...`, 'info', 10000);

                    try {
                        const response = await fetch('/api/across-db/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                seiban: seiban,
                                include_mihatchu: true
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // 変更内容を詳細に表示
                            showRefreshFeedback(seiban, result);
                            // 受注リストを再読み込み
                            await loadOrders();
                        } else {
                            showToast(`❌ 更新エラー: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        showToast('更新エラー: ' + error, 'error');
                    } finally {
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }
                }

                // 更新フィードバック表示
                function showRefreshFeedback(seiban, result) {
                    const changes = result.changes || {};
                    let feedbackHtml = `<div style="text-align:left; max-width:400px;">`;
                    feedbackHtml += `<strong>✅ ${seiban} 更新完了</strong><br>`;
                    feedbackHtml += `<div style="margin:8px 0; padding:8px; background:#f5f5f5; border-radius:4px;">`;
                    feedbackHtml += `合計: ${result.total_items || 0}件<br>`;
                    feedbackHtml += `ユニット数: ${changes.total_after || 0}`;
                    if (changes.total_before !== changes.total_after) {
                        const diff = (changes.total_after || 0) - (changes.total_before || 0);
                        feedbackHtml += ` <span style="color:${diff > 0 ? '#28a745' : '#dc3545'};">(${diff > 0 ? '+' : ''}${diff})</span>`;
                    }
                    feedbackHtml += `</div>`;

                    // 新規追加されたユニット
                    if (changes.added_units && changes.added_units.length > 0) {
                        feedbackHtml += `<div style="margin:8px 0; padding:8px; background:#d4edda; border-radius:4px; border-left:4px solid #28a745;">`;
                        feedbackHtml += `<strong style="color:#155724;">🆕 新規ユニット (${changes.added_units.length}件)</strong><br>`;
                        changes.added_units.forEach(u => {
                            feedbackHtml += `<span style="color:#155724;">+ ${u.unit} (${u.detail_count}件)</span><br>`;
                        });
                        feedbackHtml += `</div>`;
                    }

                    // 更新されたユニット
                    if (changes.updated_units && changes.updated_units.length > 0) {
                        feedbackHtml += `<div style="margin:8px 0; padding:8px; background:#fff3cd; border-radius:4px; border-left:4px solid #ffc107;">`;
                        feedbackHtml += `<strong style="color:#856404;">🔄 更新ユニット (${changes.updated_units.length}件)</strong><br>`;
                        changes.updated_units.forEach(u => {
                            const diffSign = u.diff > 0 ? '+' : '';
                            feedbackHtml += `<span style="color:#856404;">${u.unit}: ${u.before_count} → ${u.after_count} (${diffSign}${u.diff})</span><br>`;
                        });
                        feedbackHtml += `</div>`;
                    }

                    // 変更なし
                    if ((!changes.added_units || changes.added_units.length === 0) &&
                        (!changes.updated_units || changes.updated_units.length === 0)) {
                        feedbackHtml += `<div style="margin:8px 0; padding:8px; background:#e2e3e5; border-radius:4px;">`;
                        feedbackHtml += `<span style="color:#383d41;">変更なし（${changes.unchanged_units ? changes.unchanged_units.length : 0}ユニット）</span>`;
                        feedbackHtml += `</div>`;
                    }

                    feedbackHtml += `</div>`;

                    // モーダルで表示
                    showFeedbackModal(feedbackHtml);
                }

                // フィードバックモーダル表示
                function showFeedbackModal(content) {
                    // 既存のモーダルがあれば削除
                    const existingModal = document.getElementById('feedbackModal');
                    if (existingModal) existingModal.remove();

                    const modal = document.createElement('div');
                    modal.id = 'feedbackModal';
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.5); display: flex; align-items: center;
                        justify-content: center; z-index: 10000;
                    `;
                    modal.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            ${content}
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="document.getElementById('feedbackModal').remove()"
                                    style="padding: 8px 24px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">
                                    OK
                                </button>
                            </div>
                        </div>
                    `;
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                    document.body.appendChild(modal);
                }

                // 🏷 ラベル生成・ダウンロード
                async function generateLabels(seiban) {
                    showToast(`🏷 ${seiban} のラベルを作成中...`, 'info', 10000);
                    document.getElementById('loadingIndicator').style.display = 'block';

                    try {
                        const response = await fetch('/api/generate-labels', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ seiban: seiban })
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${seiban}_ラベル.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            showToast(`✅ ${seiban} のラベルをダウンロードしました`, 'success');
                        } else {
                            const result = await response.json();
                            showToast(`❌ ラベル生成エラー: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        showToast('ラベル生成エラー: ' + error, 'error');
                    } finally {
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }
                }

                // --- View mode state ---
                let currentViewMode = 'card'; // 'card' or 'table'

                function setViewMode(mode) {
                    currentViewMode = mode;
                    document.getElementById('btnCardView').classList.toggle('active', mode === 'card');
                    document.getElementById('btnTableView').classList.toggle('active', mode === 'table');

                    // Switch all open groups
                    document.querySelectorAll('.seiban-group').forEach(group => {
                        const unitList = group.querySelector('.unit-list');
                        const unitTable = group.querySelector('.unit-table');
                        if (!unitList || !unitTable) return;

                        // Check if expanded (either view is visible)
                        const toggle = group.querySelector('.seiban-toggle');
                        const isOpen = toggle && toggle.textContent === '📂';
                        if (isOpen) {
                            unitList.style.display = mode === 'card' ? 'block' : 'none';
                            unitTable.style.display = mode === 'table' ? 'table' : 'none';
                        } else {
                            unitList.style.display = 'none';
                            unitTable.style.display = 'none';
                        }
                    });

                    // Re-apply search filter
                    filterOrders();
                }

                function toggleSeibanGroup(seiban) {
                    const unitList = document.getElementById(`units-${seiban}`);
                    const unitTable = document.getElementById(`table-${seiban}`);
                    const toggle = document.getElementById(`toggle-${seiban}`);

                    if (!unitList || !toggle) return;

                    const isCard = currentViewMode === 'card';
                    const activeEl = isCard ? unitList : unitTable;
                    const inactiveEl = isCard ? unitTable : unitList;

                    // Always hide the inactive view
                    if (inactiveEl) inactiveEl.style.display = 'none';

                    if (activeEl.style.display === 'none' || activeEl.style.display === '') {
                        activeEl.style.display = isCard ? 'block' : 'table';
                        toggle.textContent = '📂';
                        activeEl.style.animation = 'fadeIn 0.3s';
                    } else {
                        activeEl.style.display = 'none';
                        toggle.textContent = '📁';
                    }
                }

                function filterOrders() {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                    const seibanGroups = document.querySelectorAll('.seiban-group');
                    const isCard = currentViewMode === 'card';

                    seibanGroups.forEach(group => {
                        const seibanTitle = group.querySelector('.seiban-title');
                        const productName = group.querySelector('.seiban-product-name');
                        const toggle = group.querySelector('.seiban-toggle');

                        // Build header-level text
                        let headerText = '';
                        if (seibanTitle) headerText += seibanTitle.textContent.toLowerCase();
                        if (productName) headerText += ' ' + productName.textContent.toLowerCase();

                        // If no search term, show group collapsed, all units visible
                        if (!searchTerm) {
                            group.style.display = '';
                            // Reset all unit cards & table rows visibility
                            group.querySelectorAll('.unit-card').forEach(c => {
                                c.style.display = '';
                                c.classList.remove('search-highlight');
                            });
                            group.querySelectorAll('.unit-table tbody tr').forEach(r => {
                                r.style.display = '';
                                r.classList.remove('search-highlight');
                            });
                            return;
                        }

                        // Check header match (seiban, customer, product)
                        const headerMatch = headerText.includes(searchTerm);

                        // Check individual units
                        let anyUnitMatch = false;
                        const unitCards = group.querySelectorAll('.unit-card');
                        const tableRows = group.querySelectorAll('.unit-table tbody tr');

                        unitCards.forEach((card, i) => {
                            const unit = card.getAttribute('data-unit') || '';
                            const status = card.getAttribute('data-status') || '';
                            const unitText = unit + ' ' + status;
                            const matched = unitText.includes(searchTerm);

                            if (matched) anyUnitMatch = true;

                            // If header matches, show all; else show only matching units
                            if (headerMatch) {
                                card.style.display = '';
                                card.classList.remove('search-highlight');
                            } else {
                                card.style.display = matched ? '' : 'none';
                                card.classList.toggle('search-highlight', matched);
                            }

                            // Same logic for table row
                            if (tableRows[i]) {
                                if (headerMatch) {
                                    tableRows[i].style.display = '';
                                    tableRows[i].classList.remove('search-highlight');
                                } else {
                                    tableRows[i].style.display = matched ? '' : 'none';
                                    tableRows[i].classList.toggle('search-highlight', matched);
                                }
                            }
                        });

                        if (headerMatch || anyUnitMatch) {
                            group.style.display = '';
                            // Auto-expand when searching by unit name
                            if (anyUnitMatch && !headerMatch) {
                                const unitList = group.querySelector('.unit-list');
                                const unitTable = group.querySelector('.unit-table');
                                if (isCard && unitList) {
                                    unitList.style.display = 'block';
                                    if (unitTable) unitTable.style.display = 'none';
                                } else if (!isCard && unitTable) {
                                    unitTable.style.display = 'table';
                                    if (unitList) unitList.style.display = 'none';
                                }
                                if (toggle) toggle.textContent = '📂';
                            }
                        } else {
                            group.style.display = 'none';
                        }
                    });
                }

                // showOrderDetails関数内の詳細リスト部分を修正
                async function showOrderDetails(orderId) {
                    currentOrderId = orderId;
                    try {
                        const response = await fetch(`/api/order/${orderId}`);
                        const data = await response.json();
                        
                        document.getElementById('modalTitle').textContent = `${data.order.seiban} - ${data.order.unit}`;
                        
                        let detailsHtml = `
                            <div class="qr-code">
                                <img alt="QR Code" src="data:image/png;base64,${data.qr_code}">
                                <p style="font-size: 0.9em; word-break: break-all;">ORDER:${orderId}</p>
                            </div>
                            <div class="form-group">
                                <label>ステータス:</label>
                                <select id="statusSelect">
                                    <option value="受入準備前">受入準備前</option>
                                    <option value="納品中">納品中</option>
                                    <option value="納品完了">納品完了</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>場所:</label>
                                <select id="floorSelect">
                                    <option value="">未設定</option>
                                    <option value="1F">1F</option>
                                    <option value="2F">2F</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>パレット（棚）番号:</label>
                                <select id="palletNumberSelect">
                                    <option value="">未設定</option>
                                    <!-- パレット -->
                                    <option value="P001">P001(パレット)</option>
                                    <option value="P002">P002(パレット)</option>
                                    <option value="P003">P003(パレット)</option>
                                    <option value="P004">P004(パレット)</option>
                                    <option value="P005">P005(パレット)</option>
                                    <option value="P006">P006(パレット)</option>
                                    <option value="P007">P007(パレット)</option>
                                    <option value="P008">P008(パレット)</option>
                                    <option value="P009">P009(パレット)</option>
                                    <option value="P010">P010(パレット)</option>
                                    <!-- 台車 -->
                                    <option value="D001">D001（台車）</option>
                                    <option value="D002">D002（台車）</option>
                                    <option value="D003">D003（台車）</option>
                                    <!-- 棚 -->
                                    <option value="T001">T001(棚)</option>
                                    <option value="T002">T002(棚)</option>
                                    <option value="T003">T003(棚)</option>
                                    <option value="T004">T004(棚)</option>
                                    <option value="T005">T005(棚)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>備考:</label>
                                <textarea style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px;" id="remarksInput">${data.order.remarks || ''}</textarea>
                            </div>

                            <div class="form-group" style="margin-top: 15px;">
                                <label>📷 画像:</label>
                                <div id="imagePreviewArea" style="margin: 10px 0; text-align: center;">
                                    <img id="orderImage" src="/api/order/${orderId}/image"
                                         style="max-width: 100%; max-height: 300px; border-radius: 8px; display: none; cursor: pointer;"
                                         onclick="openImageFullscreen(this.src)"
                                         onerror="this.style.display='none'; document.getElementById('noImageText').style.display='block';"
                                         onload="this.style.display='block'; document.getElementById('noImageText').style.display='none';">
                                    <p id="noImageText" style="color: #888; font-style: italic;">画像なし</p>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                                        📤 画像をアップロード
                                        <input type="file" id="imageUpload" accept="image/*"
                                               style="display: none;" onchange="uploadOrderImage(${orderId})">
                                    </label>
                                    <button class="btn" style="background: #dc3545; color: white;" onclick="deleteOrderImage(${orderId})">🗑️ 画像を削除</button>
                                </div>
                                <p style="font-size: 0.8em; color: #888; margin-top: 5px;">※FullHD (1920x1080) に自動圧縮されます</p>
                            </div>

                            <!-- 🔥 自動保存インジケーター -->
                            <div id="autoSaveIndicator" style="text-align: center; padding: 10px; color: #28a745; font-size: 0.9em; display: none;">
                                ✅ 自動保存済み
                            </div>

                            <h3>詳細リスト</h3>
                            <table class="detail-table">
                                <thead>
                                    <tr>
                                        <th>受入</th>
                                        <th>検収日</th>
                                        <th>検収数</th>
                                        <th>納期</th>
                                        <th>回答納期</th>
                                        <th>仕入先</th>
                                        <th>発注番号</th>
                                        <th>数量</th>
                                        <th>品名</th>
                                        <th>仕様１</th>
                                        <th>仕様２</th>
                                        <th>手配区分</th>
                                        <th>備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        // 🔥 親子階層表示を使用
                        detailsHtml += displayOrderDetails(data.details);
                        
                        detailsHtml += `
                                </tbody>
                            </table>
                        `;
                        
                        document.getElementById('modalBody').innerHTML = detailsHtml;
                        document.getElementById('detailModal').classList.add('show');

                        // Set current values
                        document.getElementById('statusSelect').value = data.order.status;
                        document.getElementById('floorSelect').value = data.order.floor || '';
                        document.getElementById('palletNumberSelect').value = data.order.pallet_number || '';

                        // 🔥 CADリンクにイベントリスナーを追加
                        document.querySelectorAll('.cad-link').forEach(function(link) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const detailId = this.getAttribute('data-detail-id');
                                openCadFile(detailId);
                            });
                        });

                        // 🔥 自動保存イベントリスナーを追加
                        setupAutoSaveListeners();
                    } catch (error) {
                        alert('詳細取得エラー: ' + error);
                    }
                }

                // 🔥 自動保存用変数
                let modalRemarksTimeout = null;

                // 🔥 自動保存イベントリスナー設定関数
                function setupAutoSaveListeners() {
                    // ステータスの変更時に自動保存
                    document.getElementById('statusSelect').addEventListener('change', function() {
                        autoSaveModal();
                    });

                    // 場所の変更時に自動保存
                    document.getElementById('floorSelect').addEventListener('change', function() {
                        autoSaveModal();
                    });

                    // パレット番号の変更時に自動保存
                    document.getElementById('palletNumberSelect').addEventListener('change', function() {
                        autoSaveModal();
                    });

                    // 備考の変更時に自動保存（debounce）
                    document.getElementById('remarksInput').addEventListener('input', function() {
                        clearTimeout(modalRemarksTimeout);
                        modalRemarksTimeout = setTimeout(function() {
                            autoSaveModal();
                        }, 1000);  // 1秒後に保存
                    });
                }

                // 🔥 モーダル用自動保存関数
                async function autoSaveModal() {
                    const status = document.getElementById('statusSelect').value;
                    const remarks = document.getElementById('remarksInput').value;
                    const floor = document.getElementById('floorSelect').value;
                    const palletNumber = document.getElementById('palletNumberSelect').value;

                    try {
                        const response = await fetch(`/api/order/${currentOrderId}/update`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                status: status,
                                remarks: remarks,
                                floor: floor,
                                pallet_number: palletNumber
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // 🔥 納品完了になった場合はメール送信確認
                            if (data.show_email_prompt) {
                                const orderInfo = data.order_info;

                                // 確認ダイアログ表示
                                const confirmMessage = `ステータスを「納品完了」に更新しました。\n\n` +
                                    `製番: ${orderInfo.seiban}\n` +
                                    `品名: ${orderInfo.product_name}\n` +
                                    `場所: ${orderInfo.floor || '未設定'} ${orderInfo.pallet_number || ''}\n\n` +
                                    `納品完了メールを作成しますか？`;

                                if (confirm(confirmMessage)) {
                                    // メール作成APIを呼び出し
                                    const emailResponse = await fetch(`/api/order/${currentOrderId}/send-completion-email`, {
                                        method: 'POST'
                                    });

                                    const emailData = await emailResponse.json();

                                    if (emailData.success) {
                                        showToast('✉️ メーラーを起動しました', 'success');
                                    } else {
                                        showToast('❌ メーラー起動エラー: ' + emailData.error, 'error');
                                    }
                                }
                            }

                            // 自動保存インジケーター表示
                            const indicator = document.getElementById('autoSaveIndicator');
                            if (indicator) {
                                indicator.style.display = 'block';
                                setTimeout(function() {
                                    indicator.style.display = 'none';
                                }, 2000);
                            }

                            // 受注リストを更新
                            loadOrders();
                        } else {
                            showToast('❌ 自動保存エラー: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showToast('❌ 自動保存エラー: ' + error, 'error');
                    }
                }

                // 親子階層表示関数
                function displayOrderDetails(details) {
                    let html = '';
                    const escapeHtml = (str) => (str || '').replace(/'/g, "\\'");
                    const parentItems = details.filter(d => !d.parent_id);

                    // 🔥 仕様1のCADリンク表示を生成する関数
                    const getSpec1Html = (detail) => {
                        const spec1 = detail.spec1 || '-';
                        if (!detail.cad_info) {
                            return spec1;
                        }

                        let fileInfo = '';
                        let warningText = '';

                        if (detail.cad_info.has_pdf) {
                            fileInfo = `📄 PDF有 (${detail.cad_info.pdf_count}件)`;
                        } else if (detail.cad_info.has_mx2) {
                            fileInfo = `🔧 mx2のみ (${detail.cad_info.mx2_count}件)`;
                            warningText = '<div style="font-size: 0.75em; color: #856404;">⚠️ iCAD MX導入PCのみ</div>';
                        }

                        return `
                            <a href="#" class="cad-link" data-detail-id="${detail.id}"
                               style="color: #007bff; text-decoration: underline; cursor: pointer;">
                                ${spec1}
                            </a>
                            <div style="font-size: 0.8em; color: ${detail.cad_info.has_pdf ? '#28a745' : '#856404'}; margin-top: 3px;">
                                ${fileInfo}
                                ${warningText}
                            </div>
                        `;
                    };

                    parentItems.forEach(parent => {
                        const parentDeliveryQty = parent.received_delivery_qty ? Math.floor(parent.received_delivery_qty) : '';
                        html += `
                            <tr class="${parent.is_received ? 'received' : ''}">
                                <td>
                                    ${parent.is_received ?
                                        `<span style="color: green;">✅ 受入済</span>
                                        <button class="btn btn-sm btn-warning" onclick="toggleReceiveStatus(${parent.id}, false, '${escapeHtml(parent.order_number)}', '${escapeHtml(parent.spec1)}', '${escapeHtml(parent.item_name)}', '${parent.quantity || ''} ${parent.unit_measure || ''}')">取消</button>` :
                                        `<button class="btn btn-secondary" onclick="toggleReceiveStatus(${parent.id}, true, '${escapeHtml(parent.order_number)}', '${escapeHtml(parent.spec1)}', '${escapeHtml(parent.item_name)}', '${parent.quantity || ''} ${parent.unit_measure || ''}')">受入</button>`
                                    }
                                    ${parent.has_internal_processing ? '<span class="badge badge-warning">追加工有</span>' : ''}
                                </td>
                                <td style="color: ${parent.received_delivery_date ? '#2196f3' : '#999'};">${parent.received_delivery_date || '-'}</td>
                                <td style="color: ${parentDeliveryQty ? '#2196f3' : '#999'};">${parentDeliveryQty || '-'}</td>
                                <td>${parent.delivery_date || '-'}</td>
                                <td style="color: ${parent.reply_delivery_date ? '#d32f2f' : '#ccc'}; font-weight: ${parent.reply_delivery_date ? 'bold' : 'normal'};">${parent.reply_delivery_date || '-'}</td>
                                <td>${parent.supplier || '-'}</td>
                                <td>${parent.order_number || '-'}</td>
                                <td>${parent.quantity || ''} ${parent.unit_measure || ''}</td>
                                <td>${parent.item_name || '-'}</td>
                                <td>${getSpec1Html(parent)}</td>
                                <td>${parent.spec2 || '-'}</td>
                                <td>${parent.order_type || '-'}</td>
                                <td>${parent.remarks || '-'}</td>
                            </tr>
                        `;

                        const children = details.filter(d => d.parent_id === parent.id);
                        children.forEach(child => {
                            const childDeliveryQty = child.received_delivery_qty ? Math.floor(child.received_delivery_qty) : '';
                            html += `
                                <tr class="${child.is_received ? 'received' : ''}" style="background: #f0f0f0;">
                                    <td>
                                        ${child.is_received ?
                                            `<span style="color: green;">✅ 受入済</span>
                                            <button class="btn btn-sm btn-warning" onclick="toggleReceiveStatus(${child.id}, false, '${escapeHtml(child.order_number)}', '${escapeHtml(child.spec1)}', '${escapeHtml(child.item_name)}', '${child.quantity || ''} ${child.unit_measure || ''}')">取消</button>` :
                                            `<button class="btn btn-secondary" onclick="toggleReceiveStatus(${child.id}, true, '${escapeHtml(child.order_number)}', '${escapeHtml(child.spec1)}', '${escapeHtml(child.item_name)}', '${child.quantity || ''} ${child.unit_measure || ''}')">受入</button>`
                                        }
                                    </td>
                                    <td style="color: ${child.received_delivery_date ? '#2196f3' : '#999'};">${child.received_delivery_date || '-'}</td>
                                    <td style="color: ${childDeliveryQty ? '#2196f3' : '#999'};">${childDeliveryQty || '-'}</td>
                                    <td>${child.delivery_date || '-'}</td>
                                    <td style="color: ${child.reply_delivery_date ? '#d32f2f' : '#ccc'}; font-weight: ${child.reply_delivery_date ? 'bold' : 'normal'};">${child.reply_delivery_date || '-'}</td>
                                    <td>${child.supplier || '-'}</td>
                                    <td>${child.order_number || '-'}</td>
                                    <td>${child.quantity || ''} ${child.unit_measure || ''}</td>
                                    <td style="padding-left: 30px;">└─ ${child.item_name || '-'}</td>
                                    <td>${getSpec1Html(child)}</td>
                                    <td>${child.spec2 || '-'}</td>
                                    <td>${child.order_type || '-'}</td>
                                    <td>${child.remarks || '-'}</td>
                                </tr>
                            `;
                        });
                    });

                    return html;
                }

                // 🔥 CADファイルを開く関数
                async function openCadFile(detailId) {
                    try {
                        const response = await fetch('/api/open-cad/' + detailId);

                        // JSONレスポンスの場合（ローカルで直接起動した場合）
                        if (response.headers.get('content-type')?.includes('application/json')) {
                            const data = await response.json();

                            if (data.success) {
                                if (data.opened_locally) {
                                    showToast('🔧 ' + data.message + ': ' + data.file_name, 'success');
                                } else {
                                    showToast('📄 ' + data.message, 'success');
                                }
                            } else {
                                showToast('❌ ' + data.error, 'error');
                            }
                        } else {
                            // ファイルダウンロード/表示の場合
                            const contentType = response.headers.get('content-type');

                            if (contentType.includes('application/pdf')) {
                                // PDFは新しいタブで開く
                                const url = `/api/open-cad/${detailId}`;
                                window.open(url, '_blank');
                                showToast('📄 PDF図面を開きました', 'success');
                            } else {
                                // MX2ファイルをダウンロード
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = response.headers.get('content-disposition')?.split('filename=')[1] || 'file.mx2';
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                window.URL.revokeObjectURL(url);
                                showToast('💾 MX2ファイルをダウンロードしました', 'info');
                            }
                        }
                    } catch (error) {
                        showToast('❌ CADファイルの取得に失敗しました: ' + error.message, 'error');
                        console.error('CADファイルエラー:', error);
                    }
                }

                // 受入状態をトグルする関数
                async function toggleReceiveStatus(detailId, setReceived, orderNumber, spec1, itemName, quantity) {
                    const action = setReceived ? '受入' : '受入取消';
                    
                    // 確認メッセージを作成
                    const confirmMessage = `このアイテムを${action}しますか？\n\n` +
                                        `発注番号: ${orderNumber || '未設定'}\n` +
                                        `品名: ${itemName || '未設定'}\n` +
                                        `仕様１: ${spec1 || '未設定'}\n` +
                                        `数量: ${quantity || '未設定'}`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/detail/${detailId}/toggle-receive`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ is_received: setReceived })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // 詳細なメッセージを表示
                            const toastMessage = data.message + 
                                                `\n発注番号: ${orderNumber || '未設定'}` +
                                                `\n仕様１: ${spec1 || '未設定'}`;
                            showToast(toastMessage, data.has_internal_processing ? 'warning' : 'success', 5000);
                            
                            showOrderDetails(currentOrderId);
                            loadOrders();
                            
                            // 入荷管理タブが開いている場合は統計も更新
                            if (document.getElementById('receiving-tab').classList.contains('active')) {
                                loadPurchaseOrderStats();
                            }
                        } else {
                            showToast('エラー: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showToast(`${action}エラー: ` + error, 'error');
                    }
                }

            async function updateOrder() {
                const status = document.getElementById('statusSelect').value;
                const remarks = document.getElementById('remarksInput').value;
                const floor = document.getElementById('floorSelect').value;
                const palletNumber = document.getElementById('palletNumberSelect').value;
                
                try {
                    const response = await fetch(`/api/order/${currentOrderId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: status,
                            remarks: remarks,
                            floor: floor,
                            pallet_number: palletNumber
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // 🔥 納品完了になった場合はメール送信確認
                        if (data.show_email_prompt) {
                            const orderInfo = data.order_info;
                            
                            // 確認ダイアログ表示
                            const confirmMessage = `ステータスを「納品完了」に更新しました。\n\n` +
                                `製番: ${orderInfo.seiban}\n` +
                                `品名: ${orderInfo.product_name}\n` +
                                `場所: ${orderInfo.floor || '未設定'} ${orderInfo.pallet_number || ''}\n\n` +
                                `納品完了メールを作成しますか？`;
                            
                            if (confirm(confirmMessage)) {
                                // メール作成APIを呼び出し
                                const emailResponse = await fetch(`/api/order/${currentOrderId}/send-completion-email`, {
                                    method: 'POST'
                                });
                                
                                const emailData = await emailResponse.json();
                                
                                if (emailData.success) {
                                    showToast('✉️ メーラーを起動しました', 'success');
                                } else {
                                    showToast('❌ メーラー起動エラー: ' + emailData.error, 'error');
                                }
                            }
                        } else {
                            showToast(data.message, 'success');
                        }
                        
                        loadOrders();
                        closeModal();
                    } else {
                        showToast('エラー: ' + data.error, 'error');
                    }
                } catch (error) {
                    showToast('更新エラー: ' + error, 'error');
                }
            }

        async function receiveItem(detailId) {
            try {
                const response = await fetch(`/api/detail/${detailId}/receive`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    showOrderDetails(currentOrderId);
                    loadOrders();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('受入エラー: ' + error);
            }
        }

        async function exportOrder(orderId) {
            window.location.href = `/api/export/${orderId}`;
        }

        async function deleteOrder(orderId) {
            if (!confirm('この注文を削除してもよろしいですか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/delete`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadOrders();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('削除エラー: ' + error);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // 画像アップロード
        async function uploadOrderImage(orderId) {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];

            if (!file) {
                alert('ファイルを選択してください');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`/api/order/${orderId}/upload-image`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('画像をアップロードしました', 'success');
                    // 画像を再読み込み
                    const img = document.getElementById('orderImage');
                    img.src = `/api/order/${orderId}/image?t=${Date.now()}`;
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('アップロードエラー: ' + error);
            }

            // ファイル選択をリセット
            fileInput.value = '';
        }

        // 画像削除
        async function deleteOrderImage(orderId) {
            if (!confirm('画像を削除しますか？')) {
                return;
            }

            try {
                const response = await fetch(`/api/order/${orderId}/delete-image`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('画像を削除しました', 'success');
                    document.getElementById('orderImage').style.display = 'none';
                    document.getElementById('noImageText').style.display = 'block';
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('削除エラー: ' + error);
            }
        }

        // 画像をフルスクリーンで表示
        function openImageFullscreen(src) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                object-fit: contain;
            `;

            overlay.appendChild(img);
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }

        function updateReceivingList(orders) {
            const receivingList = document.getElementById('receivingList');
            let html = '<h3>未受入リスト</h3>';

            // 配列でない場合は早期リターン
            if (!Array.isArray(orders)) {
                console.error('Invalid orders for receiving list:', orders);
                receivingList.innerHTML = html;
                return;
            }

            orders.forEach(order => {
                if (order.status !== '納品完了') {
                    html += `
                        <div class="order-card" onclick="showOrderDetails(${order.id})">
                            <p><strong>${order.seiban} - ${order.unit}</strong></p>
                            <p>進捗: ${order.received_count}/${order.detail_count}</p>
                            ${order.has_internal_processing ? '<span class="internal-processing-warning">⚠️ 追加工有</span>' : ''}
                        </div>
                    `;
                }
            });
            
            receivingList.innerHTML = html;
        }

        async function processReceiving() {
            const qrInput = document.getElementById('qrInput').value;
            
            if (!qrInput) {
                alert('QRコードまたは注文番号を入力してください');
                return;
            }
            
            // Extract order ID from QR code or direct input
            let orderId = qrInput;
            if (qrInput.startsWith('ORDER:')) {
                orderId = qrInput.replace('ORDER:', '');
            }
            
            showOrderDetails(parseInt(orderId));
            document.getElementById('qrInput').value = '';
        }

        async function importHistory(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import-history', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadHistoryData();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('インポートエラー: ' + error);
            }
        }

    function runBatchFile() {
        const batPath = "C:\\Users\\t.maruyama\\refresh_order.bat";
        const infoDiv = document.getElementById("networkFileInfo");
        infoDiv.textContent = "バッチファイル実行中 ...";
        fetch('/execute-batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: batPath })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                infoDiv.innerHTML = `<span style="color:green">バッチファイル実行成功！</span><br>出力:<br><pre>${data.output}</pre>`;
            } else {
                infoDiv.innerHTML = `<span style="color:red">失敗: ${data.error}</span>`;
            }
        })
        .catch(error => {
            console.error(error);
            infoDiv.innerHTML = "<span style='color:red'>通信エラーで実行できませんでした</span>";
        });
    }
        async function loadHistoryData() {
            // 履歴データを自動読み込み
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="loading"><div class="spinner"></div><p>読み込み中...</p></div>';
            
            try {
                const response = await fetch('/api/load-history');
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <h3>発行履歴 (${data.total}件)</h3>
                        <div style="max-height: 600px; overflow-y: auto;">
                            <table class="detail-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>発行日</th>
                                        <th>ファイル名</th>
                                        <th>製番</th>
                                        <th>容量(KB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.no}</td>
                                <td>${item.issue_date}</td>
                                <td>${item.filename}</td>
                                <td><strong>${item.seiban}</strong></td>
                                <td>${item.size_kb}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    historyList.innerHTML = html;
                } else {
                    historyList.innerHTML = `
                        <div class="alert alert-warning">
                            エラー: ${data.error}<br>
                            履歴ファイルが読み込めません。ネットワーク接続を確認してください。
                        </div>
                    `;
                }
            } catch (error) {
                historyList.innerHTML = `
                    <div class="alert alert-danger">
                        読み込みエラー: ${error}<br>
                        ネットワークファイルにアクセスできません。
                    </div>
                `;
            }
        }
    </script>
</body>
</html>