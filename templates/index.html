<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹é…ç™ºæ³¨ãƒãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="/static/styles.css">
    <!-- ğŸ”¥ Html5Qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆQRã‚³ãƒ¼ãƒ‰ãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä¸¡å¯¾å¿œï¼‰ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- ğŸ”¥ Chart.jsè¿½åŠ  -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- ğŸ”¥ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ  -->
    <script src="/static/gantt-chart.js"></script>
    <script src="/static/qr-scanner.js"></script>
    <script src="/static/pallet-manager.js"></script>
    <script src="/static/delivery-schedule.js"></script>
    <script src="/static/across-db.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ‰‹é…ç™ºæ³¨ãƒãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Excelå‡¦ç†ãƒ»å…¥è·ç®¡ç†ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½è·¡</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('orders')">ğŸ“‹ å—æ³¨ãƒªã‚¹ãƒˆ</button>
            <button class="nav-tab" onclick="switchTab('upload')">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿å‡¦ç†</button>
            <button class="nav-tab" onclick="switchTab('receiving')">ğŸ“¦ å…¥è·ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('pallets')">ğŸ¢ ãƒ¦ãƒ‹ãƒƒãƒˆä¿ç®¡å ´æ‰€</button>
            <button class="nav-tab" onclick="switchTab('archive')">ğŸ—„ï¸ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
            <button class="nav-tab" onclick="switchTab('history')">ğŸ“Š ç™ºè¡Œå±¥æ­´</button>
        </div>
        
        <div class="content">
            <!-- å—æ³¨ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
            <div id="orders-tab" class="tab-content active">
                <h2>å—æ³¨ãƒªã‚¹ãƒˆ</h2>

                <!-- ğŸ”¥ ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¿½åŠ  -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <h3 style="margin: 0;">ğŸ“Š ç´æœŸã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h3>
                        <button class="btn btn-info btn-sm" onclick="toggleGanttChart()">
                            <span id="ganttToggleIcon">ğŸ“ˆ</span> <span id="ganttToggleText">è¡¨ç¤º</span>
                        </button>
                    </div>
                    
                    <!-- ğŸ”¥ è£½ç•ªãƒ•ã‚£ãƒ«ã‚¿UI -->
                    <div id="ganttFilterContainer" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¨­å®š -->
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px; flex-wrap: wrap;">
                            <strong>âš™ è¡¨ç¤ºè¨­å®š:</strong>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="margin: 0; font-size: 0.9em;">æœŸé–“:</label>
                                <select id="ganttSpanSelect" onchange="applyGanttOptions()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    <option value="1">1ãƒ¶æœˆ</option>
                                    <option value="3" selected>3ãƒ¶æœˆ</option>
                                    <option value="6">6ãƒ¶æœˆ</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="margin: 0; font-size: 0.9em;">ä»Šæ—¥ã®ä½ç½®:</label>
                                <select id="ganttTodayPosition" onchange="onGanttPositionChange()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    <option value="center">ä¸­å¤®ï¼ˆå‰å¾Œå‡ç­‰ï¼‰</option>
                                    <option value="right">å³ç«¯ï¼ˆéå»ãƒ¡ã‚¤ãƒ³ï¼‰</option>
                                    <option value="left">å·¦ç«¯ï¼ˆæœªæ¥ãƒ¡ã‚¤ãƒ³ï¼‰</option>
                                    <option value="custom">æ—¥ä»˜æŒ‡å®š</option>
                                </select>
                            </div>
                            <div id="ganttCustomDateContainer" style="display: none; align-items: center; gap: 5px;">
                                <label style="margin: 0; font-size: 0.9em;">é–‹å§‹æ—¥:</label>
                                <input type="date" id="ganttCustomStartDate" onchange="applyGanttOptions()" style="padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc;">
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="printGanttChart()" style="margin-left: auto; border: 1px solid #6c757d; background: white; padding: 4px 12px;">ğŸ–¨ å°åˆ·</button>
                        </div>
                        <hr style="margin: 8px 0; border-color: #dee2e6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <strong>ğŸ” è£½ç•ªãƒ•ã‚£ãƒ«ã‚¿:</strong>
                            <button class="btn btn-sm btn-primary" onclick="selectAllSeibansForGantt()">å…¨ã¦é¸æŠ</button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAllSeibansForGantt()">å…¨ã¦è§£é™¤</button>
                            <button class="btn btn-sm btn-success" onclick="applyGanttFilter()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
                            <span id="ganttFilterCount" style="color: #6c757d; margin-left: auto;"></span>
                        </div>
                        <div id="ganttSeibanList" style="max-height: 150px; overflow-y: auto; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 5px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                    <div id="ganttLoadingOverlay" style="display: none; background: rgba(255, 255, 255, 0.95); position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; border-radius: 10px;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                            <div id="ganttLoadingMessage" style="font-size: 1.2em; font-weight: bold; color: #667eea; margin-bottom: 15px;">
                                ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
                            </div>
                            <div style="width: 80%; max-width: 400px; background: #e9ecef; border-radius: 20px; overflow: hidden; height: 30px; margin-bottom: 10px;">
                                <div id="ganttLoadingBar" style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                    <span id="ganttLoadingPercent" style="color: white; font-weight: bold; font-size: 0.9em;"></span>
                                </div>
                            </div>
                            <div id="ganttLoadingDetail" style="font-size: 0.9em; color: #6c757d; text-align: center;">
                                æº–å‚™ä¸­...
                            </div>
                        </div>
                    </div>
                    
                    <div id="ganttChartContainer" style="display: none; position: relative; height: 400px; overflow-y: auto;">
                        <canvas id="ganttChart"></canvas>
                    </div>
                </div>
                                
                <div class="form-group">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="searchInput" placeholder="è£½ç•ªãƒ»ãƒ¦ãƒ‹ãƒƒãƒˆåãƒ»å®¢å…ˆåãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æ¤œç´¢..." onkeyup="filterOrders()" style="flex:1; min-width:200px;">
                        <div class="view-toggle-bar" style="margin-bottom:0;">
                            <button class="btn btn-sm active" id="btnCardView" onclick="setViewMode('card')" title="ã‚«ãƒ¼ãƒ‰è¡¨ç¤º">&#9638; ã‚«ãƒ¼ãƒ‰</button>
                            <button class="btn btn-sm" id="btnTableView" onclick="setViewMode('table')" title="ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º">&#9776; ãƒ†ãƒ¼ãƒ–ãƒ«</button>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="deleteMultipleBtn" style="margin-top: 10px;">é¸æŠã—ãŸè£½ç•ªã‚’ä¸€æ‹¬å‰Šé™¤</button>
                </div>
                <div id="orderGrid" class="order-grid"></div>
            </div>

        
            <!-- ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¿ãƒ– -->
            <div id="upload-tab" class="tab-content">
                <!-- ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div id="systemStatus" class="alert alert-info" style="display: none;">
                    <h4>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
                    <p id="statusMessage"></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="statusProgress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="upload-section" style="background: #e8f4f8;">
                    <h2>ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•èª­ã¿è¾¼ã¿</h2>
                    <p>æ—¢å®šã®ãƒ•ã‚¡ã‚¤ãƒ«: \\server3\Share-data\Document\ä»•å…¥ã‚Œ\002_æ‰‹é…ãƒªã‚¹ãƒˆ\æ‰‹é…ç™ºæ³¨_ALL.xlsx</p>
                    <button class="btn btn-primary" onclick="loadNetworkFile()">
                        ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«å†èª­è¾¼
                    </button>
                    <button class="btn btn-warning" onclick="refreshExcelFile()" style="margin-left: 10px;">
                        ğŸ“Š Excelæ›´æ–°
                    </button>
                    <button class="btn btn-warning" onclick="runRefreshScript()" style="margin-left: 10px;">
                        ğŸ”„ æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
                    </button>
                    <button class="btn btn-warning" onclick="loadFromODBC()" style="margin-left: 10px;">
                        ODBCã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€
                    </button>
                    <button class="btn btn-info" onclick="debugPaths()" style="margin-left: 10px;">
                        ğŸ” æ¥ç¶šè¨ºæ–­
                    </button>
                    <div id="networkFileInfo" style="margin-top: 10px;"></div>
                </div>

                    <!-- ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ  -->
                    <div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <label style="margin-bottom: 10px; display: block; cursor: pointer;">
                            <input type="checkbox" id="enableOrderDateFilter" onchange="toggleOrderDateFilter()" 
                                style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle; cursor: pointer;">
                            <strong style="vertical-align: middle; font-size: 1.1em;">ğŸ“… ç™ºæ³¨æ—¥ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæœŸé–“æŒ‡å®šï¼‰</strong>
                        </label>
                        <div id="orderDateFilterInput" style="display: none; margin-top: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1;">
                                    <label>é–‹å§‹æ—¥ï¼ˆã“ã®æ—¥ä»˜ä»¥é™ï¼‰:</label>
                                    <input type="date" id="orderDateFrom" style="width: 100%; padding: 8px;">
                                </div>
                                <div style="padding-top: 20px;">ã€œ</div>
                                <div style="flex: 1;">
                                    <label>çµ‚äº†æ—¥ï¼ˆã“ã®æ—¥ä»˜ã¾ã§ï¼‰:</label>
                                    <input type="date" id="orderDateTo" style="width: 100%; padding: 8px;">
                                </div>
                            </div>
                            <small style="color: #856404; display: block; margin-top: 5px;">
                                ğŸ’¡ æŒ‡å®šæœŸé–“å†…ã«ç™ºæ³¨ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆçµ‚äº†æ—¥ã‚’ç©ºæ¬„ã«ã™ã‚‹ã¨é–‹å§‹æ—¥ä»¥é™ã™ã¹ã¦ï¼‰
                            </small>
                        </div>
                    </div>
                    <!-- å‡¦ç†ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                    <div class="form-group">
                        <label>å‡¦ç†ãƒ¢ãƒ¼ãƒ‰:</label>
                        <select id="processingMode" onchange="toggleProcessingMode()">
                            <option value="single">å˜ä¸€è£½ç•ªå‡¦ç†</option>
                            <option value="auto">è‡ªå‹•æ¤œå‡ºãƒ»ä¸€æ‹¬å‡¦ç†</option>
                        </select>
                    </div>
                    
                    <!-- å˜ä¸€è£½ç•ªå…¥åŠ› -->
                    <div id="singleModeInput">
                        <div class="form-group">
                            <label>è£½ç•ª (ä¸€è¦§ã‹ã‚‰é¸æŠ ã¾ãŸã¯ æ‰‹å‹•å…¥åŠ›):</label>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                                <input type="text" id="seibanFilterInput" placeholder="çµã‚Šè¾¼ã¿ï¼ˆä¾‹: MHT0620ï¼‰" oninput="filterSeibanCheckboxes()" style="flex: 1; padding: 6px 8px;">
                                <button class="btn btn-secondary" onclick="loadSeibanList()" style="white-space: nowrap; padding: 8px 12px;">ä¸€è¦§å–å¾—</button>
                            </div>
                            <div id="seibanCheckboxList" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 5px; margin-bottom: 6px; background: #fff;">
                            </div>
                            <div id="seibanBatchActions" style="display: none; margin-bottom: 8px;">
                                <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                    <button class="btn btn-sm btn-primary" onclick="selectAllSeibanCheckboxes()">å…¨é¸æŠ</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deselectAllSeibanCheckboxes()">å…¨è§£é™¤</button>
                                    <span id="seibanCheckCount" style="color: #666; font-size: 0.85em; margin-left: 5px;"></span>
                                    <button class="btn btn-success" onclick="processBatchSeibans()" style="margin-left: auto; padding: 6px 16px;">ä¸€æ‹¬å‡¦ç†</button>
                                    <button class="btn btn-success" onclick="processBatchSeibansFromDB()" style="padding: 6px 16px; background: #7b1fa2;">ğŸ—„ï¸ DBç›´æ¥ä¸€æ‹¬å‡¦ç†</button>
                                </div>
                            </div>
                            <input type="text" id="seibanInput" placeholder="MHT0123ï¼ˆæ‰‹å‹•å…¥åŠ›ã‚‚å¯ï¼‰" style="margin-top: 4px;">
                            <small style="color: #666;">ä¸€è¦§ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦ä¸€æ‹¬å‡¦ç†ã€ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›ã§å˜ä½“å‡¦ç†</small>
                        </div>
                        <button class="btn btn-primary" onclick="processFile()">å‡¦ç†é–‹å§‹ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</button>
                        <button class="btn btn-primary" onclick="processFileFromDB()" style="margin-left: 8px; background: #7b1fa2;">ğŸ—„ï¸ DBç›´æ¥å‡¦ç†</button>
                        <div id="batchProgressContainer" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="margin-bottom: 8px;"><strong id="batchProgressTitle">ä¸€æ‹¬å‡¦ç†ä¸­...</strong></div>
                            <div style="background: #e9ecef; border-radius: 10px; overflow: hidden; height: 24px; margin-bottom: 8px;">
                                <div id="batchProgressBar" style="height: 100%; background: linear-gradient(135deg, #28a745, #20c997); width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                    <span id="batchProgressPercent" style="color: white; font-weight: bold; font-size: 0.85em;"></span>
                                </div>
                            </div>
                            <div id="batchProgressLog" style="font-size: 0.85em; color: #555; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <!-- è‡ªå‹•æ¤œå‡ºãƒ¢ãƒ¼ãƒ‰ -->
                    <div id="autoModeInput" style="display: none;">
                        <div class="form-group">
                            <label>æœ€å°è£½ç•ª (ã“ã®ç•ªå·ä»¥é™ã‚’å‡¦ç†):</label>
                            <input type="text" id="minSeibanInput" placeholder="MHT0600" value="MHT0600">
                        </div>
                        <button class="btn btn-primary" onclick="detectAndProcess()">è£½ç•ªã‚’æ¤œå‡º</button>
                        
                        <div id="detectedSeibans" style="margin-top: 20px; display: none;">
                            <h4>æ¤œå‡ºã•ã‚ŒãŸè£½ç•ª</h4>
                            <div id="seibanList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-success" onclick="processSelectedSeibans()">é¸æŠã—ãŸè£½ç•ªã‚’å‡¦ç†</button>
                                <button class="btn btn-primary" onclick="selectAllSeibans()">å…¨ã¦é¸æŠ</button>
                                <button class="btn btn-secondary" onclick="deselectAllSeibans()">å…¨ã¦è§£é™¤</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‡¦ç†é€²æ— -->
                    <div id="batchProgress" style="display: none; margin-top: 20px;">
                        <h4>å‡¦ç†é€²æ—</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="batchProgressBar" style="width: 0%"></div>
                        </div>
                        <p id="batchProgressText">0 / 0 å®Œäº†</p>
                        <div id="batchResults" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                        </div>
                    </div>

                    <!-- ã‚·ãƒ¼ãƒˆé¸æŠ -->
                    <div class="form-group">
                        <label>æ‰‹é…ãƒªã‚¹ãƒˆã®ã‚·ãƒ¼ãƒˆ:</label>
                        <select id="sheet1Select"></select>
                    </div>
                    <div class="form-group">
                        <label>ç™ºæ³¨ãƒªã‚¹ãƒˆã®ã‚·ãƒ¼ãƒˆ:</label>
                        <select id="sheet2Select"></select>
                    </div>

                    <div id="sheetSelection" style="display: none;">
                        <h3>ã‚·ãƒ¼ãƒˆé¸æŠ</h3>

                    </div>

                    <div class="loading" id="loadingIndicator">
                        <div class="spinner"></div>
                        <p>å‡¦ç†ä¸­...</p>
                    </div>

                    <!-- Across DB ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="upload-section" style="background: #f3e5f5; border: 2px solid #ce93d8;">
                        <h2>ğŸ—„ï¸ Across DB ãƒ†ã‚¹ãƒˆ</h2>
                        <p style="color: #666; font-size: 0.9em;">V_Dç³»ãƒ“ãƒ¥ãƒ¼ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ã«ç›´æ¥ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™</p>

                        <!-- æ¥ç¶šãƒ†ã‚¹ãƒˆ -->
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-info" onclick="testAcrossConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                            <span id="acrossTestResult" style="margin-left: 10px;"></span>
                        </div>

                        <!-- ã‚¯ã‚¤ãƒƒã‚¯ç™ºæ³¨ç•ªå·æ¤œç´¢ -->
                        <div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <h3 style="margin-top:0; font-size:1em;">ğŸ” ç™ºæ³¨ç•ªå·ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="acrossQuickOrderInput" placeholder="ç™ºæ³¨ç•ªå·ï¼ˆä¾‹: 89074ï¼‰" style="flex:1; padding:8px;">
                                <button class="btn btn-primary" onclick="quickSearchOrder()">æ¤œç´¢</button>
                            </div>
                            <small style="color:#888;">è‡ªå‹•ã§8æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¾ã™</small>
                            <div id="acrossQuickResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- ãƒãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ -->
                        <div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <h3 style="margin-top:0; font-size:1em;">ğŸ”„ è£½ç•ªãƒãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ</h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">V_Dæ‰‹é…ãƒªã‚¹ãƒˆ Ã— V_Dç™ºæ³¨ ã‚’ãƒãƒ¼ã‚¸ã—ã€ç¾è¡ŒExcelå‡¦ç†ã¨åŒç­‰ã®çµæœã‚’ç”Ÿæˆ</p>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="acrossMergeSeiban" placeholder="è£½ç•ªï¼ˆä¾‹: MHT0620ï¼‰" style="flex:1; padding:8px;">
                                <button class="btn btn-primary" onclick="executeMergeTest()">ãƒãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                            </div>
                            <div id="acrossMergeResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- DBæ›´æ–°ãƒã‚§ãƒƒã‚¯ -->
                        <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                            <h3 style="margin-top:0; font-size:1em;">
                                ğŸ“Š DBæ›´æ–°ãƒã‚§ãƒƒã‚¯
                                <span id="mihatchuBadge" style="display:none; background:#e91e63; color:#fff; font-size:0.75em; padding:2px 8px; border-radius:10px; margin-left:8px;"></span>
                            </h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">ç™»éŒ²æ¸ˆã¿è£½ç•ªã®æ‰‹é…ãƒªã‚¹ãƒˆãƒ»ç™ºæ³¨ãƒ»æœªç™ºæ³¨ï¼ˆç¤¾å†…åŠ å·¥å“ï¼‰ä»¶æ•°ã‚’ç¢ºèª</p>
                            <button class="btn btn-warning" onclick="checkDbUpdates()">æ›´æ–°ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>
                            <div id="dbUpdateCheckResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- ç¤¾å†…åŠ å·¥å“ æœªç™ºæ³¨æ¤œç´¢ -->
                        <div style="background: #fce4ec; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #e91e63;">
                            <h3 style="margin-top:0; font-size:1em;">ğŸ­ ç¤¾å†…åŠ å·¥å“ æœªç™ºæ³¨æ¤œç´¢</h3>
                            <p style="color:#888; font-size:0.85em; margin:0 0 8px;">V_Dæœªç™ºæ³¨ã‹ã‚‰ä»•å…¥å…ˆCD='MHT' + æ‰‹é…åŒºåˆ†CD='11' ã‚’æ¤œç´¢ï¼ˆç™ºæ³¨æ›¸ãªã—ã§å‡¦ç†ã•ã‚Œã‚‹ç¤¾å†…åŠ å·¥å“ï¼‰</p>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="acrossMihatchuSeiban" placeholder="è£½ç•ªï¼ˆä¾‹: MHT0620ï¼‰" style="flex:1; padding:8px;">
                                <button class="btn" style="background:#e91e63; color:#fff;" onclick="searchMihatchu()">æœªç™ºæ³¨æ¤œç´¢</button>
                            </div>
                            <div id="acrossMihatchuResult" style="margin-top: 10px;"></div>
                        </div>

                        <!-- ãƒ“ãƒ¥ãƒ¼è‡ªç”±æ¤œç´¢ -->
                        <div style="background: #fff; padding: 12px; border-radius: 6px;">
                            <h3 style="margin-top:0; font-size:1em;">ğŸ“‹ ãƒ“ãƒ¥ãƒ¼è‡ªç”±æ¤œç´¢</h3>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                <select id="acrossViewSelect" onchange="onAcrossViewChange()" style="padding: 8px;">
                                    <option value="V_Dç™ºæ³¨">V_Dç™ºæ³¨ï¼ˆç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ï¼‰</option>
                                    <option value="V_Dç™ºæ³¨æ®‹">V_Dç™ºæ³¨æ®‹ï¼ˆç™ºæ³¨æ®‹ãƒ»ç´å…¥çŠ¶æ³ï¼‰</option>
                                    <option value="V_Dæ‰‹é…ãƒªã‚¹ãƒˆ">V_Dæ‰‹é…ãƒªã‚¹ãƒˆï¼ˆBOMï¼‰</option>
                                    <option value="V_Dä»•å…¥">V_Dä»•å…¥ï¼ˆä»•å…¥å®Ÿç¸¾ï¼‰</option>
                                    <option value="V_Dæœªç™ºæ³¨">V_Dæœªç™ºæ³¨ï¼ˆç¤¾å†…åŠ å·¥å“å«ã‚€ï¼‰</option>
                                </select>
                                <select id="acrossSearchType" style="padding: 8px;">
                                    <option value="ç™ºæ³¨ç•ªå·">ç™ºæ³¨ç•ªå·</option>
                                    <option value="è£½ç•ª">è£½ç•ª</option>
                                    <option value="">å…¨ä»¶ï¼ˆä¸Šä½Nä»¶ï¼‰</option>
                                </select>
                                <input type="text" id="acrossSearchInput" placeholder="ä¾‹: 89074 ã¾ãŸã¯ MHT0620" style="flex:1; min-width:150px; padding:8px;">
                                <select id="acrossLimit" style="padding: 8px; width: 100px;">
                                    <option value="20">20ä»¶</option>
                                    <option value="50">50ä»¶</option>
                                    <option value="100" selected>100ä»¶</option>
                                    <option value="500">500ä»¶</option>
                                </select>
                                <button class="btn btn-success" onclick="executeAcrossQuery()">ã‚¯ã‚¨ãƒªå®Ÿè¡Œ</button>
                            </div>
                            <div id="acrossColumns" style="margin-bottom: 8px;"></div>
                            <div id="acrossQueryResult"></div>
                        </div>
                    </div>

                    <!-- æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="upload-section">
                        <h2>ğŸ“¤ æ‰‹å‹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <div id="uploadText">
                                <p style="font-size: 3em;">ğŸ“</p>
                                <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                                <p style="color: #6c757d; font-size: 0.9em;">å¯¾å¿œå½¢å¼: .xlsx, .xls (æœ€å¤§50MB)</p>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>

            </div>

            <!-- å…¥è·ç®¡ç†ã‚¿ãƒ– -->
            <div id="receiving-tab" class="tab-content">
                <h2>ğŸ“¦ å…¥è·ç®¡ç†</h2>

                <!-- ç´å“äºˆå®šè¡¨ -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: white; border: 1px solid #dee2e6; border-radius: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                        <h3 style="margin: 0;">ğŸ“… ç´å“äºˆå®š</h3>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <label style="font-size: 0.85em; color: #666; margin: 0;">é–‹å§‹æ—¥:</label>
                            <input type="date" id="deliveryStartDate" style="padding: 3px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.85em;" onchange="loadDeliverySchedule()">
                            <button class="btn btn-sm" onclick="resetDeliveryStartDate()" style="padding: 3px 10px; border: 1px solid #ced4da; background: #f8f9fa; font-size: 0.82em; border-radius: 4px; cursor: pointer;" title="ä»Šæ—¥ã«æˆ»ã™">ä»Šæ—¥</button>
                            <button class="btn btn-sm btn-primary" onclick="loadDeliverySchedule()">æ›´æ–°</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="printDeliverySchedule()" style="border: 1px solid #6c757d; background: white;">ğŸ–¨ å°åˆ·</button>
                        </div>
                    </div>
                    <div id="deliveryScheduleContent">
                        <p style="text-align: center; padding: 20px; color: #6c757d;">ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç´å“äºˆå®šã‚’èª­ã¿è¾¼ã¿ã¾ã™</p>
                    </div>
                </div>

                <!-- æ›´æ–°æƒ…å ±ï¼ˆå‚™è€ƒãƒ»ç”»åƒãŒã‚ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆä¸€è¦§ï¼‰ -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: white; border: 1px solid #dee2e6; border-radius: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <h3 style="margin: 0;">â„¹ï¸ æ›´æ–°æƒ…å ±</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="updateInfoCount" style="font-size: 0.85em; color: #666;"></span>
                            <button class="btn btn-sm btn-primary" onclick="loadUpdateInfo()">æ›´æ–°</button>
                        </div>
                    </div>
                    <div id="updateInfoContent">
                        <p style="text-align: center; padding: 15px; color: #6c757d; font-size: 0.9em;">ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã§å‚™è€ƒãƒ»ç”»åƒã®ã‚ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆã‚’è¡¨ç¤º</p>
                    </div>
                </div>

                <!-- ç™ºæ³¨ç•ªå·ã§ã®æ¤œç´¢ãƒ»å—å…¥ -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>ğŸ” ç™ºæ³¨ç•ªå·ã§æ¤œç´¢ãƒ»å—å…¥</h3>
                    <div class="form-group">
                        <label>ç™ºæ³¨ç•ªå·ã‚’å…¥åŠ›ï¼ˆQRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚‚å¯èƒ½ï¼‰:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="purchaseOrderInput" placeholder="ä¾‹: 85858 ã¾ãŸã¯ QRã‚¹ã‚­ãƒ£ãƒ³å¾ŒEnter" style="flex: 1;">
                            <button class="btn btn-primary" onclick="searchByPurchaseOrder()">æ¤œç´¢</button>
                            <button class="btn btn-success" onclick="receiveByPurchaseOrder()"title="æ¤œç´¢çµæœã®å†…å®¹ã‚’å—å…¥">æ¤œç´¢çµæœå—å…¥</button>
                            <button class="btn btn-warning" onclick="startQRScanner()" title="ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰èª­å–">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³</button>
                        </div>
                        <small style="color: #6c757d; display: block; margin-top: 5px;">
                            ğŸ’¡ QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸå¾Œã€Enterã‚­ãƒ¼ã‚’æŠ¼ã™ã¨è‡ªå‹•çš„ã«å‡¦ç†ã•ã‚Œã¾ã™
                        </small>
                    </div>
                    <div id="purchaseOrderSearchResult"></div>
                </div>

                <!-- QRã‚³ãƒ¼ãƒ‰ãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="qrScannerModal" class="modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2>ğŸ“· QR/ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
                            <button onclick="stopQRScanner()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">Ã—</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 15px;">
                            <!-- ã‚¹ã‚­ãƒ£ãƒ³ç¯„å›²åˆ‡æ›¿ -->
                            <div style="display:flex; justify-content:center; gap:6px; margin-bottom:10px;">
                                <button class="btn btn-sm" id="scanModeWide" onclick="setScanMode('wide')" style="background:#0d6efd;color:#fff;padding:4px 10px;font-size:0.85em;">åºƒåŸŸ</button>
                                <button class="btn btn-sm" id="scanModeNarrow" onclick="setScanMode('narrow')" style="padding:4px 10px;font-size:0.85em;">ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆ</button>
                                <button class="btn btn-sm" id="scanModeBarcode" onclick="setScanMode('barcode')" style="padding:4px 10px;font-size:0.85em;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</button>
                            </div>
                            <!-- Html5Qrcodeç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
                            <div id="qr-reader" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
                            <div id="qrResult" style="margin-top: 10px; font-size: 1em; min-height: 30px;"></div>
                            <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚°ï¼ˆé€£ç¶šã‚¹ã‚­ãƒ£ãƒ³çµæœï¼‰ -->
                            <div id="scanLog" style="margin-top: 8px; max-height: 150px; overflow-y: auto; text-align: left; background: #f8f9fa; border-radius: 6px;"></div>
                            <p style="margin-top: 8px; color: #6c757d; font-size: 0.85em;">
                                é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³å¯¾å¿œ - èª­ã¿å–ã‚‹ã ã‘ã§è‡ªå‹•å—å…¥<br>
                                <small>QRãŒè¿‘æ¥ã—ã¦ã„ã‚‹å ´åˆã¯ã€Œãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã€ã«åˆ‡æ›¿</small>
                            </p>
                            <button class="btn btn-danger" onclick="stopQRScanner()" style="margin-top: 10px;">
                                ã‚¹ã‚­ãƒ£ãƒ³çµ‚äº†
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å—å…¥ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="barcodeReceiveModal" class="modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header" style="background: #28a745;">
                            <h2>ğŸ“¦ å—å…¥ç¢ºèª</h2>
                            <button onclick="closeBarcodeReceiveModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">Ã—</button>
                        </div>
                        <div class="modal-body" id="barcodeReceiveModalBody" style="padding: 20px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- ä»•æ§˜ï¼‘ã§ã®æ¤œç´¢ -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: #e8f4ff; border-radius: 10px;">
                    <h3>ğŸ” ä»•æ§˜ï¼‘ï¼ˆå‹ç•ªï¼‰ã§æ¤œç´¢</h3>
                    <div class="form-group">
                        <label>ä»•æ§˜ï¼‘ã‚’å…¥åŠ›:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="spec1Input" placeholder="ä¾‹: MVBLK-SSM-3RP-GDKZG" style="flex: 1;">
                            <button class="btn btn-primary" onclick="searchBySpec1()">æ¤œç´¢</button>
                        </div>
                    </div>
                    <div id="spec1SearchResult"></div>
                </div>
                
                <!-- ç™ºæ³¨ç•ªå·çµ±è¨ˆ -->
                <div class="card" style="margin-bottom: 20px; padding: 20px; background: #e8f4f8; border-radius: 10px;">
                    <h3>ğŸ“Š ç™ºæ³¨ç•ªå·åˆ¥é€²æ—</h3>
                    <button class="btn btn-primary" onclick="loadPurchaseOrderStats()">çµ±è¨ˆã‚’æ›´æ–°</button>
                    <div id="purchaseOrderStats" style="margin-top: 20px;"></div>
                </div>
                
                <!-- æ—¢å­˜ã®å—å…¥ãƒªã‚¹ãƒˆ -->
                <div class="card" style="padding: 20px; background: white; border: 1px solid #dee2e6; border-radius: 10px;">
                    <h3>ğŸ“‹ è£½ç•ªåˆ¥å—å…¥ãƒªã‚¹ãƒˆ</h3>
                    <div id="receivingList"></div>
                </div>
            </div>

            <script>

            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSé˜²æ­¢ï¼‰
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let detectedSeibansList = [];

            function toggleProcessingMode() {
                const mode = document.getElementById('processingMode').value;
                
                if (mode === 'single') {
                    document.getElementById('singleModeInput').style.display = 'block';
                    document.getElementById('autoModeInput').style.display = 'none';
                    document.getElementById('detectedSeibans').style.display = 'none';
                } else {
                    document.getElementById('singleModeInput').style.display = 'none';
                    document.getElementById('autoModeInput').style.display = 'block';
                }
            }

            async function detectAndProcess() {
                const sheet1 = document.getElementById('sheet1Select').value;
                const minSeiban = document.getElementById('minSeibanInput').value || 'MHT0600';
                
                document.getElementById('loadingIndicator').style.display = 'block';
                
                try {
                    const response = await fetch('/api/detect-seibans', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filepath: currentFilePath,
                            sheet_name: sheet1,
                            min_seiban: minSeiban
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        detectedSeibansList = data.seibans;
                        displayDetectedSeibans(data.seibans);
                        showToast(`${data.count}ä»¶ã®è£½ç•ªã‚’æ¤œå‡ºã—ã¾ã—ãŸ`, 'success');
                    } else {
                        showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                    }
                } catch (error) {
                    showToast('æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            function displayDetectedSeibans(seibans) {
                const listDiv = document.getElementById('seibanList');
                listDiv.innerHTML = '';
                
                seibans.forEach(seiban => {
                    const checkbox = document.createElement('div');
                    checkbox.style.marginBottom = '5px';
                    checkbox.innerHTML = `
                        <label style="cursor: pointer;">
                            <input type="checkbox" class="seiban-checkbox" value="${seiban}" checked>
                            <strong>${seiban}</strong>
                        </label>
                    `;
                    listDiv.appendChild(checkbox);
                });
                
                document.getElementById('detectedSeibans').style.display = 'block';
            }

            function selectAllSeibans() {
                document.querySelectorAll('.seiban-checkbox').forEach(cb => cb.checked = true);
            }

            function deselectAllSeibans() {
                document.querySelectorAll('.seiban-checkbox').forEach(cb => cb.checked = false);
            }

            async function processSelectedSeibans() {
                const selectedSeibans = Array.from(document.querySelectorAll('.seiban-checkbox:checked'))
                    .map(cb => cb.value);
                
                if (selectedSeibans.length === 0) {
                    showToast('è£½ç•ªã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                if (!confirm(`${selectedSeibans.length}ä»¶ã®è£½ç•ªã‚’å‡¦ç†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                const sheet1 = document.getElementById('sheet1Select').value;
                const sheet2 = document.getElementById('sheet2Select').value;
                
                // é€²æ—è¡¨ç¤ºã‚’åˆæœŸåŒ–
                const progressDiv = document.getElementById('batchProgress');
                const progressBar = document.getElementById('batchProgressBar');
                const progressText = document.getElementById('batchProgressText');
                const resultsDiv = document.getElementById('batchResults');
                
                progressDiv.style.display = 'block';
                resultsDiv.innerHTML = '';
                
                let completed = 0;
                
                for (const seiban of selectedSeibans) {
                    try {
                        const response = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filepath: currentFilePath,
                                sheet1: sheet1,
                                sheet2: sheet2,
                                seiban: seiban
                            })
                        });
                        
                        const data = await response.json();
                        
                        completed++;
                        const progress = (completed / selectedSeibans.length * 100);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${completed} / ${selectedSeibans.length} å®Œäº†`;
                        
                        if (data.success) {
                            resultsDiv.innerHTML += `<div style="color: green;">âœ… ${seiban}: å‡¦ç†å®Œäº†</div>`;
                        } else {
                            resultsDiv.innerHTML += `<div style="color: red;">âŒ ${seiban}: ${data.error}</div>`;
                        }
                    } catch (error) {
                        resultsDiv.innerHTML += `<div style="color: red;">âŒ ${seiban}: ${error}</div>`;
                    }
                }
                
                showToast(`ä¸€æ‹¬å‡¦ç†å®Œäº†: ${completed}ä»¶`, 'success');
                loadOrders();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    document.getElementById('sheetSelection').style.display = 'none';
                    document.getElementById('uploadText').innerHTML = `
                        <p style="font-size: 3em;">ğŸ“</p>
                        <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <p style="color: #6c757d; font-size: 0.9em;">å¯¾å¿œå½¢å¼: .xlsx, .xls (æœ€å¤§50MB)</p>
                    `;
                }, 3000);
            }
            
            // æ›´æ–°æƒ…å ±ï¼ˆå‚™è€ƒãƒ»ç”»åƒãŒã‚ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆä¸€è¦§ï¼‰ã‚’èª­ã¿è¾¼ã¿
            async function loadUpdateInfo() {
                const container = document.getElementById('updateInfoContent');
                const countEl = document.getElementById('updateInfoCount');
                if (!container) return;

                container.innerHTML = '<p style="text-align: center; padding: 15px; color: #6c757d;">èª­ã¿è¾¼ã¿ä¸­...</p>';

                try {
                    const response = await fetch('/api/orders/update-info');
                    const data = await response.json();

                    if (!data.success) {
                        container.innerHTML = `<p style="color: #dc3545;">ã‚¨ãƒ©ãƒ¼: ${data.error}</p>`;
                        return;
                    }

                    if (data.orders.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 15px; color: #6c757d;">å‚™è€ƒãƒ»ç”»åƒãŒè¨­å®šã•ã‚ŒãŸãƒ¦ãƒ‹ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                        if (countEl) countEl.textContent = '';
                        return;
                    }

                    if (countEl) countEl.textContent = `${data.total}ä»¶`;

                    // è£½ç•ªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    const grouped = {};
                    data.orders.forEach(order => {
                        if (!grouped[order.seiban]) grouped[order.seiban] = [];
                        grouped[order.seiban].push(order);
                    });

                    let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

                    Object.keys(grouped).sort().forEach(seiban => {
                        html += `<div style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">`;
                        html += `<div style="padding: 8px 12px; background: #f1f3f5; font-weight: bold; font-size: 0.95em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                            ${seiban} <span style="color: #666; font-weight: normal; font-size: 0.85em;">(${grouped[seiban].length}ä»¶)</span>
                        </div>`;
                        html += `<div>`;

                        grouped[seiban].forEach(order => {
                            const statusColor = order.status === 'ç´å“å®Œäº†' ? '#28a745' : order.status === 'ç´å“ä¸­' ? '#ffc107' : '#6c757d';
                            html += `<div style="padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="showOrderDetails(${order.order_id})">`;
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">`;
                            html += `<strong style="font-size: 0.95em;">${order.unit || '(ãƒ¦ãƒ‹ãƒƒãƒˆæœªè¨­å®š)'}</strong>`;
                            html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                            html += `<span style="background: ${statusColor}; color: ${order.status === 'ç´å“ä¸­' ? '#333' : '#fff'}; padding: 1px 8px; border-radius: 10px; font-size: 0.75em;">${order.status || 'æœªè¨­å®š'}</span>`;
                            if (order.has_image) html += `<span style="font-size: 0.85em;">ğŸ“·</span>`;
                            html += `<span style="color: #999; font-size: 0.75em;">${order.updated_at}</span>`;
                            html += `</div></div>`;

                            if (order.remarks) {
                                html += `<div style="font-size: 0.85em; color: #555; background: #fffbea; padding: 5px 8px; border-radius: 4px; border-left: 3px solid #ffc107; margin-top: 4px; white-space: pre-wrap; word-break: break-word;">${escapeHtml(order.remarks)}</div>`;
                            }

                            if (order.has_image) {
                                html += `<div style="margin-top: 6px;"><img src="${order.image_url}" alt="ç”»åƒ" style="max-width: 200px; max-height: 120px; border-radius: 4px; border: 1px solid #dee2e6; cursor: pointer;" onclick="event.stopPropagation(); window.open('${order.image_url}', '_blank')"></div>`;
                            }

                            // å ´æ‰€ãƒ»ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±
                            if (order.location !== 'æœªè¨­å®š' || order.pallet_number !== 'æœªè¨­å®š') {
                                html += `<div style="font-size: 0.78em; color: #888; margin-top: 3px;">`;
                                if (order.location !== 'æœªè¨­å®š') html += `å ´æ‰€: ${order.location} `;
                                if (order.pallet_number !== 'æœªè¨­å®š') html += `æ£š: ${order.pallet_number}`;
                                html += `</div>`;
                            }

                            html += `</div>`;
                        });

                        html += `</div></div>`;
                    });

                    html += '</div>';
                    container.innerHTML = html;

                } catch (error) {
                    container.innerHTML = `<p style="color: #dc3545;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error}</p>`;
                }
            }

            // ç™ºæ³¨ç•ªå·ã§æ¤œç´¢
            async function searchByPurchaseOrder() {
                const purchaseOrderNumber = document.getElementById('purchaseOrderInput').value.trim();
                
                if (!purchaseOrderNumber) {
                    showToast('ç™ºæ³¨ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                // æµ®å‹•å°æ•°ç‚¹å½¢å¼ã‚’æ•´æ•°å½¢å¼ã«å¤‰æ›
                let searchNumber = purchaseOrderNumber;
                if (searchNumber.includes('.0')) {
                    searchNumber = searchNumber.replace('.0', '');
                }
                
                // ğŸ”¥ ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                searchNumber = String(parseInt(searchNumber));
                
                try {
                    // ğŸ”¥ æ¤œç´¢é–‹å§‹ãƒˆãƒ¼ã‚¹ãƒˆ
                    showToast('1.ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢ä¸­...', 'info', 2000);
                    
                    const response = await fetch(`/api/search-by-purchase-order/${searchNumber}`);
                    const data = await response.json();

                    if (data.cache_needs_loading) {
                        showToast('2.ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã‹ã‚‰ç™ºæ³¨ç•ªå·ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç™ºæ³¨ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Šæ¤œç´¢ã—ã¾ã™ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰', 'warning', 5000);
                       await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    const resultDiv = document.getElementById('purchaseOrderSearchResult');
                    
                    if (data.found) {

                        // æœªãƒãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®è­¦å‘Š
                        let warningHtml = '';
                        if (data.has_unmerged) {
                            warningHtml = `
                                <div class="alert alert-warning" style="margin-bottom: 10px;">
                                    âš ï¸ æœªãƒãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆç™ºæ³¨_ALLã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ï¼‰<br>
                                    <small>â€»ã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å—å…¥å‡¦ç†ã§ãã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</small>
                                </div>
                            `;
                        }
                        
                        let html = `
                            ${warningHtml}
                            <div class="alert alert-success">
                                <h4>æ¤œç´¢çµæœ: ${data.count}ä»¶</h4>
                                <div class="table-wrapper" style="overflow-x: auto; margin-top: 10px;">
                                    <table class="detail-table search-result-table" style="width: 100%; min-width: 900px;">
                                        <thead>
                                            <tr>
                                                <th>ã‚½ãƒ¼ã‚¹</th>
                                                <th>ç™ºæ³¨ç•ªå·</th>
                                                <th>è£½ç•ª</th>
                                                <th>ãƒ¦ãƒ‹ãƒƒãƒˆ</th>
                                                <th>å“å</th>
                                                <th>ä»•æ§˜ï¼‘</th>
                                                <th>æ•°é‡</th>
                                                <th>ç´æœŸ</th>
                                                <th>å›ç­”ç´æœŸ</th>
                                                <th>ä»•å…¥å…ˆ</th>
                                                <th>ç™ºæ³¨è€…</th>
                                                <th>å—å…¥çŠ¶æ…‹</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        data.details.forEach(detail => {
                            const sourceLabel = detail.source === 'merged' ? 
                                '<span style="color: green;">âœ… ãƒãƒ¼ã‚¸æ¸ˆ</span>' : 
                                '<span style="color: orange;">âš ï¸ æœªãƒãƒ¼ã‚¸</span>';
                            
                            const actionButton = detail.order_id ? 
                                `<button class="btn btn-sm btn-primary" onclick="showOrderDetails(${detail.order_id})">ãƒ¦ãƒ‹ãƒƒãƒˆè©³ç´°</button>` : 
                                '<span style="color: #6c757d;">âš ï¸å—å…¥ã«ã¯è¦ãƒãƒ¼ã‚¸</span>';
                            
                            html += `
                                <tr class="${detail.is_received ? 'received' : ''}">
                                    <td>${sourceLabel}</td>
                                    <td><strong>${searchNumber}</strong></td>
                                    <td>${detail.seiban}</td>
                                    <td>${detail.unit || '-'}</td>
                                    <td title="${detail.item_name}">${detail.item_name}</td>
                                    <td title="${detail.spec1 || '-'}">${detail.spec1 || '-'}</td>
                                    <td>${detail.quantity} ${detail.unit_measure || ''}</td>
                                    <td>${detail.delivery_date || '-'}</td>
                                    <td style="color: ${detail.reply_delivery_date ? '#d32f2f' : '#ccc'};">${detail.reply_delivery_date || '-'}</td>
                                    <td>${detail.supplier || '-'}</td>
                                    <td>${detail.staff || '-'}</td>
                                    <td>
                                        ${detail.is_received ? 
                                            '<span style="color: green;">âœ… å—å…¥æ¸ˆ</span>' : 
                                            '<span style="color: orange;">ğŸŸ¨ æœªå—å…¥</span>'}
                                    </td>
                                    <td>${actionButton}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        resultDiv.innerHTML = html;
                        showToast(`âœ… æ¤œç´¢å®Œäº†: ${data.count}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'success');
                        
                    } else {
                        // ğŸ”¥ è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>ç™ºæ³¨ç•ªå· ${purchaseOrderNumber} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</strong><br>
                                <small>
                                ãƒ»ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: æ¤œç´¢æ¸ˆã¿<br>
                                ãƒ»ç™ºæ³¨_ALLã‚·ãƒ¼ãƒˆ: æ¤œç´¢æ¸ˆã¿<br>
                                â€»ç™ºæ³¨ç•ªå·ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„
                                </small>
                            </div>
                        `;
                        showToast(`âŒ ç™ºæ³¨ç•ªå· ${purchaseOrderNumber} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                    }
                } catch (error) {
                    showToast('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                }
            }

            // ä»•æ§˜ï¼‘ã§æ¤œç´¢
            async function searchBySpec1() {
                const spec1 = document.getElementById('spec1Input').value.trim();
                
                if (!spec1) {
                    showToast('ä»•æ§˜ï¼‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                try {
                    // ğŸ”¥ 1æ®µéšç›®ï¼šãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ã¿æ¤œç´¢
                    showToast('1.ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢ä¸­...', 'info', 2000);
                    
                    const response = await fetch(`/api/search-by-spec1/${encodeURIComponent(spec1)}`);
                    const data = await response.json();
                    
                    // ğŸ”¥ ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ãŒå¿…è¦ãªå ´åˆã¯å…ˆã«ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
                    if (data.cache_needs_loading) {
                        showToast('2.ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã‹ã‚‰ä»•æ§˜ï¼‘ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç™ºæ³¨ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Šæ¤œç´¢ã—ã¾ã™ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰', 'warning', 5000);
                        
                        // ğŸ”¥ å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰çµæœã‚’è¡¨ç¤ºï¼ˆèª­ã¿è¾¼ã¿æ™‚é–“ã‚’ä½“æ„Ÿã•ã›ã‚‹ï¼‰
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    const resultDiv = document.getElementById('spec1SearchResult');
                    
                    if (data.found) {
                        // ğŸ”¥ æœªãƒãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ãƒˆãƒ¼ã‚¹ãƒˆ
                        if (data.has_unmerged) {
                            showToast('2.ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã‹ã‚‰ä»•æ§˜ï¼‘ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç™ºæ³¨ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Šæ¤œç´¢ã—ã¾ã™ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰', 'warning', 5000);
                        }
                        
                        // ğŸ”¥ æœªãƒãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®è­¦å‘Š
                        let warningHtml = '';
                        if (data.has_unmerged) {
                            warningHtml = `
                                <div class="alert alert-warning" style="margin-bottom: 10px;">
                                    âš ï¸ æœªãƒãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆç™ºæ³¨_ALLã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ï¼‰<br>
                                    <small>â€»ã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å—å…¥å‡¦ç†ã§ãã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</small>
                                </div>
                            `;
                        }
                        
                        let html = `
                            ${warningHtml}
                            <div class="alert alert-success">
                                <h4>æ¤œç´¢çµæœ: ${data.count}ä»¶</h4>
                                <div class="table-wrapper" style="overflow-x: auto; margin-top: 10px;">
                                    <table class="detail-table search-result-table" style="width: 100%; min-width: 900px;">
                                        <thead>
                                            <tr>
                                                <th>ã‚½ãƒ¼ã‚¹</th>
                                                <th>ç™ºæ³¨ç•ªå·</th>
                                                <th>è£½ç•ª</th>
                                                <th>ãƒ¦ãƒ‹ãƒƒãƒˆ</th>
                                                <th>å“å</th>
                                                <th>ä»•æ§˜ï¼‘</th>
                                                <th>æ•°é‡</th>
                                                <th>ç´æœŸ</th>
                                                <th>å›ç­”ç´æœŸ</th>
                                                <th>ä»•å…¥å…ˆ</th>
                                                <th>ç™ºæ³¨è€…</th>
                                                <th>å—å…¥çŠ¶æ…‹</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        data.details.forEach(detail => {
                            const sourceLabel = detail.source === 'merged' ? 
                                '<span style="color: green;">âœ… ãƒãƒ¼ã‚¸æ¸ˆ</span>' : 
                                '<span style="color: orange;">âš ï¸ æœªãƒãƒ¼ã‚¸</span>';
                            
                            const actionButton = detail.order_id ? 
                                `<button class="btn btn-sm btn-primary" onclick="showOrderDetails(${detail.order_id})">è©³ç´°</button>` : 
                                '<span style="color: #6c757d;">ãƒãƒ¼ã‚¸å‡¦ç†ãŒå¿…è¦</span>';
                            
                            html += `
                                <tr class="${detail.is_received ? 'received' : ''}">
                                    <td>${sourceLabel}</td>
                                    <td>${detail.order_number || '-'}</td>
                                    <td>${detail.seiban}</td>
                                    <td>${detail.unit || '-'}</td>
                                    <td title="${detail.item_name}">${detail.item_name}</td>
                                    <td title="${detail.spec1 || '-'}">
                                        ${highlightSearchTerm(detail.spec1 || '-', spec1)}
                                    </td>
                                    <td>${detail.quantity} ${detail.unit_measure || ''}</td>
                                    <td>${detail.delivery_date || '-'}</td>
                                    <td style="color: ${detail.reply_delivery_date ? '#d32f2f' : '#ccc'};">${detail.reply_delivery_date || '-'}</td>
                                    <td>${detail.supplier || '-'}</td>
                                    <td>${detail.staff || '-'}</td>
                                    <td>
                                        ${detail.is_received ? 
                                            '<span style="color: green;">âœ… å—å…¥æ¸ˆ</span>' : 
                                            '<span style="color: orange;">ğŸŸ¨ æœªå—å…¥</span>'}
                                    </td>
                                    <td>${actionButton}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        resultDiv.innerHTML = html;
                        showToast(`âœ… æ¤œç´¢å®Œäº†: ${data.count}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'success');
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>ä»•æ§˜ï¼‘ "${spec1}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</strong><br>
                                <small>
                                ãƒ»ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: æ¤œç´¢æ¸ˆã¿<br>
                                ãƒ»ç™ºæ³¨_ALLã‚·ãƒ¼ãƒˆ: æ¤œç´¢æ¸ˆã¿<br>
                                â€»ä»•æ§˜ï¼‘ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„
                                </small>
                            </div>
                        `;
                        showToast(`âŒ ä»•æ§˜ï¼‘ "${spec1}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                    }
                } catch (error) {
                    showToast('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                }
            }
            
            // ğŸ”¥ æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹è£œåŠ©é–¢æ•°
            function highlightSearchTerm(text, searchTerm) {
                if (!text || !searchTerm) return text;
                
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                return text.replace(regex, '<span style="background-color: yellow; font-weight: bold;">$1</span>');
            }
            // ç™ºæ³¨ç•ªå·ã§ä¸€æ‹¬å—å…¥
            async function receiveByPurchaseOrder() {
                const purchaseOrderNumber = document.getElementById('purchaseOrderInput').value.trim();
                
                if (!purchaseOrderNumber) {
                    showToast('ç™ºæ³¨ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                // æµ®å‹•å°æ•°ç‚¹å½¢å¼ã‚’æ•´æ•°å½¢å¼ã«å¤‰æ›
                let searchNumber = purchaseOrderNumber;
                if (searchNumber.includes('.0')) {
                    searchNumber = searchNumber.replace('.0', '');
                }
                
                if (!confirm(`ç™ºæ³¨ç•ªå· ${searchNumber} ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€æ‹¬å—å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/receive-by-purchase-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            purchase_order_number: searchNumber
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast(data.message, data.has_internal_processing ? 'warning' : 'success');
                        
                        // ç”»é¢ã‚’æ›´æ–°
                        searchByPurchaseOrder();
                        loadOrders();
                        loadPurchaseOrderStats();
                    } else {
                        showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                    }
                } catch (error) {
                    showToast('å—å…¥ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                }
            }

            // ç™ºæ³¨ç•ªå·çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
            async function loadPurchaseOrderStats() {
                try {
                    const response = await fetch('/api/purchase-order-stats');
                    const data = await response.json();
                    
                    const statsDiv = document.getElementById('purchaseOrderStats');
                    
                if (data.stats && data.stats.length > 0) {
                    let html = `
                        <p>ç·ç™ºæ³¨æ•°: ${data.total_orders}ä»¶</p>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="detail-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ç™ºæ³¨ç•ªå·</th>
                                        <th>å“å</th>
                                        <th>ä»•æ§˜1</th>
                                        <th>ã‚¢ã‚¤ãƒ†ãƒ æ•°</th>
                                        <th>ç·æ•°é‡</th>
                                        <th>å—å…¥æ¸ˆ</th>
                                        <th>å®Œäº†ç‡</th>
                                        <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    data.stats.forEach(stat => {
                        const statusColor = stat.completion_rate === 100 ? 'green' : 
                                        stat.completion_rate > 0 ? 'orange' : 'red';
                        
                        let displayNumber = stat.purchase_order_number;
                        if (displayNumber && displayNumber.includes('.0')) {
                            displayNumber = displayNumber.replace('.0', '');
                        }
                        
                        html += `
                            <tr>
                                <td><strong>${displayNumber}</strong></td>
                                <td title="${stat.item_name}">${stat.item_name.length > 15 ? stat.item_name.substring(0, 15) + '...' : stat.item_name}</td>
                                <td title="${stat.spec1}">${stat.spec1.length > 15 ? stat.spec1.substring(0, 15) + '...' : stat.spec1}</td>
                                <td>${stat.total_items}</td>
                                <td>${stat.total_quantity}</td>
                                <td>${stat.received_items}</td>
                                <td>
                                    <div class="progress-bar" style="width: 100px; display: inline-block;">
                                        <div class="progress-fill" style="width: ${stat.completion_rate}%; background: ${statusColor};"></div>
                                    </div>
                                    ${stat.completion_rate}%
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" 
                                        onclick="document.getElementById('purchaseOrderInput').value='${displayNumber}'; searchByPurchaseOrder();">
                                        ãƒ¦ãƒ‹ãƒƒãƒˆè©³ç´°
                                    </button>
                                    ${stat.completion_rate < 100 ? `
                                        <button class="btn btn-sm btn-success" 
                                            onclick="document.getElementById('purchaseOrderInput').value='${displayNumber}'; receiveByPurchaseOrder();">
                                            å—å…¥
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    statsDiv.innerHTML = html;
                } else {
                        statsDiv.innerHTML = '<p>ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    }
                } catch (error) {
                    console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showToast('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                }
            }


            // ä»•æ§˜1å…¥åŠ›ã§Enterã‚­ãƒ¼å¯¾å¿œ
            document.getElementById('spec1Input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBySpec1();
                }
            });

            // ğŸ”¥ ç™ºæ³¨ç•ªå·å…¥åŠ›ã§Enterã‚­ãƒ¼å¯¾å¿œï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³å¾Œã®å—å…¥ç¢ºèªï¼‰
            document.getElementById('purchaseOrderInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const orderNumber = this.value.trim();
                    if (orderNumber) {
                        showBarcodeReceivePopup(orderNumber);
                    }
                }
            });

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«çµ±è¨ˆã‚’è¡¨ç¤º
            document.addEventListener('DOMContentLoaded', function() {
                // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                loadOrders();
                loadArchivedOrders();
                setupDragDrop();
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•èª­ã¿è¾¼ã¿
                checkNetworkFile();
                loadNetworkFile();  // è‡ªå‹•çš„ã«ã‚·ãƒ¼ãƒˆé¸æŠã‚’è¡¨ç¤º
                
                // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª­ã¿è¾¼ã¿
                loadSystemStatus();
                loadHistoryData();
                
                // ğŸ”¥ ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆä¸€åº¦ã ã‘ç™»éŒ²ï¼‰
                document.getElementById('deleteMultipleBtn').addEventListener('click', async () => {
                    const checkboxes = document.querySelectorAll('.seiban-checkbox:checked');
                    
                    if (checkboxes.length === 0) {
                        showToast('å‰Šé™¤ã™ã‚‹è£½ç•ªã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                        return;
                    }
                    
                    // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸè£½ç•ªã‹ã‚‰æ³¨æ–‡IDã‚’åé›†
                    const orderIds = [];
                    const seibans = [];
                    
                    checkboxes.forEach(cb => {
                        seibans.push(cb.value);
                        const ids = cb.getAttribute('data-order-ids').split(',').map(id => parseInt(id));
                        orderIds.push(...ids);
                    });
                    
                    if (orderIds.length === 0) {
                        showToast('å‰Šé™¤å¯¾è±¡ã®æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                        return;
                    }
                    
                    if (!confirm(`${seibans.length}ä»¶ã®è£½ç•ªï¼ˆè¨ˆ${orderIds.length}ãƒ¦ãƒ‹ãƒƒãƒˆï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nè£½ç•ª: ${seibans.join(', ')}\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/orders/delete-multiple', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({order_ids: orderIds})
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showToast(result.message, 'success');
                            loadOrders();
                        } else {
                            showToast('ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
                        }
                    } catch (error) {
                        showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
                    }
                });
                
                // å®šæœŸå®Ÿè¡Œã‚¿ã‚¤ãƒãƒ¼
                setInterval(loadSystemStatus, 3600000);  // 60åˆ†ã”ã¨
                setInterval(checkForUpdates, 600000);    // 10åˆ†ã”ã¨
            });
            </script>

            <!-- ãƒ‘ãƒ¬ãƒƒãƒˆç®¡ç†ã‚¿ãƒ– -->
            <div id="pallets-tab" class="tab-content">
                <h2>ğŸ¢ ãƒ¦ãƒ‹ãƒƒãƒˆä¿ç®¡å ´æ‰€</h2>
                
                <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="upload-section">
                    <h3>ğŸ” è£½ç•ªæ¤œç´¢</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="seibanSearchInput" placeholder="è£½ç•ªã¾ãŸã¯å“åã‚’å…¥åŠ›..." 
                            style="flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em;">
                        <button class="btn btn-primary" onclick="searchSeiban()">ğŸ” æ¤œç´¢</button>
                    </div>
                    <div id="searchResults"></div>
                </div>
                
                <!-- ãƒ‘ãƒ¬ãƒƒãƒˆçµ±è¨ˆ -->
                <div class="upload-section">
                    <h3>ğŸ“Š ä¿ç®¡çµ±è¨ˆ</h3>
                    <div id="palletStats"></div>
                </div>
                
                <!-- ãƒ‘ãƒ¬ãƒƒãƒˆä¸€è¦§ -->
                <div class="upload-section">
                    <h3>ğŸ“¦ ä¿ç®¡å ´æ‰€ä¸€è¦§(P=ãƒ‘ãƒ¬ãƒƒãƒˆ,T=æ£š,D=å°è»Š)ã€€ğŸŸ¡å—å…¥æº–å‚™å‰,ğŸ”µç´å“ä¸­,ğŸŸ¢ç´å“å®Œäº†</h3>
                    <div id="palletList" class="order-grid"></div>
                </div>
            </div>
            
            <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¿ãƒ– -->
            <div id="archive-tab" class="tab-content">
                <h2>ğŸ—„ï¸ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆç´å“å®Œäº†ï¼‰</h2>
                <p>ç´å“å®Œäº†ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸæ³¨æ–‡ä¸€è¦§</p>
                <div id="archiveGrid" class="order-grid"></div>
            </div>

            <!-- ç™ºè¡Œå±¥æ­´ã‚¿ãƒ– -->
            <div id="history-tab" class="tab-content">
                <h2>ğŸ“Š ç™ºè¡Œå±¥æ­´</h2>
                <button class="btn btn-primary" onclick="loadHistoryData()">
                    å±¥æ­´ã‚’æ›´æ–°
                </button>
                <button class="btn btn-warning" onclick="document.getElementById('historyFileInput').click()" style="margin-left: 10px;">
                    å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
                <input type="file" id="historyFileInput" accept=".xlsx" style="display: none;" onchange="importHistory(this)">
                
                <div id="historyList" style="margin-top: 20px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ³¨æ–‡è©³ç´°</h2>
                <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        let currentFilePath = '';
        let currentOrderId = null;

        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥é–¢æ•°
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        }

        // Check for file updates
        async function checkForUpdates() {
            try {
                const response = await fetch('/api/check-update');
                const data = await response.json();
                
                if (data.has_update) {
                    if (confirm(`${data.message}\n\nãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        await loadNetworkFile();
                        loadOrders();
                    }
                }
            } catch (error) {
                console.error('Update check error:', error);
            }
        }

        // Debug paths
        async function debugPaths() {
            try {
                const response = await fetch('/api/debug-paths');
                const data = await response.json();
                
                let message = 'ğŸ“Š ãƒ‘ã‚¹è¨ºæ–­çµæœ\n\n';
                
                // è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹
                message += 'ã€è¨­å®šãƒ‘ã‚¹ã€‘\n';
                for (const [name, path] of Object.entries(data.configured_paths)) {
                    message += `${name}: ${path}\n`;
                }
                
                message += '\nã€æ¥ç¶šçŠ¶æ…‹ã€‘\n';
                for (const [name, info] of Object.entries(data.path_checks)) {
                    message += `${name}: ${info.os_exists ? 'âœ… æ¥ç¶šOK' : 'âŒ æ¥ç¶šå¤±æ•—'}\n`;
                    if (info.size_mb) {
                        message += `  ã‚µã‚¤ã‚º: ${info.size_mb} MB\n`;
                    }
                    if (info.error) {
                        message += `  ã‚¨ãƒ©ãƒ¼: ${info.error}\n`;
                    }
                }
                
                message += `\nã€ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã€‘\n`;
                message += `\\\\server3: ${data.server_connection.connected ? 'âœ… æ¥ç¶šOK' : 'âŒ æ¥ç¶šå¤±æ•—'}\n`;
                
                console.log('Debug info:', data);
                alert(message);
                
                // è©³ç´°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                console.table(data.path_checks);
            } catch (error) {
                alert('è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

        // Check network file availability
        async function checkNetworkFile() {
            try {
                const response = await fetch('/api/check-network-file-with-diff');
                const data = await response.json();
                
                const infoDiv = document.getElementById('networkFileInfo');
                if (data.accessible) {
                    let html = `
                        <div class="alert alert-success">
                            âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«æ¥ç¶šå¯èƒ½<br>
                            ãƒ•ã‚¡ã‚¤ãƒ«: ${data.filename}<br>
                            ã‚µã‚¤ã‚º: ${data.size_mb} MB<br>
                            æœ€çµ‚æ›´æ–°: ${new Date(data.modified * 1000).toLocaleString('ja-JP')}<br>
                            ç·ä»¶æ•°: ${data.total_rows || 0}ä»¶ (è£½ç•ª: ${data.unique_seibans || 0}ç¨®é¡)
                    `;
                    
                    if (data.diff && data.diff.length > 0) {
                        html += `<br><br><strong>ğŸ“Š æ›´æ–°æ¤œå‡º:</strong><br>`;
                        html += `<div style="max-height: 300px; overflow-y: auto; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; background: #f8fff9;">`;
                        
                        data.diff.forEach(item => {
                            let displayText = `<span style="color: #28a745; font-weight: bold;">â–² ${item.seiban}`;
                            
                            if (item.customer_abbr) {
                                displayText += ` <span style="color: #6c757d;">(${item.customer_abbr})</span>`;
                            }
                            
                            displayText += `:</span>`;
                            
                            if (item.product_name) {
                                displayText += ` <span style="color: #495057;">${item.product_name}</span>`;
                            }
                            
                            if (item.memo2) {
                                displayText += ` <span style="color: #6c757d; font-style: italic;">${item.memo2}</span>`;
                            }
                            
                            displayText += ` <span style="color: #28a745;">+${item.added}ä»¶</span> <span style="color: #6c757d;">(è¨ˆ${item.total}ä»¶)</span>`;
                            
                            html += `${displayText}<br>`;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += '</div>';
                    infoDiv.innerHTML = html;
                    
                    loadNetworkFile();
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-warning">
                            âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¥ç¶šã§ãã¾ã›ã‚“<br>
                            ã‚¨ãƒ©ãƒ¼: ${data.error}<br>
                            æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Network check error:', error);
            }
        }

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/get-system-status');
                const status = await response.json();
                
                if (status.last_refresh) {
                    const statusDiv = document.getElementById('systemStatus');
                    statusDiv.style.display = 'block';
                    
                    const lastRefresh = new Date(status.last_refresh);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastRefresh) / 60000);
                    
                    document.getElementById('statusMessage').innerHTML = `
                        æœ€çµ‚æ›´æ–°: ${lastRefresh.toLocaleString('ja-JP')} (${diffMinutes}åˆ†å‰)<br>
                        è‡ªå‹•æ›´æ–°: ${status.auto_refresh_enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'} 
                        (é–“éš”: ${status.refresh_interval_minutes}åˆ†)<br>
                        ODBC: ${status.odbc_enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
                    `;
                    
                    // Update progress bar
                    const progress = Math.min(100, (diffMinutes / status.refresh_interval_minutes) * 100);
                    document.getElementById('statusProgress').style.width = progress + '%';
                }
            } catch (error) {
                console.error('Status load error:', error);
            }
        }

        // Load file from network
        async function loadNetworkFile() {
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch('/api/load-network-file', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    currentFilePath = data.filepath;
                    populateSheetSelects(data.sheet_names);
                    document.getElementById('sheetSelection').style.display = 'block';
                    
                    const info = data.file_info;
                    // ğŸ”¥ alertã‚’ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã«å¤‰æ›´ï¼ˆå‡¦ç†ã‚’ä¸­æ–­ã—ãªã„ï¼‰
                    showToast(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«: ${info.filename}\nã‚µã‚¤ã‚º: ${info.size_mb} MB`, 'success', 3000);
                } else {
                    if (data.suggest_upload) {
                        if (confirm(`ã‚¨ãƒ©ãƒ¼: ${data.error}\n\næ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            document.getElementById('fileInput').click();
                        }
                    } else {
                        showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Load from ODBC
        async function loadFromODBC() {
            const seiban = prompt('è£½ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: MHT0123):');
            if (!seiban) return;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch('/api/load-from-odbc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ seiban: seiban })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadOrders();
                } else {
                    alert('ODBCã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ODBCæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'receiving') {
                loadDeliverySchedule();
                loadUpdateInfo();
            } else if (tabName === 'archive') {
                loadArchivedOrders();
            }
        }

        // batãƒ•ã‚¡ã‚¤ãƒ«èµ·å‹•ãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ã‚’ä¿®æ­£
        async function refreshExcelFile() {
            const infoDiv = document.getElementById("networkFileInfo");
            infoDiv.innerHTML = '<div class="spinner"></div><p>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ä¸­...</p>';
            
            try {
                const response = await fetch('/api/refresh-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('ğŸ“Š refresh-excel response:', data);  // ğŸ”¥ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                
                if (data.success) {
                    // ğŸ”¥ å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // æ›´æ–°å¾Œã«å·®åˆ†æƒ…å ±ã‚’å–å¾—
                    const diffResponse = await fetch('/api/check-network-file-with-diff');
                    const fileData = await diffResponse.json();
                    
                    console.log('ğŸ“Š check-network-file-with-diff response:', fileData);  // ğŸ”¥ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                    
                    // ğŸ”¥ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                    if (!fileData.accessible) {
                        infoDiv.innerHTML = `
                            <div class="alert alert-warning">
                                âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${fileData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}
                            </div>
                        `;
                        return;
                    }
                    
                    let html = `
                        <div class="alert alert-success">
                            âœ… ${data.message}<br>
                            ãƒ•ã‚¡ã‚¤ãƒ«: ${fileData.filename || 'ä¸æ˜'}<br>
                            ã‚µã‚¤ã‚º: ${fileData.size_mb || 0} MB<br>
                            æœ€çµ‚æ›´æ–°: ${fileData.modified ? new Date(fileData.modified * 1000).toLocaleString('ja-JP') : 'ä¸æ˜'}<br>
                            æ‰‹é…ãƒªã‚¹ãƒˆç·ä»¶æ•°: ${fileData.total_seibans || 0}ä»¶
                    `;
                    
                    if (fileData.diff && fileData.diff.length > 0) {
                        html += `<br><br><strong>ğŸ“Š æ›´æ–°æ¤œå‡º:</strong><br>`;
                        html += `<div style="max-height: 300px; overflow-y: auto; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; background: #f8fff9;">`;
                        
                        fileData.diff.forEach(item => {
                            let displayText = `<span style="color: #28a745; font-weight: bold;">â–² ${item.seiban}`;
                            
                            if (item.customer_abbr) {
                                displayText += ` <span style="color: #6c757d;">(${item.customer_abbr})</span>`;
                            }
                            
                            displayText += `:</span>`;
                            
                            if (item.product_name) {
                                displayText += ` <span style="color: #495057;">${item.product_name}</span>`;
                            }
                            
                            if (item.memo2) {
                                displayText += ` <span style="color: #6c757d; font-style: italic;">${item.memo2}</span>`;
                            }
                            
                            displayText += ` <span style="color: #28a745;">+${item.added}ä»¶</span> <span style="color: #6c757d;">(è¨ˆ${item.total}ä»¶)</span>`;
                            
                            html += `${displayText}<br>`;
                        });
                        
                        html += `</div>`;
                    } else {
                        html += `<br><span style="color: #6c757d;">æ–°è¦ãƒ‡ãƒ¼ã‚¿ãªã—</span>`;
                    }
                    
                    html += '</div>';
                    infoDiv.innerHTML = html;
                    showToast('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-danger">
                            âŒ æ›´æ–°å¤±æ•—: ${data.error}
                        </div>
                    `;
                    showToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('âŒ refreshExcelFile error:', error);  // ğŸ”¥ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                infoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}
                    </div>
                `;
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        async function runRefreshScript() {
            const infoDiv = document.getElementById("networkFileInfo");
            infoDiv.innerHTML = '<div class="spinner"></div><p>æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œä¸­...</p>';
            
            try {
                const response = await fetch('/api/run-refresh-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    infoDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒæˆåŠŸ<br>
                            <pre style="max-height: 200px; overflow-y: auto;">${data.output}</pre>
                        </div>
                    `;
                    showToast('æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒæˆåŠŸ', 'success');
                    
                    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å†å–å¾—
                    setTimeout(() => {
                        checkNetworkFile();
                        loadNetworkFile();
                    }, 2000);
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-danger">
                            âŒ å®Ÿè¡Œå¤±æ•—: ${data.error}
                        </div>
                    `;
                    showToast('å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
            } catch (error) {
                console.error(error);
                infoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}
                    </div>
                `;
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // Load archived orders
        async function loadArchivedOrders() {
            try {
                const response = await fetch('/api/archived-orders');
                if (!response.ok) {
                    console.error('Failed to load archived orders:', response.status);
                    return;
                }
                const orders = await response.json();

                // é…åˆ—ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼å‡¦ç†
                if (!Array.isArray(orders)) {
                    console.error('Invalid archived orders response:', orders);
                    return;
                }

                const archiveGrid = document.getElementById('archiveGrid');
                archiveGrid.innerHTML = '';

                if (orders.length === 0) {
                    archiveGrid.innerHTML = '<p>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸæ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.onclick = () => showOrderDetails(order.id);
                    
                    card.innerHTML = `
                        <div class="order-header">
                            <span class="order-seiban">${order.seiban}</span>
                            <span class="order-status status-ç´å“å®Œäº†">ç´å“å®Œäº†</span>
                        </div>
                        ${order.product_name ? `<p><strong>å“å:</strong> ${order.product_name}</p>` : ''}
                        <p><strong>ãƒ¦ãƒ‹ãƒƒãƒˆ:</strong> ${order.unit || '-'}</p>
                        <p><strong>å ´æ‰€:</strong> ${order.location}</p>
                        <p><strong>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ—¥:</strong> ${new Date(order.archived_at).toLocaleString('ja-JP')}</p>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); exportOrder(${order.id})">Excelå‡ºåŠ›</button>
                            <button class="btn btn-warning" onclick="event.stopPropagation(); unarchiveOrder(${order.id})">å¾©å…ƒ</button>
                        </div>
                    `;
                    
                    archiveGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading archived orders:', error);
            }
        }

        // Archive order
        async function archiveOrder(orderId) {
            if (!confirm('ã“ã®æ³¨æ–‡ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/archive`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadOrders();
                } else {
                    showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
            }
        }

        // Unarchive order
        async function unarchiveOrder(orderId) {
            if (!confirm('ã“ã®æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/unarchive`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadArchivedOrders();
                } else {
                    showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('å¾©å…ƒã‚¨ãƒ©ãƒ¼: ' + error, 'error');
            }
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0]);
        });

        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileUpload(e.dataTransfer.files[0]);
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentFilePath = data.filepath;
                    populateSheetSelects(data.sheet_names);
                    document.getElementById('sheetSelection').style.display = 'block';
                    document.getElementById('uploadText').innerHTML = `
                        <p style="font-size: 3em;">âœ…</p>
                        <p>${file.name} ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</p>
                    `;
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function populateSheetSelects(sheetNames) {
            const sheet1Select = document.getElementById('sheet1Select');
            const sheet2Select = document.getElementById('sheet2Select');
            
            sheet1Select.innerHTML = '';
            sheet2Select.innerHTML = '';
            
            sheetNames.forEach((name, index) => {
                sheet1Select.innerHTML += `<option value="${name}">${name}</option>`;
                sheet2Select.innerHTML += `<option value="${name}">${name}</option>`;
            });
            
            if (sheetNames.length > 1) {
                sheet2Select.selectedIndex = 1;
            }
        }

        // ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿ã®è¡¨ç¤ºåˆ‡æ›¿
        function toggleOrderDateFilter() {
            const enabled = document.getElementById('enableOrderDateFilter').checked;
            const filterInput = document.getElementById('orderDateFilterInput');
            
            if (enabled) {
                filterInput.style.display = 'block';
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1ãƒ¶æœˆå‰ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®æœŸé–“ã‚’è¨­å®š
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                document.getElementById('orderDateFrom').valueAsDate = oneMonthAgo;
                document.getElementById('orderDateTo').valueAsDate = new Date();
            } else {
                filterInput.style.display = 'none';
            }
        }

        // è£½ç•ªä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã«è¡¨ç¤º
        let seibanListItems = [];  // å…¨ã‚¢ã‚¤ãƒ†ãƒ ä¿æŒç”¨
        async function loadSeibanList() {
            const listDiv = document.getElementById('seibanCheckboxList');
            const actionsDiv = document.getElementById('seibanBatchActions');
            listDiv.style.display = 'block';
            listDiv.innerHTML = '<span style="color: #888;">èª­ã¿è¾¼ã¿ä¸­...</span>';
            actionsDiv.style.display = 'none';
            try {
                const response = await fetch('/api/seiban-list');
                const data = await response.json();
                if (data.success && data.items) {
                    seibanListItems = data.items;
                    renderSeibanCheckboxes(data.items);
                    actionsDiv.style.display = 'block';
                } else {
                    listDiv.innerHTML = '<span style="color: #dc3545;">å–å¾—å¤±æ•—</span>';
                    alert('è£½ç•ªä¸€è¦§ã®å–å¾—ã«å¤±æ•—: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                listDiv.innerHTML = '<span style="color: #dc3545;">å–å¾—ã‚¨ãƒ©ãƒ¼</span>';
                alert('è£½ç•ªä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æç”»
        function renderSeibanCheckboxes(items) {
            const listDiv = document.getElementById('seibanCheckboxList');
            listDiv.innerHTML = '';
            if (items.length === 0) {
                listDiv.innerHTML = '<span style="color: #888;">è©²å½“ãªã—</span>';
                return;
            }
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'seiban-cb-label';
                label.style.cssText = 'display: flex; align-items: center; padding: 4px 6px; cursor: pointer; border-radius: 4px; gap: 8px;';
                label.setAttribute('data-seiban', item.seiban.toLowerCase());
                label.innerHTML = `
                    <input type="checkbox" class="seiban-cb" value="${item.seiban}" onchange="onSeibanCheckChange()" style="width: 18px; height: 18px; flex-shrink: 0;">
                    <span style="font-weight: bold; white-space: nowrap;">${item.seiban}</span>
                    <span style="color: #555; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.product_name}</span>
                    <span style="color: #888; font-size: 0.85em; white-space: nowrap;">(${item.customer_abbr})</span>`;
                label.addEventListener('mouseenter', () => label.style.background = '#f0f0f0');
                label.addEventListener('mouseleave', () => label.style.background = '');
                listDiv.appendChild(label);
            });
            updateSeibanCheckCount();
        }

        // çµã‚Šè¾¼ã¿
        function filterSeibanCheckboxes() {
            const filter = document.getElementById('seibanFilterInput').value.toLowerCase();
            document.querySelectorAll('.seiban-cb-label').forEach(label => {
                const seiban = label.getAttribute('data-seiban');
                label.style.display = seiban.includes(filter) ? 'flex' : 'none';
            });
        }

        // é¸æŠæ•°è¡¨ç¤ºã‚’æ›´æ–°
        function onSeibanCheckChange() {
            updateSeibanCheckCount();
            // 1å€‹ã ã‘ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ãŸã‚‰ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã«ã‚‚åæ˜ 
            const checked = document.querySelectorAll('.seiban-cb:checked');
            if (checked.length === 1) {
                document.getElementById('seibanInput').value = checked[0].value;
            }
        }
        function updateSeibanCheckCount() {
            const total = document.querySelectorAll('.seiban-cb').length;
            const checked = document.querySelectorAll('.seiban-cb:checked').length;
            const el = document.getElementById('seibanCheckCount');
            if (el) el.textContent = `${checked} / ${total} é¸æŠä¸­`;
        }

        // å…¨é¸æŠ / å…¨è§£é™¤ï¼ˆè¡¨ç¤ºä¸­ã®ã¿ï¼‰
        function selectAllSeibanCheckboxes() {
            document.querySelectorAll('.seiban-cb-label').forEach(label => {
                if (label.style.display !== 'none') {
                    label.querySelector('.seiban-cb').checked = true;
                }
            });
            updateSeibanCheckCount();
        }
        function deselectAllSeibanCheckboxes() {
            document.querySelectorAll('.seiban-cb').forEach(cb => cb.checked = false);
            updateSeibanCheckCount();
        }

        // ä¸€æ‹¬å‡¦ç†
        async function processBatchSeibans() {
            const checked = [...document.querySelectorAll('.seiban-cb:checked')].map(cb => cb.value);
            if (checked.length === 0) {
                alert('è£½ç•ªã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const sheet1 = document.getElementById('sheet1Select').value;
            const sheet2 = document.getElementById('sheet2Select').value;

            let orderDateFrom = null, orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                orderDateFrom = document.getElementById('orderDateFrom').value || null;
                orderDateTo = document.getElementById('orderDateTo').value || null;
            }

            if (!confirm(`${checked.length}ä»¶ã®è£½ç•ªã‚’ä¸€æ‹¬å‡¦ç†ã—ã¾ã™ã€‚\n\n${checked.join('\n')}\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const progressContainer = document.getElementById('batchProgressContainer');
            const progressBar = document.getElementById('batchProgressBar');
            const progressPercent = document.getElementById('batchProgressPercent');
            const progressTitle = document.getElementById('batchProgressTitle');
            const progressLog = document.getElementById('batchProgressLog');

            progressContainer.style.display = 'block';
            progressLog.innerHTML = '';
            let successCount = 0, failCount = 0;

            for (let i = 0; i < checked.length; i++) {
                const seiban = checked[i];
                const pct = Math.round(((i) / checked.length) * 100);
                progressBar.style.width = pct + '%';
                progressPercent.textContent = pct + '%';
                progressTitle.textContent = `ä¸€æ‹¬å‡¦ç†ä¸­... (${i + 1}/${checked.length}) ${seiban}`;

                try {
                    const requestBody = { filepath: currentFilePath, sheet1, sheet2, seiban };
                    if (orderDateFrom) requestBody.order_date_from = orderDateFrom;
                    if (orderDateTo) requestBody.order_date_to = orderDateTo;

                    const response = await fetch('/api/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();

                    if (data.success) {
                        successCount++;
                        progressLog.innerHTML += `<div style="color: #28a745;">âœ“ ${seiban}: ${data.message}</div>`;
                    } else {
                        failCount++;
                        progressLog.innerHTML += `<div style="color: #dc3545;">âœ— ${seiban}: ${data.error}</div>`;
                    }
                } catch (error) {
                    failCount++;
                    progressLog.innerHTML += `<div style="color: #dc3545;">âœ— ${seiban}: ${error}</div>`;
                }
                progressLog.scrollTop = progressLog.scrollHeight;
            }

            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressTitle.textContent = `å®Œäº†ï¼ æˆåŠŸ: ${successCount}ä»¶ / å¤±æ•—: ${failCount}ä»¶`;
            progressBar.style.background = failCount === 0
                ? 'linear-gradient(135deg, #28a745, #20c997)'
                : 'linear-gradient(135deg, #ffc107, #fd7e14)';

            loadOrders();
            deselectAllSeibanCheckboxes();
        }

        // processFileé–¢æ•°ã‚’ä¿®æ­£
        async function processFile() {
            const sheet1 = document.getElementById('sheet1Select').value;
            const sheet2 = document.getElementById('sheet2Select').value;
            const seiban = document.getElementById('seibanInput').value;
            
            if (!seiban) {
                alert('è£½ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿ã®å–å¾—
            let orderDateFrom = null;
            let orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                const dateFromValue = document.getElementById('orderDateFrom').value;
                const dateToValue = document.getElementById('orderDateTo').value;
                
                if (dateFromValue) {
                    orderDateFrom = dateFromValue;  // YYYY-MM-DDå½¢å¼
                }
                if (dateToValue) {
                    orderDateTo = dateToValue;  // YYYY-MM-DDå½¢å¼
                }
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const requestBody = {
                    filepath: currentFilePath,
                    sheet1: sheet1,
                    sheet2: sheet2,
                    seiban: seiban
                };
                
                // ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
                if (orderDateFrom) {
                    requestBody.order_date_from = orderDateFrom;
                }
                if (orderDateTo) {
                    requestBody.order_date_to = orderDateTo;
                }
                
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = 'å‡¦ç†å®Œäº†: ' + data.message;
                    if (orderDateFrom || orderDateTo) {
                        if (orderDateFrom && orderDateTo) {
                            message += `\nğŸ“… ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿: ${orderDateFrom} ã€œ ${orderDateTo}`;
                        } else if (orderDateFrom) {
                            message += `\nğŸ“… ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿: ${orderDateFrom}ä»¥é™`;
                        } else if (orderDateTo) {
                            message += `\nğŸ“… ç™ºæ³¨æ—¥ãƒ•ã‚£ãƒ«ã‚¿: ${orderDateTo}ã¾ã§`;
                        }
                    }
                    alert(message);
                    loadOrders();
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('seibanInput').value = '';
                    deselectAllSeibanCheckboxes();
                    document.getElementById('sheetSelection').style.display = 'none';
                    document.getElementById('enableOrderDateFilter').checked = false;
                    document.getElementById('orderDateFilterInput').style.display = 'none';
                    document.getElementById('uploadText').innerHTML = `
                        <p style="font-size: 3em;">ğŸ“</p>
                        <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <p style="color: #6c757d; font-size: 0.9em;">å¯¾å¿œå½¢å¼: .xlsx, .xls (æœ€å¤§50MB)</p>
                    `;
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // DBç›´æ¥å‡¦ç†ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
        async function processFileFromDB() {
            const seiban = document.getElementById('seibanInput').value.trim();
            if (!seiban) {
                alert('è£½ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            let orderDateFrom = null;
            let orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                orderDateFrom = document.getElementById('orderDateFrom').value || null;
                orderDateTo = document.getElementById('orderDateTo').value || null;
            }

            document.getElementById('loadingIndicator').style.display = 'block';

            try {
                const response = await fetch('/api/across-db/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seiban, order_date_from: orderDateFrom, order_date_to: orderDateTo })
                });
                const data = await response.json();
                if (data.success) {
                    alert('ğŸ—„ï¸ ' + data.message);
                    loadOrders();
                    document.getElementById('seibanInput').value = '';
                    deselectAllSeibanCheckboxes();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('DBç›´æ¥å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // DBç›´æ¥ä¸€æ‹¬å‡¦ç†
        async function processBatchSeibansFromDB() {
            const checkboxes = document.querySelectorAll('.seiban-cb:checked');
            if (checkboxes.length === 0) {
                alert('å‡¦ç†ã™ã‚‹è£½ç•ªã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const seibans = Array.from(checkboxes).map(cb => cb.value);
            if (!confirm(`ğŸ—„ï¸ DBç›´æ¥å–å¾—ã§ ${seibans.length} ä»¶ã®è£½ç•ªã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ\n\n${seibans.join(', ')}`)) {
                return;
            }

            let orderDateFrom = null;
            let orderDateTo = null;
            if (document.getElementById('enableOrderDateFilter').checked) {
                orderDateFrom = document.getElementById('orderDateFrom').value || null;
                orderDateTo = document.getElementById('orderDateTo').value || null;
            }

            // ãƒãƒƒãƒé€²æ—è¡¨ç¤º
            const container = document.getElementById('batchProgressContainer');
            const progressBar = document.getElementById('batchProgressBar');
            const progressTitle = document.getElementById('batchProgressTitle');
            const progressLog = document.getElementById('batchProgressLog');
            container.style.display = 'block';
            progressLog.innerHTML = '';

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < seibans.length; i++) {
                const seiban = seibans[i];
                const pct = Math.round(((i + 1) / seibans.length) * 100);
                progressBar.style.width = pct + '%';
                progressBar.textContent = pct + '%';
                progressTitle.textContent = `ğŸ—„ï¸ DBç›´æ¥ä¸€æ‹¬å‡¦ç†ä¸­... (${i + 1}/${seibans.length})`;

                try {
                    const response = await fetch('/api/across-db/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ seiban, order_date_from: orderDateFrom, order_date_to: orderDateTo })
                    });
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                        progressLog.innerHTML += '<div style="color:green;">âœ“ ' + seiban + ': ' + data.message + '</div>';
                    } else {
                        failCount++;
                        progressLog.innerHTML += '<div style="color:red;">âœ— ' + seiban + ': ' + data.error + '</div>';
                    }
                } catch (e) {
                    failCount++;
                    progressLog.innerHTML += '<div style="color:red;">âœ— ' + seiban + ': ' + e + '</div>';
                }
            }

            progressTitle.textContent = `ğŸ—„ï¸ DBç›´æ¥ä¸€æ‹¬å‡¦ç†å®Œäº†: æˆåŠŸ ${successCount}ä»¶ / å¤±æ•— ${failCount}ä»¶`;
            loadOrders();
        }

        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    console.error('Failed to load orders:', response.status);
                    return;
                }
                const orders = await response.json();

                // é…åˆ—ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼å‡¦ç†
                if (!Array.isArray(orders)) {
                    console.error('Invalid orders response:', orders);
                    return;
                }

                // è£½ç•ªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const groupedBySeiban = {};
                orders.forEach(order => {
                    if (!groupedBySeiban[order.seiban]) {
                        groupedBySeiban[order.seiban] = {
                            seiban: order.seiban,
                            product_name: order.product_name,
                            customer_abbr: order.customer_abbr, 
                            memo2: order.memo2,
                            units: []
                        };
                    }
                    groupedBySeiban[order.seiban].units.push(order);
                });
                
                // è£½ç•ªã§ã‚½ãƒ¼ãƒˆ
                const sortedSeibans = Object.keys(groupedBySeiban).sort();
                
                // orderGridè¦ç´ ã‚’å–å¾—
                const orderGrid = document.getElementById('orderGrid');
                orderGrid.innerHTML = '';
                
                sortedSeibans.forEach(seiban => {
                    const group = groupedBySeiban[seiban];
                    
                    // è¦ªè¦ç´ ï¼ˆè£½ç•ªãƒ¬ãƒ™ãƒ«ï¼‰
                    const parentCard = document.createElement('div');
                    parentCard.className = 'seiban-group';
                    
                    // ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã®çµ±è¨ˆã‚’è¨ˆç®—
                    const totalDetails = group.units.reduce((sum, unit) => sum + unit.detail_count, 0);
                    const totalReceived = group.units.reduce((sum, unit) => sum + unit.received_count, 0);
                    const hasInternalProcessing = group.units.some(unit => unit.has_internal_processing);
                    
                    // å…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ±ºå®š
                    const allCompleted = group.units.every(unit => unit.status === 'ç´å“å®Œäº†');
                    const anyInProgress = group.units.some(unit => unit.status === 'ç´å“ä¸­');
                    const overallStatus = allCompleted ? 'ç´å“å®Œäº†' : (anyInProgress ? 'ç´å“ä¸­' : 'å—å…¥æº–å‚™å‰');
                    
                    parentCard.innerHTML = `
                        <div class="seiban-header">
                            <input type="checkbox" class="seiban-checkbox" value="${seiban}" 
                            data-order-ids="${group.units.map(u => u.id).join(',')}" 
                            style="margin-right: 10px;">
                            <div onclick="toggleSeibanGroup('${seiban}')" style="flex: 1; cursor: pointer;">
                                <div class="seiban-info">
                                    <span class="seiban-toggle" id="toggle-${seiban}">ğŸ“</span>
                                    <span class="seiban-title">${seiban}${group.customer_abbr ? 'ï¼ˆ' + group.customer_abbr + 'ï¼‰' : ''}</span>
                                    <span class="seiban-product-name">${group.product_name || ''}${group.memo2 ? 'ã€€' + group.memo2 : ''}</span>
                                    <span class="order-status status-${overallStatus}">${overallStatus}</span>
                                </div>
                                <div class="seiban-summary">
                                    <span class="unit-count">${group.units.length} ãƒ¦ãƒ‹ãƒƒãƒˆ</span>
                                    <span class="progress-text">${totalReceived}/${totalDetails} å®Œäº†</span>
                                    ${hasInternalProcessing ? '<span class="internal-processing-warning">âš ï¸ è¿½åŠ å·¥æœ‰</span>' : ''}
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${totalDetails > 0 ? (totalReceived/totalDetails)*100 : 0}%"></div>
                                </div>
                                <div class="seiban-actions" style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center; padding-left: 15px; margin-top: 5px;">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); exportSeiban('${seiban}')" title="è£½ç•ªå…¨ä½“ã‚’Excelå‡ºåŠ›" style="font-size: 0.85em; padding: 4px 8px;">
                                        ğŸ“„ Excelå‡ºåŠ›
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); refreshSeiban('${seiban}')" title="ã“ã®è£½ç•ªã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°" style="font-size: 0.85em; padding: 4px 8px;">
                                        ğŸ”„ æ›´æ–°
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); generateLabels('${seiban}')" title="ãƒ©ãƒ™ãƒ«å°åˆ·ç”¨Excelå‡ºåŠ›" style="font-size: 0.85em; padding: 4px 8px;">
                                        ğŸ· ãƒ©ãƒ™ãƒ«
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="unit-list" id="units-${seiban}" style="display: none;">
                        </div>
                        <table class="unit-table" id="table-${seiban}" style="display:none;">
                            <thead>
                                <tr>
                                    <th>ãƒ¦ãƒ‹ãƒƒãƒˆ</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>é€²æ—</th>
                                    <th>å ´æ‰€</th>
                                    <th>å‚™è€ƒ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    `;

                    orderGrid.appendChild(parentCard);

                    // å­è¦ç´ ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ï¼‰ã‚’ãƒ¦ãƒ‹ãƒƒãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ 
                    const unitList = parentCard.querySelector(`#units-${seiban}`);
                    const tableBody = parentCard.querySelector(`#table-${seiban} tbody`);
                    group.units.forEach(order => {
                        // -- Card view --
                        const unitCard = document.createElement('div');
                        unitCard.className = `unit-card status-${order.status}`;
                        unitCard.setAttribute('data-unit', (order.unit || '').toLowerCase());
                        unitCard.setAttribute('data-status', (order.status || '').toLowerCase());
                        unitCard.setAttribute('data-order-id', order.id);
                        unitCard.onclick = () => showOrderDetails(order.id);

                        const isCompleted = order.status === 'ç´å“å®Œäº†';

                        unitCard.innerHTML = `
                            <div class="unit-header">
                                <span class="unit-name">ãƒ¦ãƒ‹ãƒƒãƒˆï¼š${order.unit || 'ãƒ¦ãƒ‹ãƒƒãƒˆåç„¡ã—'}</span>
                                <span class="order-status status-${order.status}">${order.status}</span>
                            </div>
                            <div class="unit-details">
                                <p><strong>ğŸ“ å ´æ‰€:</strong> ${order.location}</p>
                                <p><strong>ğŸ“Š é€²æ—:</strong> ${order.received_count}/${order.detail_count} å®Œäº†</p>
                                ${order.has_internal_processing ?
                                    '<p><span class="internal-processing-warning" style="display: inline-block; margin-top: 5px;">âš ï¸ è¿½åŠ å·¥æœ‰</span></p>' : ''
                                }
                                ${order.created_at ?
                                    `<p><strong>ğŸ“… ã‚·ãƒ¼ãƒˆä½œæˆæ—¥:</strong> ${order.created_at}</p>` : ''
                                }
                                ${order.updated_at ?
                                    `<p><strong>âœ’ï¸ ã‚·ãƒ¼ãƒˆå†…å®¹æ›´æ–°æ—¥:</strong> ${order.updated_at}</p>` : ''
                                }
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${order.detail_count > 0 ? (order.received_count/order.detail_count)*100 : 0}%"></div>
                            </div>
                            <div class="unit-actions" style="margin-top: 5px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); exportOrder(${order.id})">ğŸ“„ Excelå‡ºåŠ›</button>
                                ${isCompleted ?
                                    `<button class="btn btn-success" onclick="event.stopPropagation(); archiveOrder(${order.id})">ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¸</button>` :
                                    `<button class="btn btn-danger" onclick="event.stopPropagation(); deleteOrder(${order.id})">ğŸ—‘ï¸ å‰Šé™¤</button>`
                                }
                            </div>
                        `;

                        unitList.appendChild(unitCard);

                        // -- Table view row --
                        const pct = order.detail_count > 0 ? (order.received_count/order.detail_count)*100 : 0;
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-unit', (order.unit || '').toLowerCase());
                        tr.setAttribute('data-status', (order.status || '').toLowerCase());
                        tr.setAttribute('data-order-id', order.id);
                        tr.onclick = () => showOrderDetails(order.id);
                        tr.innerHTML = `
                            <td><strong>${order.unit || 'ãƒ¦ãƒ‹ãƒƒãƒˆåç„¡ã—'}</strong></td>
                            <td><span class="order-status status-${order.status}" style="font-size:0.85em;padding:2px 8px;">${order.status}</span></td>
                            <td>${order.received_count}/${order.detail_count}
                                <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                            </td>
                            <td>${order.location || 'æœªå®š'}</td>
                            <td>${order.has_internal_processing ? 'âš ï¸è¿½åŠ å·¥' : ''}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); exportOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">ğŸ“„</button>
                                ${isCompleted ?
                                    `<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); archiveOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">ğŸ“¦</button>` :
                                    `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteOrder(${order.id})" style="font-size:0.8em;padding:2px 6px;">ğŸ—‘ï¸</button>`
                                }
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                });

                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã¯è¡¨ç¤ºä¸­ã®å ´åˆã®ã¿æ›´æ–°
                const ganttContainer = document.getElementById('ganttChartContainer');
                if (ganttContainer && ganttContainer.style.display !== 'none') {
                    updateGanttChart(orders);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('æ³¨æ–‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
            }
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        async function handleGanttLabelClick(item) {
            console.log('ğŸ” ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ :', item);
            console.log('  - ãƒ©ãƒ™ãƒ«:', item.label);
            console.log('  - è£½ç•ª:', item.seiban);
            
            try {
                const response = await fetch('/api/orders');
                const orders = await response.json();
                
                console.log('ğŸ“¦ å…¨æ³¨æ–‡æ•°:', orders.length);
                
                // ãƒ©ãƒ™ãƒ«ã‹ã‚‰è£½ç•ªã¨ãƒ¦ãƒ‹ãƒƒãƒˆåã‚’åˆ†è§£
                const [clickedSeiban, ...clickedUnitParts] = item.label.split('_');
                const clickedUnit = clickedUnitParts.join('_'); // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã«å¯¾å¿œ
                
                console.log('  - åˆ†è§£ã—ãŸè£½ç•ª:', clickedSeiban);
                console.log('  - åˆ†è§£ã—ãŸãƒ¦ãƒ‹ãƒƒãƒˆ:', clickedUnit);
                
                // è©²å½“ã™ã‚‹æ³¨æ–‡ã‚’æ¤œç´¢
                const targetOrder = orders.find(order => {
                    const orderSeiban = order.seiban;
                    const orderUnit = order.unit || 'ãƒ¦ãƒ‹ãƒƒãƒˆåç„¡ã—';
                    
                    console.log(`    æ¯”è¼ƒ: ${orderSeiban}_${orderUnit} === ${item.label}`);
                    
                    return orderSeiban === clickedSeiban && orderUnit === clickedUnit;
                });
                
                if (targetOrder) {
                    console.log('âœ… æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', targetOrder);
                    showOrderDetails(targetOrder.id);
                } else {
                    console.error('âŒ æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    console.log('æ¤œç´¢å¯¾è±¡:', orders.map(o => ({
                        seiban: o.seiban,
                        unit: o.unit || 'ãƒ¦ãƒ‹ãƒƒãƒˆåç„¡ã—',
                        label: `${o.seiban}_${o.unit || 'ãƒ¦ãƒ‹ãƒƒãƒˆåç„¡ã—'}`
                    })));
                    showToast(`âš ï¸ ${item.label} ã®è©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
                }
            } catch (error) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function toggleGanttChart() {
            const container = document.getElementById('ganttChartContainer');
            const filterContainer = document.getElementById('ganttFilterContainer');
            const icon = document.getElementById('ganttToggleIcon');
            const text = document.getElementById('ganttToggleText');

            if (container.style.display === 'none') {
                // è¡¨ç¤º â†’ ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ãƒãƒ£ãƒ¼ãƒˆé ˜åŸŸã‚’è¦‹ã›ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                container.style.display = 'block';
                filterContainer.style.display = 'block';
                icon.textContent = 'ğŸ“‰';
                text.textContent = 'éè¡¨ç¤º';

                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚²ãƒ¼ã‚¸ä»˜ãï¼‰
                try {
                    const response = await fetch('/api/orders');
                    const orders = await response.json();
                    await updateGanttChart(orders);
                } catch (error) {
                    console.error('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showToast('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                }
            } else {
                container.style.display = 'none';
                filterContainer.style.display = 'none';
                icon.textContent = 'ğŸ“ˆ';
                text.textContent = 'è¡¨ç¤º';
            }
        }
                // è£½ç•ªå˜ä½ã§ã®Excelå‡ºåŠ›
                async function exportSeiban(seiban) {
                    try {
                        window.location.href = `/api/export-seiban/${seiban}`;
                    } catch (error) {
                        showToast('å‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                    }
                }

                // ğŸ”¥ è£½ç•ªå˜ä½ã§ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆãƒãƒ¼ã‚¸ï¼‰
                async function refreshSeiban(seiban) {
                    if (!confirm(`è£½ç•ª ${seiban} ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»æ‰‹é…ç™ºæ³¨_ALL.xlsxã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™`)) {
                        return;
                    }

                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                    document.getElementById('loadingIndicator').style.display = 'block';
                    showToast(`ğŸ”„ ${seiban} ã‚’æ›´æ–°ä¸­...`, 'info', 10000);

                    try {
                        const response = await fetch('/api/refresh-seiban', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                seiban: seiban
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            showToast(`âœ… ${seiban} ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${result.message}ï¼‰`, 'success');
                            // å—æ³¨ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                            await loadOrders();
                        } else {
                            showToast(`âŒ æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        showToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                    } finally {
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }
                }

                // ğŸ· ãƒ©ãƒ™ãƒ«ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                async function generateLabels(seiban) {
                    showToast(`ğŸ· ${seiban} ã®ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆä¸­...`, 'info', 10000);
                    document.getElementById('loadingIndicator').style.display = 'block';

                    try {
                        const response = await fetch('/api/generate-labels', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ seiban: seiban })
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${seiban}_ãƒ©ãƒ™ãƒ«.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            showToast(`âœ… ${seiban} ã®ãƒ©ãƒ™ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
                        } else {
                            const result = await response.json();
                            showToast(`âŒ ãƒ©ãƒ™ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        showToast('ãƒ©ãƒ™ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                    } finally {
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }
                }

                // --- View mode state ---
                let currentViewMode = 'card'; // 'card' or 'table'

                function setViewMode(mode) {
                    currentViewMode = mode;
                    document.getElementById('btnCardView').classList.toggle('active', mode === 'card');
                    document.getElementById('btnTableView').classList.toggle('active', mode === 'table');

                    // Switch all open groups
                    document.querySelectorAll('.seiban-group').forEach(group => {
                        const unitList = group.querySelector('.unit-list');
                        const unitTable = group.querySelector('.unit-table');
                        if (!unitList || !unitTable) return;

                        // Check if expanded (either view is visible)
                        const toggle = group.querySelector('.seiban-toggle');
                        const isOpen = toggle && toggle.textContent === 'ğŸ“‚';
                        if (isOpen) {
                            unitList.style.display = mode === 'card' ? 'block' : 'none';
                            unitTable.style.display = mode === 'table' ? 'table' : 'none';
                        } else {
                            unitList.style.display = 'none';
                            unitTable.style.display = 'none';
                        }
                    });

                    // Re-apply search filter
                    filterOrders();
                }

                function toggleSeibanGroup(seiban) {
                    const unitList = document.getElementById(`units-${seiban}`);
                    const unitTable = document.getElementById(`table-${seiban}`);
                    const toggle = document.getElementById(`toggle-${seiban}`);

                    if (!unitList || !toggle) return;

                    const isCard = currentViewMode === 'card';
                    const activeEl = isCard ? unitList : unitTable;
                    const inactiveEl = isCard ? unitTable : unitList;

                    // Always hide the inactive view
                    if (inactiveEl) inactiveEl.style.display = 'none';

                    if (activeEl.style.display === 'none' || activeEl.style.display === '') {
                        activeEl.style.display = isCard ? 'block' : 'table';
                        toggle.textContent = 'ğŸ“‚';
                        activeEl.style.animation = 'fadeIn 0.3s';
                    } else {
                        activeEl.style.display = 'none';
                        toggle.textContent = 'ğŸ“';
                    }
                }

                function filterOrders() {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                    const seibanGroups = document.querySelectorAll('.seiban-group');
                    const isCard = currentViewMode === 'card';

                    seibanGroups.forEach(group => {
                        const seibanTitle = group.querySelector('.seiban-title');
                        const productName = group.querySelector('.seiban-product-name');
                        const toggle = group.querySelector('.seiban-toggle');

                        // Build header-level text
                        let headerText = '';
                        if (seibanTitle) headerText += seibanTitle.textContent.toLowerCase();
                        if (productName) headerText += ' ' + productName.textContent.toLowerCase();

                        // If no search term, show group collapsed, all units visible
                        if (!searchTerm) {
                            group.style.display = '';
                            // Reset all unit cards & table rows visibility
                            group.querySelectorAll('.unit-card').forEach(c => {
                                c.style.display = '';
                                c.classList.remove('search-highlight');
                            });
                            group.querySelectorAll('.unit-table tbody tr').forEach(r => {
                                r.style.display = '';
                                r.classList.remove('search-highlight');
                            });
                            return;
                        }

                        // Check header match (seiban, customer, product)
                        const headerMatch = headerText.includes(searchTerm);

                        // Check individual units
                        let anyUnitMatch = false;
                        const unitCards = group.querySelectorAll('.unit-card');
                        const tableRows = group.querySelectorAll('.unit-table tbody tr');

                        unitCards.forEach((card, i) => {
                            const unit = card.getAttribute('data-unit') || '';
                            const status = card.getAttribute('data-status') || '';
                            const unitText = unit + ' ' + status;
                            const matched = unitText.includes(searchTerm);

                            if (matched) anyUnitMatch = true;

                            // If header matches, show all; else show only matching units
                            if (headerMatch) {
                                card.style.display = '';
                                card.classList.remove('search-highlight');
                            } else {
                                card.style.display = matched ? '' : 'none';
                                card.classList.toggle('search-highlight', matched);
                            }

                            // Same logic for table row
                            if (tableRows[i]) {
                                if (headerMatch) {
                                    tableRows[i].style.display = '';
                                    tableRows[i].classList.remove('search-highlight');
                                } else {
                                    tableRows[i].style.display = matched ? '' : 'none';
                                    tableRows[i].classList.toggle('search-highlight', matched);
                                }
                            }
                        });

                        if (headerMatch || anyUnitMatch) {
                            group.style.display = '';
                            // Auto-expand when searching by unit name
                            if (anyUnitMatch && !headerMatch) {
                                const unitList = group.querySelector('.unit-list');
                                const unitTable = group.querySelector('.unit-table');
                                if (isCard && unitList) {
                                    unitList.style.display = 'block';
                                    if (unitTable) unitTable.style.display = 'none';
                                } else if (!isCard && unitTable) {
                                    unitTable.style.display = 'table';
                                    if (unitList) unitList.style.display = 'none';
                                }
                                if (toggle) toggle.textContent = 'ğŸ“‚';
                            }
                        } else {
                            group.style.display = 'none';
                        }
                    });
                }

                // showOrderDetailsé–¢æ•°å†…ã®è©³ç´°ãƒªã‚¹ãƒˆéƒ¨åˆ†ã‚’ä¿®æ­£
                async function showOrderDetails(orderId) {
                    currentOrderId = orderId;
                    try {
                        const response = await fetch(`/api/order/${orderId}`);
                        const data = await response.json();
                        
                        document.getElementById('modalTitle').textContent = `${data.order.seiban} - ${data.order.unit}`;
                        
                        let detailsHtml = `
                            <div class="qr-code">
                                <img alt="QR Code" src="data:image/png;base64,${data.qr_code}">
                                <p style="font-size: 0.9em; word-break: break-all;">ORDER:${orderId}</p>
                            </div>
                            <div class="form-group">
                                <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                                <select id="statusSelect">
                                    <option value="å—å…¥æº–å‚™å‰">å—å…¥æº–å‚™å‰</option>
                                    <option value="ç´å“ä¸­">ç´å“ä¸­</option>
                                    <option value="ç´å“å®Œäº†">ç´å“å®Œäº†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å ´æ‰€:</label>
                                <select id="floorSelect">
                                    <option value="">æœªè¨­å®š</option>
                                    <option value="1F">1F</option>
                                    <option value="2F">2F</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆæ£šï¼‰ç•ªå·:</label>
                                <select id="palletNumberSelect">
                                    <option value="">æœªè¨­å®š</option>
                                    <!-- ãƒ‘ãƒ¬ãƒƒãƒˆ -->
                                    <option value="P001">P001(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P002">P002(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P003">P003(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P004">P004(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P005">P005(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P006">P006(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P007">P007(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P008">P008(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P009">P009(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <option value="P010">P010(ãƒ‘ãƒ¬ãƒƒãƒˆ)</option>
                                    <!-- å°è»Š -->
                                    <option value="D001">D001ï¼ˆå°è»Šï¼‰</option>
                                    <option value="D002">D002ï¼ˆå°è»Šï¼‰</option>
                                    <option value="D003">D003ï¼ˆå°è»Šï¼‰</option>
                                    <!-- æ£š -->
                                    <option value="T001">T001(æ£š)</option>
                                    <option value="T002">T002(æ£š)</option>
                                    <option value="T003">T003(æ£š)</option>
                                    <option value="T004">T004(æ£š)</option>
                                    <option value="T005">T005(æ£š)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å‚™è€ƒ:</label>
                                <textarea style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px;" id="remarksInput">${data.order.remarks || ''}</textarea>
                            </div>

                            <div class="form-group" style="margin-top: 15px;">
                                <label>ğŸ“· ç”»åƒ:</label>
                                <div id="imagePreviewArea" style="margin: 10px 0; text-align: center;">
                                    <img id="orderImage" src="/api/order/${orderId}/image"
                                         style="max-width: 100%; max-height: 300px; border-radius: 8px; display: none; cursor: pointer;"
                                         onclick="openImageFullscreen(this.src)"
                                         onerror="this.style.display='none'; document.getElementById('noImageText').style.display='block';"
                                         onload="this.style.display='block'; document.getElementById('noImageText').style.display='none';">
                                    <p id="noImageText" style="color: #888; font-style: italic;">ç”»åƒãªã—</p>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                                        ğŸ“¤ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                                        <input type="file" id="imageUpload" accept="image/*"
                                               style="display: none;" onchange="uploadOrderImage(${orderId})">
                                    </label>
                                    <button class="btn" style="background: #dc3545; color: white;" onclick="deleteOrderImage(${orderId})">ğŸ—‘ï¸ ç”»åƒã‚’å‰Šé™¤</button>
                                </div>
                                <p style="font-size: 0.8em; color: #888; margin-top: 5px;">â€»FullHD (1920x1080) ã«è‡ªå‹•åœ§ç¸®ã•ã‚Œã¾ã™</p>
                            </div>

                            <!-- ğŸ”¥ è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                            <div id="autoSaveIndicator" style="text-align: center; padding: 10px; color: #28a745; font-size: 0.9em; display: none;">
                                âœ… è‡ªå‹•ä¿å­˜æ¸ˆã¿
                            </div>

                            <h3>è©³ç´°ãƒªã‚¹ãƒˆ</h3>
                            <table class="detail-table">
                                <thead>
                                    <tr>
                                        <th>å—å…¥</th>
                                        <th>æ¤œåæ—¥</th>
                                        <th>æ¤œåæ•°</th>
                                        <th>ç´æœŸ</th>
                                        <th>å›ç­”ç´æœŸ</th>
                                        <th>ä»•å…¥å…ˆ</th>
                                        <th>ç™ºæ³¨ç•ªå·</th>
                                        <th>æ•°é‡</th>
                                        <th>å“å</th>
                                        <th>ä»•æ§˜ï¼‘</th>
                                        <th>ä»•æ§˜ï¼’</th>
                                        <th>æ‰‹é…åŒºåˆ†</th>
                                        <th>å‚™è€ƒ</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        // ğŸ”¥ è¦ªå­éšå±¤è¡¨ç¤ºã‚’ä½¿ç”¨
                        detailsHtml += displayOrderDetails(data.details);
                        
                        detailsHtml += `
                                </tbody>
                            </table>
                        `;
                        
                        document.getElementById('modalBody').innerHTML = detailsHtml;
                        document.getElementById('detailModal').classList.add('show');

                        // Set current values
                        document.getElementById('statusSelect').value = data.order.status;
                        document.getElementById('floorSelect').value = data.order.floor || '';
                        document.getElementById('palletNumberSelect').value = data.order.pallet_number || '';

                        // ğŸ”¥ CADãƒªãƒ³ã‚¯ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                        document.querySelectorAll('.cad-link').forEach(function(link) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const detailId = this.getAttribute('data-detail-id');
                                openCadFile(detailId);
                            });
                        });

                        // ğŸ”¥ è‡ªå‹•ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                        setupAutoSaveListeners();
                    } catch (error) {
                        alert('è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error);
                    }
                }

                // ğŸ”¥ è‡ªå‹•ä¿å­˜ç”¨å¤‰æ•°
                let modalRemarksTimeout = null;

                // ğŸ”¥ è‡ªå‹•ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–¢æ•°
                function setupAutoSaveListeners() {
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
                    document.getElementById('statusSelect').addEventListener('change', function() {
                        autoSaveModal();
                    });

                    // å ´æ‰€ã®å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
                    document.getElementById('floorSelect').addEventListener('change', function() {
                        autoSaveModal();
                    });

                    // ãƒ‘ãƒ¬ãƒƒãƒˆç•ªå·ã®å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
                    document.getElementById('palletNumberSelect').addEventListener('change', function() {
                        autoSaveModal();
                    });

                    // å‚™è€ƒã®å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜ï¼ˆdebounceï¼‰
                    document.getElementById('remarksInput').addEventListener('input', function() {
                        clearTimeout(modalRemarksTimeout);
                        modalRemarksTimeout = setTimeout(function() {
                            autoSaveModal();
                        }, 1000);  // 1ç§’å¾Œã«ä¿å­˜
                    });
                }

                // ğŸ”¥ ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨è‡ªå‹•ä¿å­˜é–¢æ•°
                async function autoSaveModal() {
                    const status = document.getElementById('statusSelect').value;
                    const remarks = document.getElementById('remarksInput').value;
                    const floor = document.getElementById('floorSelect').value;
                    const palletNumber = document.getElementById('palletNumberSelect').value;

                    try {
                        const response = await fetch(`/api/order/${currentOrderId}/update`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                status: status,
                                remarks: remarks,
                                floor: floor,
                                pallet_number: palletNumber
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // ğŸ”¥ ç´å“å®Œäº†ã«ãªã£ãŸå ´åˆã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç¢ºèª
                            if (data.show_email_prompt) {
                                const orderInfo = data.order_info;

                                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
                                const confirmMessage = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œç´å“å®Œäº†ã€ã«æ›´æ–°ã—ã¾ã—ãŸã€‚\n\n` +
                                    `è£½ç•ª: ${orderInfo.seiban}\n` +
                                    `å“å: ${orderInfo.product_name}\n` +
                                    `å ´æ‰€: ${orderInfo.floor || 'æœªè¨­å®š'} ${orderInfo.pallet_number || ''}\n\n` +
                                    `ç´å“å®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`;

                                if (confirm(confirmMessage)) {
                                    // ãƒ¡ãƒ¼ãƒ«ä½œæˆAPIã‚’å‘¼ã³å‡ºã—
                                    const emailResponse = await fetch(`/api/order/${currentOrderId}/send-completion-email`, {
                                        method: 'POST'
                                    });

                                    const emailData = await emailResponse.json();

                                    if (emailData.success) {
                                        showToast('âœ‰ï¸ ãƒ¡ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'success');
                                    } else {
                                        showToast('âŒ ãƒ¡ãƒ¼ãƒ©ãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + emailData.error, 'error');
                                    }
                                }
                            }

                            // è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
                            const indicator = document.getElementById('autoSaveIndicator');
                            if (indicator) {
                                indicator.style.display = 'block';
                                setTimeout(function() {
                                    indicator.style.display = 'none';
                                }, 2000);
                            }

                            // å—æ³¨ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            loadOrders();
                        } else {
                            showToast('âŒ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showToast('âŒ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                    }
                }

                // è¦ªå­éšå±¤è¡¨ç¤ºé–¢æ•°
                function displayOrderDetails(details) {
                    let html = '';
                    const escapeHtml = (str) => (str || '').replace(/'/g, "\\'");
                    const parentItems = details.filter(d => !d.parent_id);

                    // ğŸ”¥ ä»•æ§˜1ã®CADãƒªãƒ³ã‚¯è¡¨ç¤ºã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
                    const getSpec1Html = (detail) => {
                        const spec1 = detail.spec1 || '-';
                        if (!detail.cad_info) {
                            return spec1;
                        }

                        let fileInfo = '';
                        let warningText = '';

                        if (detail.cad_info.has_pdf) {
                            fileInfo = `ğŸ“„ PDFæœ‰ (${detail.cad_info.pdf_count}ä»¶)`;
                        } else if (detail.cad_info.has_mx2) {
                            fileInfo = `ğŸ”§ mx2ã®ã¿ (${detail.cad_info.mx2_count}ä»¶)`;
                            warningText = '<div style="font-size: 0.75em; color: #856404;">âš ï¸ iCAD MXå°å…¥PCã®ã¿</div>';
                        }

                        return `
                            <a href="#" class="cad-link" data-detail-id="${detail.id}"
                               style="color: #007bff; text-decoration: underline; cursor: pointer;">
                                ${spec1}
                            </a>
                            <div style="font-size: 0.8em; color: ${detail.cad_info.has_pdf ? '#28a745' : '#856404'}; margin-top: 3px;">
                                ${fileInfo}
                                ${warningText}
                            </div>
                        `;
                    };

                    parentItems.forEach(parent => {
                        const parentDeliveryQty = parent.received_delivery_qty ? Math.floor(parent.received_delivery_qty) : '';
                        html += `
                            <tr class="${parent.is_received ? 'received' : ''}">
                                <td>
                                    ${parent.is_received ?
                                        `<span style="color: green;">âœ… å—å…¥æ¸ˆ</span>
                                        <button class="btn btn-sm btn-warning" onclick="toggleReceiveStatus(${parent.id}, false, '${escapeHtml(parent.order_number)}', '${escapeHtml(parent.spec1)}', '${escapeHtml(parent.item_name)}', '${parent.quantity || ''} ${parent.unit_measure || ''}')">å–æ¶ˆ</button>` :
                                        `<button class="btn btn-secondary" onclick="toggleReceiveStatus(${parent.id}, true, '${escapeHtml(parent.order_number)}', '${escapeHtml(parent.spec1)}', '${escapeHtml(parent.item_name)}', '${parent.quantity || ''} ${parent.unit_measure || ''}')">å—å…¥</button>`
                                    }
                                    ${parent.has_internal_processing ? '<span class="badge badge-warning">è¿½åŠ å·¥æœ‰</span>' : ''}
                                </td>
                                <td style="color: ${parent.received_delivery_date ? '#2196f3' : '#999'};">${parent.received_delivery_date || '-'}</td>
                                <td style="color: ${parentDeliveryQty ? '#2196f3' : '#999'};">${parentDeliveryQty || '-'}</td>
                                <td>${parent.delivery_date || '-'}</td>
                                <td style="color: ${parent.reply_delivery_date ? '#d32f2f' : '#ccc'}; font-weight: ${parent.reply_delivery_date ? 'bold' : 'normal'};">${parent.reply_delivery_date || '-'}</td>
                                <td>${parent.supplier || '-'}</td>
                                <td>${parent.order_number || '-'}</td>
                                <td>${parent.quantity || ''} ${parent.unit_measure || ''}</td>
                                <td>${parent.item_name || '-'}</td>
                                <td>${getSpec1Html(parent)}</td>
                                <td>${parent.spec2 || '-'}</td>
                                <td>${parent.order_type || '-'}</td>
                                <td>${parent.remarks || '-'}</td>
                            </tr>
                        `;

                        const children = details.filter(d => d.parent_id === parent.id);
                        children.forEach(child => {
                            const childDeliveryQty = child.received_delivery_qty ? Math.floor(child.received_delivery_qty) : '';
                            html += `
                                <tr class="${child.is_received ? 'received' : ''}" style="background: #f0f0f0;">
                                    <td>
                                        ${child.is_received ?
                                            `<span style="color: green;">âœ… å—å…¥æ¸ˆ</span>
                                            <button class="btn btn-sm btn-warning" onclick="toggleReceiveStatus(${child.id}, false, '${escapeHtml(child.order_number)}', '${escapeHtml(child.spec1)}', '${escapeHtml(child.item_name)}', '${child.quantity || ''} ${child.unit_measure || ''}')">å–æ¶ˆ</button>` :
                                            `<button class="btn btn-secondary" onclick="toggleReceiveStatus(${child.id}, true, '${escapeHtml(child.order_number)}', '${escapeHtml(child.spec1)}', '${escapeHtml(child.item_name)}', '${child.quantity || ''} ${child.unit_measure || ''}')">å—å…¥</button>`
                                        }
                                    </td>
                                    <td style="color: ${child.received_delivery_date ? '#2196f3' : '#999'};">${child.received_delivery_date || '-'}</td>
                                    <td style="color: ${childDeliveryQty ? '#2196f3' : '#999'};">${childDeliveryQty || '-'}</td>
                                    <td>${child.delivery_date || '-'}</td>
                                    <td style="color: ${child.reply_delivery_date ? '#d32f2f' : '#ccc'}; font-weight: ${child.reply_delivery_date ? 'bold' : 'normal'};">${child.reply_delivery_date || '-'}</td>
                                    <td>${child.supplier || '-'}</td>
                                    <td>${child.order_number || '-'}</td>
                                    <td>${child.quantity || ''} ${child.unit_measure || ''}</td>
                                    <td style="padding-left: 30px;">â””â”€ ${child.item_name || '-'}</td>
                                    <td>${getSpec1Html(child)}</td>
                                    <td>${child.spec2 || '-'}</td>
                                    <td>${child.order_type || '-'}</td>
                                    <td>${child.remarks || '-'}</td>
                                </tr>
                            `;
                        });
                    });

                    return html;
                }

                // ğŸ”¥ CADãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãé–¢æ•°
                async function openCadFile(detailId) {
                    try {
                        const response = await fetch('/api/open-cad/' + detailId);

                        // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§ç›´æ¥èµ·å‹•ã—ãŸå ´åˆï¼‰
                        if (response.headers.get('content-type')?.includes('application/json')) {
                            const data = await response.json();

                            if (data.success) {
                                if (data.opened_locally) {
                                    showToast('ğŸ”§ ' + data.message + ': ' + data.file_name, 'success');
                                } else {
                                    showToast('ğŸ“„ ' + data.message, 'success');
                                }
                            } else {
                                showToast('âŒ ' + data.error, 'error');
                            }
                        } else {
                            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰/è¡¨ç¤ºã®å ´åˆ
                            const contentType = response.headers.get('content-type');

                            if (contentType.includes('application/pdf')) {
                                // PDFã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                                const url = `/api/open-cad/${detailId}`;
                                window.open(url, '_blank');
                                showToast('ğŸ“„ PDFå›³é¢ã‚’é–‹ãã¾ã—ãŸ', 'success');
                            } else {
                                // MX2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = response.headers.get('content-disposition')?.split('filename=')[1] || 'file.mx2';
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                window.URL.revokeObjectURL(url);
                                showToast('ğŸ’¾ MX2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'info');
                            }
                        }
                    } catch (error) {
                        showToast('âŒ CADãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                        console.error('CADãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                // å—å…¥çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹é–¢æ•°
                async function toggleReceiveStatus(detailId, setReceived, orderNumber, spec1, itemName, quantity) {
                    const action = setReceived ? 'å—å…¥' : 'å—å…¥å–æ¶ˆ';
                    
                    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
                    const confirmMessage = `ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                                        `ç™ºæ³¨ç•ªå·: ${orderNumber || 'æœªè¨­å®š'}\n` +
                                        `å“å: ${itemName || 'æœªè¨­å®š'}\n` +
                                        `ä»•æ§˜ï¼‘: ${spec1 || 'æœªè¨­å®š'}\n` +
                                        `æ•°é‡: ${quantity || 'æœªè¨­å®š'}`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/detail/${detailId}/toggle-receive`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ is_received: setReceived })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                            const toastMessage = data.message + 
                                                `\nç™ºæ³¨ç•ªå·: ${orderNumber || 'æœªè¨­å®š'}` +
                                                `\nä»•æ§˜ï¼‘: ${spec1 || 'æœªè¨­å®š'}`;
                            showToast(toastMessage, data.has_internal_processing ? 'warning' : 'success', 5000);
                            
                            showOrderDetails(currentOrderId);
                            loadOrders();
                            
                            // å…¥è·ç®¡ç†ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯çµ±è¨ˆã‚‚æ›´æ–°
                            if (document.getElementById('receiving-tab').classList.contains('active')) {
                                loadPurchaseOrderStats();
                            }
                        } else {
                            showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showToast(`${action}ã‚¨ãƒ©ãƒ¼: ` + error, 'error');
                    }
                }

            async function updateOrder() {
                const status = document.getElementById('statusSelect').value;
                const remarks = document.getElementById('remarksInput').value;
                const floor = document.getElementById('floorSelect').value;
                const palletNumber = document.getElementById('palletNumberSelect').value;
                
                try {
                    const response = await fetch(`/api/order/${currentOrderId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: status,
                            remarks: remarks,
                            floor: floor,
                            pallet_number: palletNumber
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // ğŸ”¥ ç´å“å®Œäº†ã«ãªã£ãŸå ´åˆã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç¢ºèª
                        if (data.show_email_prompt) {
                            const orderInfo = data.order_info;
                            
                            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
                            const confirmMessage = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œç´å“å®Œäº†ã€ã«æ›´æ–°ã—ã¾ã—ãŸã€‚\n\n` +
                                `è£½ç•ª: ${orderInfo.seiban}\n` +
                                `å“å: ${orderInfo.product_name}\n` +
                                `å ´æ‰€: ${orderInfo.floor || 'æœªè¨­å®š'} ${orderInfo.pallet_number || ''}\n\n` +
                                `ç´å“å®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`;
                            
                            if (confirm(confirmMessage)) {
                                // ãƒ¡ãƒ¼ãƒ«ä½œæˆAPIã‚’å‘¼ã³å‡ºã—
                                const emailResponse = await fetch(`/api/order/${currentOrderId}/send-completion-email`, {
                                    method: 'POST'
                                });
                                
                                const emailData = await emailResponse.json();
                                
                                if (emailData.success) {
                                    showToast('âœ‰ï¸ ãƒ¡ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'success');
                                } else {
                                    showToast('âŒ ãƒ¡ãƒ¼ãƒ©ãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + emailData.error, 'error');
                                }
                            }
                        } else {
                            showToast(data.message, 'success');
                        }
                        
                        loadOrders();
                        closeModal();
                    } else {
                        showToast('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                    }
                } catch (error) {
                    showToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                }
            }

        async function receiveItem(detailId) {
            try {
                const response = await fetch(`/api/detail/${detailId}/receive`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    showOrderDetails(currentOrderId);
                    loadOrders();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å—å…¥ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

        async function exportOrder(orderId) {
            window.location.href = `/api/export/${orderId}`;
        }

        async function deleteOrder(orderId) {
            if (!confirm('ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/delete`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadOrders();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadOrderImage(orderId) {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];

            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`/api/order/${orderId}/upload-image`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                    // ç”»åƒã‚’å†èª­ã¿è¾¼ã¿
                    const img = document.getElementById('orderImage');
                    img.src = `/api/order/${orderId}/image?t=${Date.now()}`;
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error);
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
        }

        // ç”»åƒå‰Šé™¤
        async function deleteOrderImage(orderId) {
            if (!confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/order/${orderId}/delete-image`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    document.getElementById('orderImage').style.display = 'none';
                    document.getElementById('noImageText').style.display = 'block';
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

        // ç”»åƒã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§è¡¨ç¤º
        function openImageFullscreen(src) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                object-fit: contain;
            `;

            overlay.appendChild(img);
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }

        function updateReceivingList(orders) {
            const receivingList = document.getElementById('receivingList');
            let html = '<h3>æœªå—å…¥ãƒªã‚¹ãƒˆ</h3>';

            // é…åˆ—ã§ãªã„å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
            if (!Array.isArray(orders)) {
                console.error('Invalid orders for receiving list:', orders);
                receivingList.innerHTML = html;
                return;
            }

            orders.forEach(order => {
                if (order.status !== 'ç´å“å®Œäº†') {
                    html += `
                        <div class="order-card" onclick="showOrderDetails(${order.id})">
                            <p><strong>${order.seiban} - ${order.unit}</strong></p>
                            <p>é€²æ—: ${order.received_count}/${order.detail_count}</p>
                            ${order.has_internal_processing ? '<span class="internal-processing-warning">âš ï¸ è¿½åŠ å·¥æœ‰</span>' : ''}
                        </div>
                    `;
                }
            });
            
            receivingList.innerHTML = html;
        }

        async function processReceiving() {
            const qrInput = document.getElementById('qrInput').value;
            
            if (!qrInput) {
                alert('QRã‚³ãƒ¼ãƒ‰ã¾ãŸã¯æ³¨æ–‡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // Extract order ID from QR code or direct input
            let orderId = qrInput;
            if (qrInput.startsWith('ORDER:')) {
                orderId = qrInput.replace('ORDER:', '');
            }
            
            showOrderDetails(parseInt(orderId));
            document.getElementById('qrInput').value = '';
        }

        async function importHistory(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import-history', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadHistoryData();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

    function runBatchFile() {
        const batPath = "C:\\Users\\t.maruyama\\refresh_order.bat";
        const infoDiv = document.getElementById("networkFileInfo");
        infoDiv.textContent = "ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œä¸­ ...";
        fetch('/execute-batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: batPath })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                infoDiv.innerHTML = `<span style="color:green">ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡ŒæˆåŠŸï¼</span><br>å‡ºåŠ›:<br><pre>${data.output}</pre>`;
            } else {
                infoDiv.innerHTML = `<span style="color:red">å¤±æ•—: ${data.error}</span>`;
            }
        })
        .catch(error => {
            console.error(error);
            infoDiv.innerHTML = "<span style='color:red'>é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸ</span>";
        });
    }
        async function loadHistoryData() {
            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="loading"><div class="spinner"></div><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>';
            
            try {
                const response = await fetch('/api/load-history');
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <h3>ç™ºè¡Œå±¥æ­´ (${data.total}ä»¶)</h3>
                        <div style="max-height: 600px; overflow-y: auto;">
                            <table class="detail-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>ç™ºè¡Œæ—¥</th>
                                        <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                        <th>è£½ç•ª</th>
                                        <th>å®¹é‡(KB)</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.no}</td>
                                <td>${item.issue_date}</td>
                                <td>${item.filename}</td>
                                <td><strong>${item.seiban}</strong></td>
                                <td>${item.size_kb}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    historyList.innerHTML = html;
                } else {
                    historyList.innerHTML = `
                        <div class="alert alert-warning">
                            ã‚¨ãƒ©ãƒ¼: ${data.error}<br>
                            å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                        </div>
                    `;
                }
            } catch (error) {
                historyList.innerHTML = `
                    <div class="alert alert-danger">
                        èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error}<br>
                        ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚
                    </div>
                `;
            }
        }
    </script>
</body>
</html>